<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR Kids - Order Management System</title>
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet"/>


    <style>
        /* --- TR KIDS GENERAL STYLES --- */
        :root{--sidebar-width:240px;--sidebar-width-collapsed:65px;--top-bar-height:60px;--primary-color:#0071e3;--sidebar-bg:#1d2b3a;--sidebar-link-color:#c5d6de;--sidebar-link-hover-bg:#2a3f54;--sidebar-link-active-bg:#0071e3;--top-bar-bg:#4F634A}*{box-sizing:border-box}
        body{font-family:'Sarabun', -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background-color:#f4f7f9}.app-container{display:flex;height:100vh}.sidebar{width:var(--sidebar-width);height:100%;position:fixed;z-index:1001;top:0;left:0;background-color:var(--sidebar-bg);transition:width .3s ease, transform .3s ease;color:#fff;padding-top:20px;flex-shrink:0}.page-wrapper{display:flex;flex-direction:column;width:100%;margin-left:var(--sidebar-width);transition:margin-left .3s ease}.top-bar{height:var(--top-bar-height);background-color:var(--top-bar-bg);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-shrink:0;box-shadow:0 2px 5px rgba(0,0,0,.1)}.main-content{flex-grow:1;overflow-y:auto;padding:0;height:calc(100vh - var(--top-bar-height))}.system-content{display:none}.system-content.active{display:block}.sidebar .sidebar-header{padding:0 20px 20px;text-align:center;border-bottom:1px solid #3a4b5f;white-space:nowrap}.sidebar .sidebar-header h2{margin:0;font-size:1.6em;font-weight:600}.sidebar .sidebar-header .toggle-btn{display: none;}.sidebar nav ul{list-style-type:none;padding:20px 0;margin:0}.sidebar nav li a{display:flex;align-items:center;padding:15px 20px;text-decoration:none;font-size:16px;color:var(--sidebar-link-color);white-space:nowrap;transition:background-color .2s ease-in-out}.sidebar nav li a .icon{margin-right:15px;font-size:1.5em;width:30px;text-align:center}.sidebar nav li a:hover{background-color:var(--sidebar-link-hover-bg)}.sidebar nav li a.active{background-color:var(--sidebar-link-active-bg);color:#fff;font-weight:700}body.sidebar-collapsed .sidebar{width:var(--sidebar-width-collapsed)}body.sidebar-collapsed .page-wrapper{margin-left:var(--sidebar-width-collapsed)}body.sidebar-collapsed .sidebar .sidebar-header h2,body.sidebar-collapsed .sidebar .nav-text{opacity:0;visibility:hidden}body.sidebar-collapsed .sidebar .nav-link .icon{margin-right:0}body.sidebar-collapsed .sidebar .toggle-btn{transform:rotate(180deg)}#user-info-bar{display:flex;align-items:center;gap:15px;font-size:14px}#logout-btn{background-color:#6c757d;color:#fff;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-size:14px}.full-page-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#f4f7f9;z-index:2000;display:flex;justify-content:center;align-items:center}#main-app-container{display:none}
        .container{max-width:1800px;margin:20px auto;background:#fff;padding:25px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
        .btn{padding:12px 20px;border:none;border-radius:4px;font-size:16px;cursor:pointer}
        .btn.btn-sm{padding:5px 10px;font-size:12px}
        .btn-primary{background-color:#0071e3;color:#fff}.btn-secondary{background-color:#6c757d;color:#fff}.btn-success{background-color:#28a745;color:#fff}.btn-warning{background-color:#ffc107;color:#000}.btn-danger{background-color:#dc3545;color:#fff}.btn-info{background-color:#17a2b8;color:#fff}
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);color:#fff;display:none;justify-content:center;align-items:center;z-index:1500;font-size:2em}
        
        /* --- ORDER SYSTEM SPECIFIC STYLES --- */
        #order-system-container .batch-actions{margin-bottom:20px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
        #order-system-container .tab-filter { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #order-system-container .tab-filter select { width: 200px; }
        #order-system-container .tab-filter input[type="text"] { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 250px; margin-left: auto; }
        @media (max-width: 576px) { #order-system-container .tab-filter { flex-direction: column; align-items: stretch; } #order-system-container .tab-filter input[type="text"], #order-system-container .tab-filter select { margin-left: 0; width: 100%; } }
        #order-system-container .order-list { display: flex; flex-direction: column; gap: 0; max-height: 70vh; overflow-y: auto; list-style: none; padding: 0; margin: 0; border: 1px solid #e0e0e0; border-radius: 8px; }
        #order-system-container .order-list-item { display: grid; grid-template-columns: 40px 1fr 280px; align-items: center; gap: 20px; padding: 12px 15px; background: #fff; border: none; border-bottom: 1px solid #e0e0e0; box-shadow: none; border-radius: 0; transition: background-color 0.2s; }
        #order-system-container .order-list-item:last-child { border-bottom: none; }
        #order-system-container .order-list-item:hover { background-color: #f8f9fa; }
        #order-system-container .order-info { display: flex; align-items: center; gap: 15px; min-width: 0; }
        #order-system-container .order-list-item > * { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #order-system-container .order-list-item strong { font-size: 1.1em; color: #0071e3; cursor: pointer; flex-shrink: 0; }
        #order-system-container .order-list-item strong:hover { text-decoration: underline; }
        #order-system-container .order-list-item .customer-info { font-size: 1.0em; color: #555; min-width: 50px; }
        #order-system-container .order-list-item .order-tracking { font-size: 0.9em; color: #28a745; font-weight: 700; text-align: right; }
        #order-system-container .order-checkbox { justify-self: center; }
        #order-system-container .work-order-group{border:1px solid #ccc;border-radius:4px;margin-bottom:15px; background: #f8f9fa;}
        #order-system-container .work-order-header{background-color:#e9ecef;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;font-weight:700;cursor:pointer}
        #order-system-container .work-order-header:hover{background-color:#dee2e6}
        #order-system-container .wo-name{flex-grow:1}
        #order-system-container .wo-header-actions{display:flex;align-items:center;gap:10px;flex-wrap: wrap;}
        #order-system-container .work-order-bills{background-color:#f0f2f5;padding:0; max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out;border-top:1px solid transparent}
        #order-system-container .work-order-bills.show{max-height:1500px;padding:15px;transition:max-height .5s ease-in,padding .5s ease-in;border-top:1px solid #ddd}
        #order-system-container .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        #order-system-container .form-grid.form-grid-main { display: grid; grid-template-columns: 1fr 1fr 2.5fr; gap: 20px; }
        #order-system-container .form-group.full-width { grid-column: 1 / -1; }
        #order-system-container label{margin-bottom:5px;font-weight:600}#order-system-container input,#order-system-container select,#order-system-container textarea{width: 100%; padding:10px;border:1px solid #ccc;border-radius:4px;font-size:16px;box-sizing:border-box}#order-system-container hr{border:0;height:1px;background:#e0e0e0;margin:25px 0}#order-system-container .tabs{border-bottom:2px solid #dee2e6;display:flex;flex-wrap:wrap;margin-bottom:20px}#order-system-container .tab-link{padding:10px 15px;cursor:pointer;background:0 0;border:none;font-size:16px;border-bottom:3px solid transparent}#order-system-container .tab-link.active{border-bottom-color:#0071e3;font-weight:600;color:#0071e3}#order-system-container .tab-content{display:none}#order-system-container .tab-content.active{display:block}
        #order-system-container .items-table-container{overflow-x:auto}#order-system-container #items-table{width:100%;border-collapse:collapse;margin-bottom:10px;table-layout:fixed;}#order-system-container #items-table th,#order-system-container #items-table td{border:1px solid #ddd;padding:2px;text-align:left;vertical-align:top;word-wrap:break-word;}#order-system-container #items-table th{background-color:#f8f9fa;font-size:14px;padding:8px;white-space:nowrap}
        #items-table th:nth-child(1) { width: 250px; } #items-table th:nth-child(2) { width: 120px; } #items-table th:nth-child(3) { width: 80px; } #items-table th:nth-child(4) { width: 120px; } #items-table th:nth-child(5) { width: 100px; } #items-table th:nth-child(6) { width: 120px; } #items-table th:nth-child(7) { width: 150px; } #items-table th:nth-child(8) { width: 150px; } #items-table th:nth-child(9) { width: 150px; } #items-table th:nth-child(10) { width: 70px; } #items-table th:nth-child(11) { width: 180px; } #items-table th:nth-child(12) { width: 120px; } #items-table th:nth-child(13) { width: 50px; }
        #order-system-container #items-table input,#order-system-container #items-table select{width:100%;font-size:14px;padding:6px;border:none;background:0 0;box-sizing:border-box}#order-system-container #items-table input:focus,#order-system-container #items-table select:focus{outline:2px solid #0071e3;background:#fff}
        #order-system-container #items-table .select2-container{width:100%!important}
        #order-system-container #items-table .select2-selection--single{height:32px!important;border:none!important; display: flex; align-items: center;}
        #order-system-container #items-table .select2-selection__rendered{padding-left: 0 !important; line-height: normal !important;}
        #order-system-container #items-table .select2-selection__arrow{height:30px!important}
        #order-system-container .form-grid .select2-container .select2-selection--single { height: 42px !important; display: flex; align-items: center; }
        #order-system-container .form-grid .select2-container .select2-selection__rendered { padding-top: 0 !important; padding-bottom: 0 !important; }
        #order-system-container .form-grid .select2-container .select2-selection__arrow { height: 40px !important; }
        #order-system-container #items-table .quantity-input{width:70px;text-align:center}#order-system-container #items-table .action-cell{width:50px;text-align:center}#order-system-container #items-table .remove-item-btn{font-size:12px;padding:4px 8px}
        #order-system-container .btn-edit-tracking { background: transparent; border: none; cursor: pointer; padding: 0 5px; font-size: 14px; }
        #order-system-container .tracking-edit-container { display: flex; gap: 5px; align-items: center; }
        #order-system-container .tracking-input { padding: 4px; border-radius: 4px; border: 1px solid #ccc; flex-grow: 1; min-width: 100px; }
        .channel-summary { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 12px 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; min-height: 50px; align-items: center; }
        .channel-summary-item { background-color: #0071e3; color: white; padding: 6px 14px; border-radius: 16px; font-size: 14px; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .channel-summary-placeholder { color: #6c757d; font-style: italic; }

        /* --- PACKING SYSTEM SPECIFIC STYLES --- */
        #packing-system-container{padding:0}#packing-system-container .header{text-align:center;padding:15px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;gap:20px;flex-wrap:wrap;margin-bottom:0}#packing-system-container .header h1{margin:0;font-size:24px;color:var(--primary-color)}#packing-system-container .header .action-buttons{display:flex;gap:10px}#packing-system-container .btn-back{background-color:#6c757d;color:#fff}#work-order-selection-view{padding:40px;text-align:center}#work-order-selection-view h2{margin-top:0}#work-order-list{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;list-style:none;padding:0}.work-order-item button{padding:20px 30px;font-size:1.1em;cursor:pointer;border:1px solid #0071e3;background-color:#f0f8ff;border-radius:8px;transition:all .2s}.work-order-item button:hover{background-color:#e0effc;box-shadow:0 2px 5px rgba(0,0,0,.1)}#packing-main-view{display:none}#packing-main-view .main-container{display:flex;height:calc(100vh - var(--top-bar-height) - 100px)}#packing-main-view #order-nav-panel{width:300px;background:#fff;border-right:1px solid #d2d2d7;display:flex;flex-direction:column;flex-shrink:0}#packing-main-view #nav-header{padding:15px;border-bottom:1px solid #d2d2d7;text-align:center}#packing-main-view #order-counter{font-size:16px;font-weight:600}#packing-main-view #search-input{width:calc(100% - 24px);padding:8px 12px;margin-top:10px;border:1px solid #d2d2d7;border-radius:6px}#packing-main-view #order-list{list-style:none;padding:0;margin:0;overflow-y:auto;flex-grow:1}#packing-main-view .order-item{padding:12px 15px;border-bottom:1px solid #e5e5e5;cursor:pointer;-webkit-user-select:none;user-select:none}#packing-main-view .order-item.active{background-color:#e0effc}#packing-main-view .order-item.completed{color:#28a745}#packing-main-view .order-item .tracking-id{font-weight:700;display:block}#packing-main-view .order-item .customer-name{font-size:.9em;color:#6e6e73}#packing-main-view #content-panel{flex-grow:1;display:flex;flex-direction:column;overflow:hidden;background:#fff}#packing-main-view #action-panel{padding:20px;flex-shrink:0;background-color:#f8f8fa;border-bottom:1px solid #d2d2d7}#packing-main-view .action-step{margin-bottom:15px}#packing-main-view .action-step:last-child{margin-bottom:0}#packing-main-view .action-step h3{margin:0 0 10px;font-size:18px;text-align:center}#packing-main-view .action-step input{font-size:16px;padding:10px;text-align:center;border:2px solid;border-radius:8px;max-width:400px;width:100%;display:block;margin:0 auto}#packing-main-view #item-scan-input{border-color:#0071e3}#packing-main-view #confirmation-input{border-color:#28a745}#packing-main-view input:disabled{background-color:#e9ecef;border-color:#ced4da;cursor:not-allowed}#packing-main-view #status-message{margin-top:15px;font-size:20px;font-weight:700;height:28px;text-align:center}#packing-main-view .status-success{color:#28a745}#packing-main-view .status-error{color:#dc3545}#packing-main-view #result-container{padding:25px;overflow-y:auto;flex-grow:1}#packing-main-view table{width:100%;border-collapse:collapse;margin-top:15px}#packing-main-view th,#packing-main-view td{padding:12px;border:1px solid #d2d2d7;text-align:left;transition:background-color .3s;white-space:nowrap}#packing-main-view thead{background-color:#f0f0f0}#packing-main-view tr.item-scanned{background-color:#e2f0e3}#packing-main-view tr.item-scanned td:first-child::before{content:"✅ "}

        /* --- PRODUCT SYSTEM SPECIFIC STYLES --- */
        #product-system-container .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        #product-system-container .table-container { overflow-x: auto; }
        #product-system-container table { width: 100%; border-collapse: collapse; }
        #product-system-container th, #product-system-container td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        #product-system-container th { background-color: #f8f9fa; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1600; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content h2 { margin-top: 0; }
        .modal-form-group { margin-bottom: 15px; }
        .modal-form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .modal-form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .modal-actions { text-align: right; margin-top: 20px; flex-shrink: 0; }
        
        /* --- PICKING SLIP MODAL SPECIFIC STYLES --- */
        #picking-slip-preview { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; }
        #picking-slip-preview h3 { margin-top: 0; }
        #picking-slip-preview table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; }
        #picking-slip-preview th, #picking-slip-preview td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #picking-slip-preview th { background-color: #f2f2f2; }
        #picking-slip-png-container { position: absolute; left: -9999px; top: 0; width: 800px; height: 1135px; padding: 30px; background: white; font-family: 'Tahoma', sans-serif; color: black; display: flex; flex-direction: column; }
        #picking-slip-png-container .png-body { flex-grow: 1; }
        #picking-slip-png-container table { width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 14px; }
        #picking-slip-png-container th, #picking-slip-png-container td { border: 1px solid black; padding: 8px; text-align: left; word-wrap: break-word; }
        #planner-system-container th { background-color: black; color: white; font-weight: bold; text-align: center; }
        #picking-slip-png-container .png-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; }
        #picking-slip-png-container .png-header-box { border: 1px solid black; padding: 10px; text-align: center; flex-grow: 1; }
        #picking-slip-png-container .png-signature-boxes { display: flex; justify-content: space-around; margin-top: auto; padding-top: 25px; gap: 20px; }
        #picking-slip-png-container .png-signature-box { border: 1px solid black; width: 220px; padding: 8px; }
        #picking-slip-png-container .png-signature-box .title { font-weight: bold; text-align: center; margin-bottom: 5px; }
        #picking-slip-png-container .png-signature-box .space { height: 60px; border-bottom: 1px dotted black; margin-bottom: 5px; text-align: center; padding-top: 5px; }
        #picking-slip-png-container .png-footer { text-align: right; padding-top: 15px; font-size: 12px; color: #555; }
        
        /* --- RESPONSIVE DESIGN --- */
        #mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        @media (max-width: 992px) { body.sidebar-collapsed .page-wrapper { margin-left: var(--sidebar-width-collapsed); } }
        @media (max-width: 768px) {
            #mobile-menu-toggle { display: block; }
            .sidebar { transform: translateX(-100%); z-index: 1100; }
            body:not(.sidebar-collapsed) .sidebar { transform: translateX(0); }
            .page-wrapper, body.sidebar-collapsed .page-wrapper { margin-left: 0; }
            .sidebar .sidebar-header .toggle-btn { display: none; }
            .container { padding: 15px; }
            #order-system-container .form-grid.form-grid-main { grid-template-columns: 1fr; }
            #order-system-container .batch-actions { flex-direction: column; align-items: stretch; }
            #order-system-container .batch-actions .btn { width: 100%; margin-bottom: 5px; }
            #packing-main-view .main-container { flex-direction: column; height: auto; }
            #packing-main-view #order-nav-panel { width: 100%; border-right: none; border-bottom: 1px solid #d2d2d7; height: 40vh; }
            #packing-main-view #content-panel { height: 60vh; }
            .top-bar { padding: 0 15px; }
            #user-info-bar #welcome-message { display: none; }
        }

        /* --- PRODUCTION PLANNER STYLES (SCOPED) --- */
        #planner-system-container{ --primary:#2563eb; --muted:#6b7280; --bg:#f7fafc; --card:#fff; --border:#e5e7eb; --ink:#111827 }
        #planner-system-container .main-content { padding: 0 !important; }
        #planner-system-container header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--border)}
        #planner-system-container header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;max-width:100%;margin:0 auto}
        #planner-system-container h1{font-size:20px;margin:0}
        #planner-system-container .wrap{max-width:100%;margin:0 auto;padding:16px 24px 80px;}
        #planner-system-container .wrap-dashboard { max-width: 100%; padding: 16px 24px 80px; }
        #planner-system-container .grid{display:grid;gap:12px}
        #planner-system-container .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
        #planner-system-container .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
        #planner-system-container .grid-2-1{grid-template-columns:2fr 1fr}
        @media (max-width:980px){ #planner-system-container .g-2, #planner-system-container .g-3, #planner-system-container .grid-2-1{grid-template-columns:1fr} }
        #planner-system-container .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
        #planner-system-container .card h2, #planner-system-container .card h3{margin:0 0 8px;padding:12px 14px;border-bottom:1px solid var(--border);font-size:18px}
        #planner-system-container .card .inner{padding:12px 14px}
        #planner-system-container label{font-size:13px;color:var(--muted);display:block;margin-bottom:2px;}
        #planner-system-container input, #planner-system-container select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
        #planner-system-container .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
        #planner-system-container .row+.row{margin-top:8px}
        #planner-system-container .btn{appearance:none;border:1px solid var(--primary);background:var(--primary);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
        #planner-system-container .btn.secondary{background:#fff;color:var(--primary)}
        #planner-system-container .btn.gray{background:#f3f4f6;color:#111;border-color:#e5e7eb}
        #planner-system-container .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
        #planner-system-container .btn:disabled{opacity:.6;cursor:not-allowed}
        #planner-system-container .btn.active{outline:2px solid var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
        #planner-system-container .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#fff}
        #planner-system-container .list{display:flex;flex-direction:column;gap:10px;min-height:60px;}
        #planner-system-container .job{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px; transition: background-color 0.3s, border-color 0.3s;}
        #planner-system-container .job.dragging{opacity:0.5;border-style:dashed;}
        #planner-system-container .jobhead{display:flex;gap:10px;align-items:center;padding-bottom:8px;border-bottom:1px solid var(--border);}
        #planner-system-container .drag{cursor:grab;user-select:none;font-size:18px;line-height:1;padding:2px 8px}
        #planner-system-container .job .title{font-weight:700}
        #planner-system-container .job small{color:var(--muted)}
        #planner-system-container .procwrap{padding:10px 0 0}
        #planner-system-container .proc{border:1px dashed var(--border);border-radius:12px;padding:8px;background:#fdfdfd}
        #planner-system-container .proc+.proc{margin-top:6px;}
        #planner-system-container .proc h4{margin:0 0 4px;font-size:14px}
        #planner-system-container .proc .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
        #planner-system-container .proc .timebox{display:grid;grid-template-columns:auto 1fr;gap:6px;align-items:center}
        #planner-system-container .proc .act{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
        #planner-system-container .proc .act .btn{padding:6px 10px;border-radius:10px;font-size:12px}
        #planner-system-container .rowcols{display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:8px}
        #planner-system-container .rowcols>div{display:flex;flex-direction:column;gap:6px}
        #planner-system-container table{width:100%;border-collapse:separate;border-spacing:0}
        #planner-system-container th, #planner-system-container td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;vertical-align: top;}
        #planner-system-container th{font-size:12px;color:#374151;background:#f9fafb;position:sticky;top:0; white-space: nowrap;}
        #planner-system-container .dept-divider { border-left: 2px solid #dde4ed; }
        #planner-system-container .cut-time-divider { border-left: 2px solid #dde4ed; }
        #planner-system-container tr:hover td{background:#fafafa}
        #planner-system-container tr.dragging td { background: #ebf8ff; border-top: 2px solid var(--primary); border-bottom: 2px solid var(--primary); }
        #planner-system-container .drag-handle { cursor: grab; padding-right: 10px; font-size: 16px; color: #9ca3af; }
        #planner-system-container .footerbar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);padding:8px 12px;display:flex;gap:8px;justify-content:center; z-index: 10;}
        #planner-system-container .hidden{display:none}
        #planner-system-container .help{font-size:12px;color:var(--muted)}
        #planner-system-container .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border); font-size:12px; background:#f9fafb;}
        #planner-system-container .right{margin-left:auto}
        #planner-system-container .inline{display:inline-flex;gap:6px;align-items:center}
        #planner-system-container .mini{padding:4px 8px;font-size:12px;border-radius:8px}
        #planner-system-container .toolbar{display:flex;gap:8px;align-items:end;flex-wrap:wrap;margin-bottom:12px}
        #planner-system-container input::placeholder{ color:#9ca3af }
        #planner-system-container .toggle{margin-left:auto}
        #planner-system-container .dept-board{ display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); }
        #planner-system-container .line-container{ padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: #f9fafb; }
        #planner-system-container .line-container h3{ margin: 0 0 10px; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        #planner-system-container .line-assign-select { font-size: 12px; padding: 4px 6px; border-radius: 8px; min-width: 85px; }
        #planner-system-container .qty-pills-container { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
        #planner-system-container .status-cell { display: flex; flex-direction: column; align-items: start; gap: 4px; }
        #planner-system-container .nav-group { display: inline-flex; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        #planner-system-container .nav-group .btn { flex: 1; text-align: center; background: #fff; color: var(--ink); border: none; border-radius: 0; border-left: 1px solid var(--border); font-weight: 600; padding: 8px 16px; }
        #planner-system-container .nav-group .btn:first-child { border-left: none; }
        #planner-system-container .nav-group .btn.active, #planner-system-container .nav-group .btn:hover { background: var(--primary); color: #fff; z-index: 1; }
        #planner-system-container .nav-group .btn.active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        #planner-system-container .status-badge { display: inline-block; padding: 3px 10px; border-radius: 999px; font-weight: 600; font-size: 12px; border: 1px solid transparent; background-color: #f3f4f6; color: #374151; border-color: #e5e7eb; }
        #planner-system-container .status-badge.status-progress { background-color: #e0f2fe; color: #0c4a6e; border-color: #bae6fd; }
        #planner-system-container .status-badge.status-done { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        #planner-system-container tr.status-row-progress td { background-color: #f0f9ff !important; }
        #planner-system-container tr.status-row-done td { background-color: #f0fdf4 !important; }
        #planner-system-container .job.job-card-progress { background-color: #f0f9ff; border-color: #bae6fd; }
        #planner-system-container .job.job-card-done { background-color: #f0fdf4; border-color: #bbf7d0; }
        #planner-system-container .checkbox-cell { width: 40px; text-align: center; }
        #planner-system-container tr.row-selected td { background-color: #fffbeb !important; }
        #planner-system-container .plan-time-hint { color: #9ca3af; font-weight: normal; font-size: 11px; }
        
        /* --- NEW STYLES for Job Editor Modal --- */
        #job-editor-title {
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 22px;
            color: var(--ink, #111827);
        }
        .planner-form-grid {
            display: grid;
            margin-bottom: 20px;
        }
        .planner-section-title {
            font-size: 18px;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border, #e5e7eb);
            color: #333;
        }
        .planner-form-group label, .planner-qty-group label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            color: #555;
        }
        #job-editor-modal-container input[type="date"],
        #job-editor-modal-container input[type="time"],
        #job-editor-modal-container input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #job-editor-modal-container input:focus {
            outline: none;
            border-color: var(--primary, #2563eb);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }
        .planner-qty-group {
            display: grid;
            grid-template-columns: 80px 1fr;
            align-items: center;
            gap: 10px;
        }
        .planner-qty-group label {
            margin-bottom: 0;
            font-weight: normal;
            text-align: right;
            color: var(--muted, #6b7280);
        }
        #job-editor-modal-container .modal-actions {
            margin-top: 30px;
        }

    </style>
</head>
<body class="sidebar-collapsed">

    <div id="loading-overlay">กำลังโหลด...</div>

    <div id="login-overlay" class="full-page-overlay">
        <div id="login-container" style="background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px;">
            <h1>ระบบจัดการออร์เดอร์</h1>
            <form id="login-form">
                <div style="margin-bottom: 20px; text-align: left;"><label for="email" style="display: block; margin-bottom: 5px; font-weight: 600;">อีเมล</label><input type="email" id="email" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;"></div>
                <div style="margin-bottom: 20px; text-align: left;"><label for="password" style="display: block; margin-bottom: 5px; font-weight: 600;">รหัสผ่าน</label><input type="password" id="password" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;"></div>
                <button type="submit" style="width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; background-color: #0071e3; color: white;">เข้าสู่ระบบ</button>
                <p id="error-message" style="color: #dc3545; margin-top: 15px; height: 20px;"></p>
            </form>
        </div>
    </div>
    
    <div id="main-app-container" class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>TR Kids</h2>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-target="order-system-container"><span class="icon">📝</span><span class="nav-text">ระบบจัดการออร์เดอร์</span></a></li>
                    <li id="nav-planner"><a href="#" class="nav-link" data-target="planner-system-container"><span class="icon">🗓️</span><span class="nav-text">ใบงาน (Export)</span></a></li>
                    <li><a href="#" class="nav-link" data-target="packing-system-container"><span class="icon">📦</span><span class="nav-text">ระบบจัดของ</span></a></li>
                    <li id="nav-product"><a href="#" class="nav-link" data-target="product-system-container"><span class="icon">🏷️</span><span class="nav-text">ระบบจัดการสินค้า</span></a></li>
                    <li id="nav-accounting"><a href="accounting.html" class="nav-link"><span class="icon">📊</span><span class="nav-text">ระบบบัญชี</span></a></li>
                </ul>
            </nav>
        </div>

        <div class="page-wrapper">
            <header class="top-bar">
                <button id="mobile-menu-toggle">☰</button>
                <div id="user-info-bar">
                    <span id="welcome-message"></span>
                    <button type="button" id="logout-btn">ออกจากระบบ</button>
                </div>
            </header>
            <main class="main-content">
                <!-- ==================== ORDER SYSTEM ==================== -->
                <div id="order-system-container" class="system-content active">
                    <div class="container">
                        <h1>ระบบจัดการออร์เดอร์</h1>
                        <input type="file" id="tracking-file-input" style="display: none;" accept=".csv, text/csv">
                        <input type="file" id="import-orders-file-input" style="display: none;" accept=".csv, .xlsx, .xls">
                        
                        <div class="tabs">
                            <button class="tab-link active" data-tab="tab-create">สร้าง / แก้ไข</button>
                            <button class="tab-link" data-tab="tab-waiting">รอลงข้อมูล</button>
                            <button class="tab-link" data-tab="tab-complete">ลงข้อมูลเสร็จสิ้น</button>
                            <button class="tab-link" data-tab="tab-work-orders">ใบงาน (กำลังผลิต)</button>
                            <button class="tab-link" data-tab="tab-shipped">จัดส่งแล้ว</button>
                            <button class="tab-link" data-tab="tab-cancelled">ยกเลิก</button>
                        </div>
                        <div id="tab-create" class="tab-content active">
                            <h2 id="form-title">สร้างออร์เดอร์ใหม่</h2>
                            <form id="order-form">
                                <h3>ข้อมูลหลัก</h3>
                                <div class="form-grid form-grid-main">
                                    <div class="form-group"><label for="channel_code">ช่องทาง</label><select id="channel_code" required><option value="">-- เลือกช่องทาง --</option></select></div>
                                    <div class="form-group"><label for="admin_user">แอดมิน</label><input type="text" id="admin_user" required readonly></div>
                                    <div class="form-group"><label for="customer_name">ชื่อลูกค้า</label><input type="text" id="customer_name" required></div>
                                    <div class="form-group full-width"><label for="customer_address">ที่อยู่ลูกค้า</label><textarea id="customer_address" rows="4" required></textarea></div>
                                </div>
                                <hr>
                                <h3>รายการสินค้า</h3>
                                <div class="batch-actions">
                                    <button type="button" id="download-template-btn" class="btn btn-info">📥 Download Template</button>
                                    <button type="button" id="import-orders-btn" class="btn btn-success">📤 Import Orders from File</button>
                                </div>
                                <div class="items-table-container"><table id="items-table"><thead><tr><th>ชื่อสินค้า</th><th>สีหมึก</th><th>ชั้นที่</th><th>ลายการ์ตูน</th><th>ลายเส้น</th><th>ฟอนต์</th><th>บรรทัด 1</th><th>บรรทัด 2</th><th>บรรทัด 3</th><th>จำนวน</th><th>หมายเหตุ</th><th>ไฟล์แนบ</th><th></th></tr></thead><tbody id="items-tbody"></tbody></table></div><button type="button" id="add-item-btn" class="btn btn-secondary">+ เพิ่มแถว</button><hr>
                                <h3>ข้อมูลการชำระเงิน</h3>
                                <div class="form-grid">
                                    <div class="form-group"><label for="price">ราคา</label><input type="number" id="price" value="0" step="0.01"></div>
                                    <div class="form-group"><label for="shipping_cost">ค่าส่ง</label><input type="number" id="shipping_cost" value="0" step="0.01"></div>
                                    <div class="form-group"><label for="discount">ส่วนลด</label><input type="number" id="discount" value="0" step="0.01"></div>
                                    <div class="form-group"><label for="total_amount">ยอดสุทธิ</label><input type="number" id="total_amount" readonly></div>
                                </div>
                                <div class="form-grid" style="margin-top: 20px;">
                                    <div class="form-group">
                                        <label for="payment_method">วิธีการชำระ</label>
                                        <select id="payment_method"><option value="โอน">โอน</option><option value="COD">COD</option></select>
                                    </div>
                                    <div class="form-group"><label for="promotion">ชื่อโปรโมชั่น</label><select id="promotion" style="width: 100%;"></select></div>
                                    <div class="form-group"><label for="payment_date">วันที่ชำระ</label><input type="date" id="payment_date"></div>
                                    <div class="form-group"><label for="payment_time">เวลาที่ชำระ</label><input type="time" id="payment_time"></div>
                                </div>
                                <div id="form-actions" style="margin-top: 25px; text-align: right;"></div>
                            </form>
                        </div>
                        <div id="tab-waiting" class="tab-content"><div class="tab-filter"><label for="filter-waiting">กรองตามช่องทาง:</label><select id="filter-waiting"></select><input type="text" id="search-waiting" placeholder="ค้นหาเลขบิล, ชื่อลูกค้า, พัสดุ..."></div><div class="batch-actions"><button id="select-all-waiting-btn" class="btn btn-secondary">เลือกทั้งหมด</button><button id="move-to-complete-from-waiting-btn" class="btn btn-success">ย้ายไป "ลงข้อมูลเสร็จสิ้น"</button><button id="cancel-selected-waiting-btn" class="btn btn-danger">ยกเลิกบิลที่เลือก</button></div><ul class="order-list"></ul></div>
                        <div id="tab-complete" class="tab-content">
                            <div class="tab-filter">
                                <label for="filter-complete">กรองตามช่องทาง:</label>
                                <select id="filter-complete"></select>
                                <input type="text" id="search-complete" placeholder="ค้นหาเลขบิล, ชื่อลูกค้า, พัสดุ...">
                            </div>
                            <div id="channel-summary-container" class="channel-summary"></div>
                            <div class="batch-actions">
                                <button id="select-all-complete-btn" class="btn btn-secondary">เลือกทั้งหมด</button>
                                <button id="create-work-order-btn" class="btn btn-success">สร้างใบงานจากที่เลือก</button>
                                <button id="move-to-waiting-btn" class="btn btn-warning">ย้ายไป "รอลงข้อมูล"</button>
                                <button id="cancel-selected-complete-btn" class="btn btn-danger">ยกเลิกบิลที่เลือก</button>
                            </div>
                            <ul class="order-list"></ul>
                        </div>
                        <div id="tab-work-orders" class="tab-content">
                            <div id="work-orders-list-container"></div>
                        </div>
                        <div id="tab-shipped" class="tab-content">
                            <div class="tab-filter"><label for="filter-shipped">กรองตามช่องทาง:</label><select id="filter-shipped"></select><input type="text" id="search-shipped" placeholder="ค้นหาเลขบิล, ชื่อลูกค้า, พัสดุ..."></div>
                            <div class="batch-actions"><button id="select-all-shipped-btn" class="btn btn-secondary">เลือกทั้งหมด</button></div>
                            <ul class="order-list"></ul>
                        </div>
                        <div id="tab-cancelled" class="tab-content"><div class="tab-filter"><label for="filter-cancelled">กรองตามช่องทาง:</label><select id="filter-cancelled"></select><input type="text" id="search-cancelled" placeholder="ค้นหาเลขบิล, ชื่อลูกค้า, พัสดุ..."></div><div class="batch-actions"><button id="select-all-cancelled-btn" class="btn btn-secondary">เลือกทั้งหมด</button><button id="restore-to-waiting-btn" class="btn btn-warning">คืนไป "รอลงข้อมูล"</button><button id="restore-to-complete-btn" class="btn btn-info">คืนไป "ลงข้อมูลเสร็จสิ้น"</button></div><ul class="order-list"></ul></div>
                    </div>
                </div>

                <!-- ==================== PACKING SYSTEM ==================== -->
                <div id="packing-system-container" class="system-content">
                    <div id="work-order-selection-view">
                        <div class="container">
                            <h2>เลือกใบงานที่ต้องการจัดของ</h2><p>ระบบจะดึงข้อมูลใบงานที่อยู่ในสถานะ "กำลังผลิต" มาแสดงที่นี่</p><ul id="work-order-list"></ul>
                        </div>
                    </div>
                    <div id="packing-main-view"><header class="header"><h1 id="packing-header-title">ระบบจัดของ</h1><div class="action-buttons"><button id="back-to-wo-selection" class="btn btn-back">❮ กลับไปเลือกใบงาน</button><button id="reset-packing-btn" class="btn btn-warning">แพ็คใหม่</button><button id="export-all-button" class="btn btn-success" disabled>📥 Export ข้อมูล</button></div></header><div class="main-container"><nav id="order-nav-panel"><div id="nav-header"><span id="order-counter">ยังไม่มีข้อมูล</span><input type="text" id="search-input" placeholder="ค้นหาเลขพัสดุ..."></div><ul id="order-list"></ul></nav><main id="content-panel"><div id="action-panel" style="display: none;"><div class="action-step"><h3>ขั้นตอนที่ 1: สแกนสินค้า</h3><input type="text" id="item-scan-input" placeholder="ยิงบาร์โค้ด Item UID"></div><div class="action-step"><h3>ขั้นตอนที่ 2: ยืนยันการจัดส่ง</h3><input type="text" id="confirmation-input" placeholder="ยิงบาร์โค้ดเลขพัสดุที่กล่อง" disabled></div><p id="status-message"></p></div><div id="result-container"></div></main></div></div>
                    <audio id="success-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio><audio id="error-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>
                </div>

                <!-- ==================== PRODUCT SYSTEM ==================== -->
                <div id="product-system-container" class="system-content">
                    <div class="container">
                        <h1>ระบบจัดการสินค้า (Products)</h1>
                        <input type="file" id="import-product-input" style="display: none;" accept=".xlsx, .xls, .csv">
                        <div class="toolbar">
                            <div>
                                <button id="add-product-btn" class="btn btn-success">+ เพิ่มสินค้าใหม่</button>
                                <button id="import-product-btn" class="btn btn-info">📥 Import สินค้า</button>
                                <button id="download-product-template-btn" class="btn btn-secondary">📋 Download Template</button>
                            </div>
                            <input type="text" id="search-product-input" placeholder="ค้นหารหัสสินค้า หรือ ชื่อสินค้า..." style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 300px;">
                        </div>
                        <div class="table-container">
                            <table id="products-table">
                                <thead>
                                    <tr>
                                        <th>รหัสสินค้า</th>
                                        <th>ชื่อสินค้า</th>
                                        <th>หมวดหมู่</th>
                                        <th>ประเภท</th>
                                        <th>รหัสยาง</th>
                                        <th>ที่จัดเก็บ</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="products-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ==================== PLANNER SYSTEM ==================== -->
                <div id="planner-system-container" class="system-content">
                    <header>
                        <div class="bar">
                          <div style="display:flex;align-items:center;gap:10px">
                            <h1>ใบงาน (Export)</h1>
                          </div>
                        </div>
                    </header>
                    <div class="wrap">
                        <section class="card hidden" id="viewForm"></section>
                        <section class="card" id="viewJobs">
                          <h2>ใบงานทั้งหมด (ค้นหา/แก้ไข/ลบ)</h2>
                          <div class="inner">
                            <div class="toolbar">
                              <div><label>เลือกวัน</label><select id="j_date"></select></div>
                              <div><label>ค้นหาชื่อ</label><input type="text" id="j_search" placeholder="พิมพ์บางส่วนของชื่อ" style="width:260px;"></div>
                              <button class="btn gray" id="j_clear">ล้างตัวกรอง</button>
                              <div class="right" style="display: flex; gap: 8px;">
                                <button class="btn btn-success" id="btnExportForSorting">Export for Sorting System (.xlsx)</button>
                                <button class="btn danger hidden" id="j_deleteSelected">ลบรายการที่เลือก (0)</button>
                              </div>
                            </div>
                            <div class="tablewrap" style="overflow-x:auto;max-height:520px;border:1px solid var(--border);border-radius:12px">
                              <table id="tableJobs"><thead><tr>
                                <th class="checkbox-cell"><input type="checkbox" id="j_selectAll"></th>
                                <th style="min-width:160px">ชื่อใบงาน</th>
                                <th>วันที่</th>
                                <th>เวลาตัด</th>
                                <th>จำนวนต่อแผนก</th>
                                <th style="min-width:160px">จัดการ</th>
                              </tr></thead><tbody></tbody></table>
                            </div>
                          </div>
                        </section>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Product Add/Edit Modal -->
    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="product-modal-title">เพิ่มสินค้าใหม่</h2>
            <form id="product-form">
                <input type="hidden" id="product-id-input">
                <div class="modal-form-group">
                    <label for="product-code-input">รหัสสินค้า (product_code)</label>
                    <input type="text" id="product-code-input" required>
                </div>
                <div class="modal-form-group">
                    <label for="product-name-input">ชื่อสินค้า (product_name)</label>
                    <input type="text" id="product-name-input" required>
                </div>
                <div class="modal-form-group">
                    <label for="product-category-input">หมวดหมู่ (product_category)</label>
                    <input type="text" id="product-category-input">
                </div>
                 <div class="modal-form-group">
                    <label for="product-type-input">ประเภท (product_type)</label>
                    <input type="text" id="product-type-input">
                </div>
                <div id="rubber-code-group" class="modal-form-group" style="display: none;">
                    <label for="product-rubber-code-input">รหัสยาง (rubber_code)</label>
                    <input type="text" id="product-rubber-code-input">
                </div>
                <div class="modal-form-group">
                    <label for="storage-location-input">ที่จัดเก็บ (storage_location)</label>
                    <input type="text" id="storage-location-input">
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-product-modal-btn" class="btn btn-secondary">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Picking Slip Modal -->
    <div id="picking-slip-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="picking-slip-modal-title">ใบเบิกสินค้า</h2>
            <div id="picking-slip-preview"></div>
            <div class="modal-actions">
                <button type="button" id="export-picking-slip-png-btn" class="btn btn-info">Export PNG</button>
                <button type="button" id="export-picking-slip-csv-btn" class="btn btn-success">Export CSV</button>
                <button type="button" id="cancel-picking-slip-modal-btn" class="btn btn-secondary">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Hidden Container for PNG Generation -->
    <div id="picking-slip-png-container"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & GLOBAL STATE ---
        const SUPABASE_URL = 'https://scxcuwjhjbkxvqmpywqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeGN1d2poamJreHZxbXB5d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODM4NTMsImV4cCI6MjA3NDg1OTg1M30.UqcmQUxCkOxgDxjtUa8Sbb0cLHT26qOuHfdbtdilkI8';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let loggedInUsername = null;
        let loggedInUserRole = null; // To store user role

        // --- CORE UI ELEMENTS ---
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const navLinks = document.querySelectorAll('.nav-link');
        const systemContents = document.querySelectorAll('.system-content');
        const loginOverlay = document.getElementById('login-overlay');
        const mainAppContainer = document.getElementById('main-app-container');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutBtn = document.getElementById('logout-btn');

        // --- CORE APP LOGIC ---
        mobileMenuToggle.addEventListener('click', () => document.body.classList.toggle('sidebar-collapsed'));

        navLinks.forEach(link => {
            if (link.getAttribute('href') === '#' || link.hasAttribute('data-target')) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    
                    const targetId = link.getAttribute('data-target');
                    systemContents.forEach(content => content.classList.toggle('active', content.id === targetId));
                    
                    // Initialize modules on tab switch if they haven't been
                    if (targetId === 'packing-system-container') {
                        window.packingSystem.loadWorkOrdersForPacking();
                    } else if (targetId === 'product-system-container' && loggedInUserRole === 'superadmin') {
                        window.productSystem.initializeApp();
                    } else if (targetId === 'planner-system-container' && (loggedInUserRole === 'superadmin' || loggedInUserRole === 'production')) {
                         window.plannerSystem.initializeApp(loggedInUserRole);
                    }

                    if (window.innerWidth <= 768) {
                        document.body.classList.add('sidebar-collapsed');
                    }
                });
            }
        });
        
        function handleInitialTab() {
            const target = localStorage.getItem('navigateTo');
            if (target) {
                const targetLink = document.querySelector(`.nav-link[data-target*="${target}"]`);
                if (targetLink) {
                    document.querySelector('.nav-link.active')?.classList.remove('active');
                    document.querySelector('.system-content.active')?.classList.remove('active');
                    
                    targetLink.classList.add('active');
                    const targetContent = document.getElementById(targetLink.dataset.target);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }

                    if (target === 'packing') {
                        window.packingSystem.loadWorkOrdersForPacking();
                    } else if (target === 'product' && loggedInUserRole === 'superadmin') {
                        window.productSystem.initializeApp();
                    } else if (target === 'planner' && (loggedInUserRole === 'superadmin' || loggedInUserRole === 'production')) {
                        window.plannerSystem.initializeApp(loggedInUserRole);
                    }
                }
            }
            localStorage.removeItem('navigateTo');
        }

        async function mainAppInitializer(user) {
            loadingOverlay.style.display = 'flex';
            try {
                const { data: userData, error } = await supabaseClient.from('users').select('username, role').eq('id', user.id).single();
                if (error || !userData) throw new Error('ไม่พบข้อมูลผู้ใช้ในระบบ หรือไม่มีคอลัมน์ role');
                
                loggedInUsername = userData.username;
                loggedInUserRole = userData.role; // Store the role
                welcomeMessage.textContent = `ยินดีต้อนรับ, ${loggedInUsername} (${loggedInUserRole})`;
                
                // --- ROLE-BASED UI CONTROL ---
                const isSuperAdmin = loggedInUserRole === 'superadmin';
                const isProduction = loggedInUserRole === 'production';

                document.getElementById('nav-product').style.display = isSuperAdmin ? '' : 'none';
                document.getElementById('nav-accounting').style.display = isSuperAdmin ? '' : 'none';
                document.getElementById('nav-planner').style.display = (isSuperAdmin || isProduction) ? '' : 'none';

                loginOverlay.style.display = 'none';
                mainAppContainer.style.display = 'flex';
                
                // Initialize core systems
                await window.orderSystem.initializeApp(loggedInUsername);

                // Initialize role-specific systems
                if (isSuperAdmin) {
                    window.productSystem.initializeApp();
                    window.plannerSystem.initializeApp(loggedInUserRole);
                } else if (isProduction) {
                    // If production user, switch to planner view immediately
                    document.querySelector('.nav-link.active')?.classList.remove('active');
                    document.querySelector('.system-content.active')?.classList.remove('active');
                    document.querySelector('.nav-link[data-target="planner-system-container"]').classList.add('active');
                    document.getElementById('planner-system-container').classList.add('active');
                    window.plannerSystem.initializeApp(loggedInUserRole);
                }
                
                handleInitialTab();

            } catch (err) {
                alert("เกิดข้อผิดพลาดในการเริ่มต้นระบบ: " + err.message); 
                await logout();
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); errorMessage.textContent = ''; loadingOverlay.style.display = 'flex';
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            loadingOverlay.style.display = 'none';
            if (error) { errorMessage.textContent = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง'; } 
            else if (data.user) { await mainAppInitializer(data.user); }
        });

        async function logout() {
            await supabaseClient.auth.signOut(); 
            loggedInUsername = null;
            loggedInUserRole = null;
            mainAppContainer.style.display = 'none';
            loginOverlay.style.display = 'flex';
            document.getElementById('email').value = ''; document.getElementById('password').value = ''; errorMessage.textContent = '';
        }
        logoutBtn.addEventListener('click', logout);

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) { await mainAppInitializer(session.user); } 
            else { 
                loginOverlay.style.display = 'flex'; 
                mainAppContainer.style.display = 'none'; 
            }
        }
        
        // --- ORDER SYSTEM MODULE ---
        window.orderSystem = (() => {
            const container = document.getElementById('order-system-container');
            const adminUserInput = container.querySelector('#admin_user');
            const itemsTbody = container.querySelector('#items-tbody');
            const formActions = container.querySelector('#form-actions');
            const orderForm = container.querySelector('#order-form');
            const tabLinks = container.querySelectorAll('.tab-link');
            const addItemBtn = container.querySelector('#add-item-btn');
            const trackingFileInput = document.getElementById('tracking-file-input');
            const workOrdersTab = container.querySelector('#tab-work-orders');
            const workOrdersListContainer = document.getElementById('work-orders-list-container');
            const downloadTemplateBtn = document.getElementById('download-template-btn');
            const importOrdersBtn = document.getElementById('import-orders-btn');
            const importOrdersFileInput = document.getElementById('import-orders-file-input');
            let productList = [], fullProductList = [], channelList = [], allOrdersData = [], allWorkOrdersData = [], inkTypeList = [], promotionList = [], currentEditingOrderId = null;

            const standardFonts = ['F01','F03','F04','F12','F14','TH01','TH02','TH03'];
            const wyFonts = ['fontA', 'fontB', 'fontC', 'fontD', 'fontE', 'fontF', 'fontG', 'fontH'];
            
            async function initializeApp(username) {
                adminUserInput.value = username;

                $('#promotion').select2({
                    tags: true,
                    placeholder: 'เลือกหรือพิมพ์โปรโมชันใหม่',
                    tokenSeparators: [',']
                });
                
                await loadInitialData();
                setFormMode('create');
                initializeEventListeners();
            }

            async function loadInitialData() {
                loadingOverlay.style.display = 'flex';
                try {
                    const [productsRes, ordersRes, channelsRes, workOrdersRes, inkTypesRes, promotionsRes] = await Promise.all([
                        supabaseClient.from('products').select('*'),
                        supabaseClient.from('orders').select('*, order_items(*)').order('created_at', { ascending: false }),
                        supabaseClient.from('channels').select('channel_code, channel_name'),
                        supabaseClient.from('work_orders').select('*').eq('status', 'กำลังผลิต').order('created_at', { ascending: false }),
                        supabaseClient.from('ink_types').select('ink_name').order('id'),
                        supabaseClient.from('orders').select('promotion').neq('promotion', '').not('promotion', 'is', null)
                    ]);
                    if (productsRes.error) throw new Error('Could not load products');
                    
                    fullProductList = productsRes.data; 
                    productList = productsRes.data.map(p => ({ 
                        id: p.id, 
                        text: p.product_name
                    }));

                    if (channelsRes.error) throw new Error('Could not load channels');
                    channelList = channelsRes.data;
                    if (inkTypesRes.error) throw new Error('Could not load ink types');
                    inkTypeList = inkTypesRes.data;
                    
                    if (promotionsRes.error) throw new Error('Could not load promotions');
                    const uniquePromotions = [...new Set(promotionsRes.data.map(p => p.promotion))];
                    promotionList = uniquePromotions.map(p => ({ id: p, text: p }));
                    const promotionSelect = $('#promotion');
                    promotionSelect.empty(); 
                    uniquePromotions.forEach(promo => {
                        const option = new Option(promo, promo, false, false);
                        promotionSelect.append(option);
                    });
                    promotionSelect.trigger('change');
                    
                    populateChannelDropdowns();
                    if (ordersRes.error) throw new Error('Could not load orders');
                    allOrdersData = ordersRes.data;
                    if (workOrdersRes.error) throw new Error('Could not load work orders');
                    allWorkOrdersData = workOrdersRes.data;
                    renderAllTabs();
                } catch(err) {
                    alert('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function renderAllTabs() {
                const searchTerms = {
                    waiting: (container.querySelector('#search-waiting')?.value || '').toLowerCase(),
                    complete: (container.querySelector('#search-complete')?.value || '').toLowerCase(),
                    cancelled: (container.querySelector('#search-cancelled')?.value || '').toLowerCase(),
                    shipped: (container.querySelector('#search-shipped')?.value || '').toLowerCase(),
                };
                const filters = { waiting: container.querySelector('#filter-waiting').value, complete: container.querySelector('#filter-complete').value, cancelled: container.querySelector('#filter-cancelled').value, shipped: container.querySelector('#filter-shipped').value };
                const lists = { 'รอลงข้อมูล': container.querySelector('#tab-waiting .order-list'), 'ลงข้อมูลเสร็จสิ้น': container.querySelector('#tab-complete .order-list'), 'ยกเลิก': container.querySelector('#tab-cancelled .order-list'), 'จัดส่งแล้ว': container.querySelector('#tab-shipped .order-list') };
                
                const summaryContainer = container.querySelector('#channel-summary-container');
                if (summaryContainer) {
                    const completedOrders = allOrdersData.filter(order => order.status === 'ลงข้อมูลเสร็จสิ้น');
                    const channelCounts = completedOrders.reduce((acc, order) => {
                        const channel = order.channel_code || 'N/A';
                        acc[channel] = (acc[channel] || 0) + 1;
                        return acc;
                    }, {});

                    summaryContainer.innerHTML = '';
                    const sortedChannels = Object.keys(channelCounts).sort();

                    if (sortedChannels.length > 0) {
                        let summaryHTML = '';
                        for (const channel of sortedChannels) {
                            summaryHTML += `<span class="channel-summary-item">${channel}: ${channelCounts[channel]} บิล</span>`;
                        }
                        summaryContainer.innerHTML = summaryHTML;
                    } else {
                        summaryContainer.innerHTML = `<span class="channel-summary-placeholder">ไม่มีบิลที่รอสร้างใบงาน</span>`;
                    }
                }
                
                workOrdersListContainer.innerHTML = '';
                Object.values(lists).forEach(list => { if(list) list.innerHTML = ''; });

                allOrdersData.forEach(order => {
                    const list = lists[order.status];
                    if (list) {
                        const tabId = list.parentElement.id;
                        const filterKey = tabId.split('-')[1];
                        const filterValue = filters[filterKey];
                        const searchTerm = searchTerms[filterKey] || '';

                        const matchesSearch = !searchTerm ||
                            (order.bill_no && order.bill_no.toLowerCase().includes(searchTerm)) ||
                            (order.customer_name && order.customer_name.toLowerCase().includes(searchTerm)) ||
                            (order.tracking_number && order.tracking_number.toLowerCase().includes(searchTerm));

                        if ((filterValue === 'all' || filterValue === order.channel_code) && matchesSearch) {
                            const trackingHTML = order.tracking_number
                                ? `<span class="order-tracking"><span class="tracking-text">${order.tracking_number}</span> <button class="btn btn-sm btn-edit-tracking" title="แก้ไขเลขพัสดุ">✏️</button></span>`
                                : '<span class="order-tracking" style="color: #ccc;">ยังไม่มีเลขพัสดุ</span>';
                            
                            list.innerHTML += `<li class="order-list-item" data-order-id="${order.id}">
                                <input type="checkbox" class="order-checkbox">
                                <div class="order-info">
                                    <strong data-order-id="${order.id}">${order.bill_no || 'N/A'}</strong>
                                    <span class="customer-info">${order.customer_name || 'N/A'}</span>
                                </div>
                                ${trackingHTML}
                            </li>`;
                        }
                    }
                });

                allWorkOrdersData.forEach(wo => {
                    const billsInWorkOrder = allOrdersData.filter(order => order.work_order_name === wo.work_order_name);
                    const allHaveTracking = billsInWorkOrder.length > 0 && billsInWorkOrder.every(bill => bill.tracking_number && bill.tracking_number.trim() !== '');
                    const trackingStatusIcon = allHaveTracking ? '<span style="color: green; font-weight: bold; margin-left: 8px;">✓</span>' : '';

                    const groupEl = document.createElement('div');
                    groupEl.className = 'work-order-group';
                    let billsHTML = '<ul class="order-list">';
                    billsInWorkOrder.forEach(bill => { 
                        const trackingHTML = bill.tracking_number
                            ? `<span class="order-tracking"><span class="tracking-text">${bill.tracking_number}</span> <button class="btn btn-sm btn-edit-tracking" title="แก้ไขเลขพัสดุ">✏️</button></span>`
                            : '<span class="order-tracking" style="color: #ccc;">ยังไม่มีเลขพัสดุ</span>';
                        
                        billsHTML += `<li class="order-list-item" data-order-id="${bill.id}">
                             <input type="checkbox" class="order-checkbox">
                             <div class="order-info">
                                <strong data-order-id="${bill.id}">${bill.bill_no}</strong>
                                <span class="customer-info">${bill.customer_name || 'N/A'}</span>
                            </div>
                            ${trackingHTML}
                        </li>`;
                    });
                    billsHTML += '</ul>';
                    
                    groupEl.innerHTML = `
                        <div class="work-order-header"> 
                            <span class="wo-name">${wo.work_order_name} (จำนวน: ${billsInWorkOrder.length} บิล)${trackingStatusIcon}</span>
                            <div class="wo-header-actions">
                                <button class="btn btn-success btn-sm picking-slip-btn" data-work-order-name="${wo.work_order_name}">📋 ทำใบเบิก</button>
                                <button class="btn btn-primary btn-sm export-production-btn" data-work-order-name="${wo.work_order_name}">📤 Export เพื่อผลิต</button>
                                <button class="btn btn-warning btn-sm prepare-waybill-btn" data-work-order-name="${wo.work_order_name}">เตรียมทำใบปะหน้า</button>
                                <button class="btn btn-info btn-sm import-wo-csv-btn" data-work-order-name="${wo.work_order_name}">นำเข้าเลขพัสดุ</button>
                                <button class="btn btn-danger btn-sm cancel-wo-btn" data-work-order-name="${wo.work_order_name}">ยกเลิกทั้งใบงาน</button>
                            </div>
                        </div>
                        <div class="work-order-bills">
                            <div class="batch-actions">
                                <button class="btn btn-secondary select-all-in-wo-btn">เลือกทั้งหมด</button>
                                <button class="btn btn-warning revert-to-waiting-btn" data-work-order-name="${wo.work_order_name}">คืนไป "รอลงข้อมูล"</button>
                                <button class="btn btn-info revert-to-complete-btn" data-work-order-name="${wo.work_order_name}">คืนไป "ลงข้อมูลเสร็จสิ้น"</button>
                                <button class="btn btn-danger cancel-bills-from-wo-btn" data-work-order-name="${wo.work_order_name}">ยกเลิกบิลที่เลือก</button>
                            </div>
                            ${billsHTML}
                        </div>`;
                    workOrdersListContainer.appendChild(groupEl);
                });
            }
            
            function prepareForWaybill(workOrderName) {
                const ordersToProcess = allOrdersData.filter(order => order.work_order_name === workOrderName);
                if (ordersToProcess.length === 0) { alert("ไม่พบออร์เดอร์ในใบงานนี้"); return; }
                const headers = ['bill_no', 'customer_address', 'payment_method', 'total_amount'];
                const rows = ordersToProcess.map(order => {
                    const escapeCsvField = (field) => {
                        const strField = String(field || '');
                        if (strField.includes(',') || strField.includes('"') || strField.includes('\n')) { return `"${strField.replace(/"/g, '""')}"`; }
                        return strField;
                    };
                    return [
                        escapeCsvField(order.bill_no), escapeCsvField(order.customer_address),
                        escapeCsvField(order.payment_method), escapeCsvField(order.total_amount)
                    ].join(',');
                });
                const csvContent = [headers.join(','), ...rows].join('\n');
                try {
                    localStorage.setItem('waybillDataForFlash', csvContent);
                    localStorage.setItem('workOrderNameForFlash', workOrderName);
                    window.open('flash_express_tool.html', '_blank');
                } catch (e) {
                    console.error("Error accessing localStorage or opening new window:", e);
                    alert("เกิดข้อผิดพลาดในการส่งข้อมูลไปยังแท็บใหม่ อาจเกิดจากข้อจำกัดของเบราว์เซอร์");
                }
            }
            
            async function handleTrackingImport(file) {
                if (!file) return;
                loadingOverlay.style.display = 'flex';
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const csv = event.target.result;
                        const lines = csv.split(/[\r\n]+/).filter(line => line.trim() !== '');
                        if (lines.length <= 1) throw new Error('ไฟล์ CSV ว่างเปล่าหรือมีแค่หัวข้อ');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        const billNoIndex = headers.indexOf('bill_no');
                        const trackingIndex = headers.indexOf('tracking_number');
                        if (billNoIndex === -1 || trackingIndex === -1) throw new Error('ไม่พบหัวข้อ bill_no และ tracking_number ในไฟล์ CSV');
                        
                        const updates = lines.slice(1).map(line => {
                            const values = line.split(',');
                            const bill_no = values[billNoIndex]?.trim().replace(/"/g, '');
                            const tracking_number = values[trackingIndex]?.trim().replace(/"/g, '');
                            if (!bill_no || !tracking_number) return null;
                            return { bill_no, tracking_number };
                        }).filter(Boolean);

                        if (updates.length === 0) throw new Error('ไม่พบข้อมูลที่ถูกต้องในไฟล์ CSV');
                        const { data: updatedCount, error } = await supabaseClient.rpc('update_tracking_numbers_batch', { p_updates: updates });
                        if (error) throw error;
                        alert(`นำเข้าสำเร็จ! อัปเดตเลขพัสดุ ${updatedCount} รายการ`);
                        await loadInitialData();
                    } catch (err) {
                        console.error('Error importing tracking numbers:', err);
                        alert('เกิดข้อผิดพลาดในการนำเข้า: ' + err.message);
                    } finally {
                        loadingOverlay.style.display = 'none';
                        trackingFileInput.value = '';
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }

            function downloadOrderTemplate() {
                const headers = [
                    "ช่องทาง", "ชื่อลูกค้า", "ที่อยู่ลูกค้า", "ราคา", "ค่าส่ง", "ส่วนลด", "วิธีการชำระ", "ชื่อโปรโมชั่น", "วันที่ชำระ", "เวลาที่ชำระ",
                    "ชื่อสินค้า", "สีหมึก", "ชั้นที่", "ลายการ์ตูน", "ลายเส้น", "ฟอนต์", "บรรทัด 1", "บรรทัด 2", "บรรทัด 3", "จำนวน", "หมายเหตุ", "ไฟล์แนบ"
                ];
                
                const sampleData = [
                    [
                        "SP", "สมชาย ใจดี", "123/45 ถ.สุขุมวิท พระโขนง คลองเตย กทม. 10110", 300, 30, 0, "โอน", "โปร 9.9", "2025-10-15", "10:30",
                        "ป้ายชื่อรีดติด", "ดำ", "1", "กระต่าย", "เส้นปกติ", "TH01", "ด.ช. รักเรียน", "ชั้น ป.1", "", 2, "ไม่มี", ""
                    ],
                    [
                        "", "", "", "", "", "", "", "", "", "",
                        "สติกเกอร์กันน้ำ", "สี", "2", "ไดโนเสาร์", "เส้นหนา", "F03", "น้องพอใจ", "", "", 1, "ของานด่วน", ""
                    ],
                    [
                        "LAZ", "สมศรี มีสุข", "456 หมู่ 7 ต.สุเทพ อ.เมือง จ.เชียงใหม่ 50200", 159, 25, 10, "COD", "", "", "",
                        "ป้ายชื่อรีดติด", "น้ำเงิน", "5", "จรวด", "เส้นปกติ", "F12", "ด.ช. มานะ", "อนุบาล 3", "", 1, "", ""
                    ]
                ];
                
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "OrderTemplate");
                XLSX.writeFile(workbook, "TRKids_Multi_Order_Template_Simple.xlsx");
            }

            function applyStampInkLogicToOrderObject(order) {
                const originalItems = [...order.items]; 
                
                originalItems.forEach(item => {
                    const product = fullProductList.find(p => p.id === item.product_id);
                    if (!product || !product.product_category || !product.product_category.toUpperCase().includes('STAMP')) {
                        return; 
                    }

                    const inkColor = item.ink_color || '';
                    const targetColors = { 'เขียว': 'เขียว', 'ดำ': 'ดำ', 'แดง': 'แดง', 'น้ำเงิน': 'น้ำเงิน' };
                    const matchedColor = Object.keys(targetColors).find(c => inkColor.includes(c) && inkColor.includes('พลาสติก'));

                    if (!matchedColor) {
                        return;
                    }
                    
                    const inkProductName = `หมึกแฟลชพลาสติก 5 ml. (${matchedColor})`;
                    const inkProductToAdd = fullProductList.find(p => p.product_name === inkProductName);

                    if (inkProductToAdd) {
                        const alreadyExists = order.items.some(existingItem => existingItem.product_id === inkProductToAdd.id);
                        if (!alreadyExists) {
                             order.items.push({
                                product_id: inkProductToAdd.id,
                                product_name: inkProductToAdd.product_name,
                                quantity: 1,
                                ink_color: "", product_type: "", cartoon_pattern: "",
                                line_pattern: "", font: "", line_1: "",
                                line_2: "", line_3: "", notes: "สินค้าแถม", file_attachment: ""
                            });
                        }
                    } else {
                        console.warn(`Could not find product to auto-add for giveaway: ${inkProductName}`);
                    }
                });
            }
            
            async function processAndSaveImportedOrders(ordersToImport, useProvidedBillNo = false) {
                loadingOverlay.style.display = 'flex';
                let successCount = 0;
                let totalItemsCount = 0;
                let failedOrders = [];
                let skippedOrders = [];

                for (const order of ordersToImport) {
                    try {
                        const billNo = useProvidedBillNo ? order.bill_no : await generateNextBillNo(order.channel_code);
                        if (!billNo) {
                            failedOrders.push({ name: order.customer_name || 'N/A', reason: 'ไม่สามารถสร้างเลขบิลได้' });
                            continue; 
                        }

                        const existingOrder = allOrdersData.find(o => o.bill_no === billNo);
                        if (existingOrder) {
                            console.warn(`Skipping order with existing bill_no: ${billNo}`);
                            skippedOrders.push(billNo);
                            continue;
                        }

                        applyStampInkLogicToOrderObject(order);
                        
                        const orderData = { ...order };
                        delete orderData.items; 

                        const { data: insertedOrder, error: orderError } = await supabaseClient
                            .from('orders').insert({ ...orderData, bill_no: billNo }).select().single();
                        if (orderError) throw orderError;
                        
                        const allItemsToInsert = [];
                        let itemSequence = 1;
                        for (const item of order.items) {
                            const quantity = item.quantity || 1;
                            const baseItemData = { ...item };
                            delete baseItemData.quantity;

                            for (let i = 0; i < quantity; i++) {
                                allItemsToInsert.push({
                                    ...baseItemData,
                                    order_id: insertedOrder.id,
                                    bill_no: billNo,
                                    item_uid: `${billNo}-${itemSequence++}`
                                });
                            }
                        }

                        if (allItemsToInsert.length > 0) {
                            const { error: itemsError } = await supabaseClient.from('order_items').insert(allItemsToInsert);
                            if (itemsError) throw itemsError;
                            totalItemsCount += allItemsToInsert.length;
                        }
                        successCount++;
                    } catch (err) {
                        console.error(`Error processing order for ${order.customer_name}:`, err);
                        const billNoForError = useProvidedBillNo ? order.bill_no : 'N/A';
                        if (err.message.includes('duplicate key')) {
                             failedOrders.push({ name: order.customer_name || 'N/A', reason: `เลขบิลซ้ำ: ${billNoForError}`});
                        } else {
                             failedOrders.push({ name: order.customer_name || 'N/A', reason: err.message });
                        }
                    }
                }
                
                loadingOverlay.style.display = 'none';
                let alertMessage = `นำเข้าสำเร็จ ${successCount} ออร์เดอร์ (รวม ${totalItemsCount} รายการสินค้า)`;
                
                if (skippedOrders.length > 0) {
                    alertMessage += `\n\nข้าม ${skippedOrders.length} ออร์เดอร์เนื่องจากมีเลขบิลซ้ำในระบบแล้ว`;
                    if (skippedOrders.length <= 10) { 
                        alertMessage += `: ${skippedOrders.join(', ')}.`;
                    }
                }

                if (failedOrders.length > 0) {
                    const failedReasons = failedOrders.map(f => `${f.name} (${f.reason})`).join(', ');
                    alertMessage += `\n\nเกิดข้อผิดพลาดกับออร์เดอร์: ${failedReasons}.`;
                }

                alert(alertMessage);
                await loadInitialData();
            }

            const findHeader = (headers, possibleNames) => {
                const lowerCaseNames = possibleNames.map(name => name.toLowerCase().trim());
                for (const header of headers) {
                    if (lowerCaseNames.includes(header.toLowerCase().trim())) {
                        return header;
                    }
                }
                return null;
            };
            
            function excelDateToJSDate(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                const utc_days = Math.floor(serial - 25569);
                const utc_value = utc_days * 86400;                                        
                const date_info = new Date(utc_value * 1000);
                const fractional_day = serial - Math.floor(serial) + 0.0000001;
                let total_seconds = Math.floor(86400 * fractional_day);
                const seconds = total_seconds % 60;
                total_seconds -= seconds;
                const hours = Math.floor(total_seconds / (60 * 60));
                const minutes = Math.floor(total_seconds / 60) % 60;
                return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
            }

            function handleExcelImport(file) {
                if (!file) return;
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        const rowsData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: false });

                        if (rowsData.length <= 1) throw new Error("ไม่พบข้อมูลในไฟล์ Excel");

                        const processedOrders = [];
                        let currentOrder = null;

                        for (let i = 1; i < rowsData.length; i++) {
                            const row = rowsData[i];
                             if (row.every(cell => String(cell).trim() === '')) continue;
                            
                            const channelCode = String(row[0]).trim();
                            const customerName = String(row[1]).trim();
                            const productNameOrCode = String(row[10]).trim();

                            if (channelCode && customerName) {
                                const price = parseFloat(row[3]) || 0;
                                const shippingCost = parseFloat(row[4]) || 0;
                                const discount = parseFloat(row[5]) || 0;

                                let paymentDate = row[8] ? String(row[8]).trim() : null;
                                let paymentTime = row[9] ? String(row[9]).trim() : null;
                                
                                if (paymentDate && !isNaN(paymentDate) && Number(paymentDate) > 1) {
                                    const jsDate = excelDateToJSDate(Number(paymentDate));
                                    if(jsDate) {
                                        paymentDate = jsDate.toISOString().split('T')[0];
                                    }
                                }
                                if (paymentTime && !isNaN(paymentTime) && Number(paymentTime) < 1) {
                                     const jsDate = excelDateToJSDate(Number(paymentTime));
                                     if(jsDate) {
                                         paymentTime = jsDate.toTimeString().split(' ')[0].substring(0,5);
                                     }
                                }
                                
                                currentOrder = {
                                    channel_code: channelCode, customer_name: customerName, customer_address: String(row[2]),
                                    price: price, shipping_cost: shippingCost, discount: discount, total_amount: price + shippingCost - discount,
                                    payment_method: String(row[6]), promotion: String(row[7]),
                                    payment_date: paymentDate, payment_time: paymentTime,
                                    admin_user: loggedInUsername, status: 'ลงข้อมูลเสร็จสิ้น', entry_date: new Date().toISOString().slice(0, 10),
                                    items: []
                                };
                                processedOrders.push(currentOrder);
                            }

                            if (productNameOrCode) {
                                if (!currentOrder) throw new Error(`พบสินค้า '${productNameOrCode}' ที่แถว ${i + 1} แต่ไม่พบข้อมูลหลักของออร์เดอร์`);
                                
                                const searchTerm = productNameOrCode.toLowerCase();
                                const product = fullProductList.find(p => p.product_code.toLowerCase() === searchTerm || p.product_name.toLowerCase().includes(searchTerm));

                                if (!product) {
                                    console.warn(`ไม่พบสินค้า '${productNameOrCode}' ที่แถว ${i+1} - จะถูกข้ามไป`);
                                    continue;
                                }
                                
                                const itemData = {
                                    product_id: product.id, product_name: product.product_name,
                                    ink_color: String(row[11]), product_type: String(row[12]), cartoon_pattern: String(row[13]),
                                    line_pattern: String(row[14]), font: String(row[15]), line_1: String(row[16]),
                                    line_2: String(row[17]), line_3: String(row[18]), 
                                    quantity: parseInt(row[19]) || 1, 
                                    notes: String(row[20]), file_attachment: String(row[21])
                                };
                                currentOrder.items.push(itemData);
                            }
                        }

                        if (processedOrders.length === 0) throw new Error("ไม่พบข้อมูลออร์เดอร์ที่สมบูรณ์ในไฟล์");

                        if (confirm(`พบ ${processedOrders.length} ออร์เดอร์ในไฟล์นี้ คุณต้องการดำเนินการนำเข้าใช่หรือไม่?`)) {
                             await processAndSaveImportedOrders(processedOrders);
                        }
                        
                    } catch (err) {
                        console.error('Error importing Excel file:', err);
                        alert('เกิดข้อผิดพลาดในการอ่านไฟล์: ' + err.message);
                    } finally {
                        importOrdersFileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function handlePgtrImport(file) {
                if (!file) return;
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {raw: false});

                        if (jsonData.length === 0) throw new Error("ไม่พบข้อมูลในไฟล์ Excel");
                        
                        const headers = Object.keys(jsonData[0]);
                        const orderNumberHeader = findHeader(headers, ['เลขออร์เดอร์', 'เลขที่ออเดอร์', 'Order Number']);
                        const paymentDateHeader = findHeader(headers, ['วันที่สั่งซื้อ']);
                        const paymentTimeHeader = findHeader(headers, ['เวลา']);

                        if(!orderNumberHeader){
                            throw new Error("ไม่พบคอลัมน์ 'เลขออร์เดอร์' ในไฟล์");
                        }
                        
                        const ordersMap = new Map();

                        for (const row of jsonData) {
                            const orderNumberRaw = String(row[orderNumberHeader] || '').trim();
                            if (!orderNumberRaw) continue;
                            
                            let orderNumber = orderNumberRaw;
                            const lastHyphenIndex = orderNumber.lastIndexOf('-');
                            if (lastHyphenIndex > 0) {
                                const lastSegment = orderNumber.substring(lastHyphenIndex + 1);
                                if (!isNaN(parseInt(lastSegment)) && /^\d{1,2}$/.test(lastSegment)) {
                                    orderNumber = orderNumber.substring(0, lastHyphenIndex);
                                }
                            }

                            if (!ordersMap.has(orderNumber)) {
                                const price = parseFloat(row["ราคาก่อนส่วนลด"]) || 0;
                                const shippingCost = parseFloat(row["ค่าขนส่ง"]) || 0;
                                const discount = parseFloat(row["ส่วนลด admin"]) || 0;
                                
                                let paymentDate = null;
                                let paymentTime = null;

                                if (paymentDateHeader && row[paymentDateHeader]) {
                                    const rawDate = row[paymentDateHeader];
                                    if (typeof rawDate === 'number' && !isNaN(rawDate)) {
                                        const jsDate = excelDateToJSDate(rawDate);
                                        if (jsDate) paymentDate = jsDate.toISOString().split('T')[0];
                                    } else if (typeof rawDate === 'string' && rawDate.trim() !== '') {
                                        const dateParts = rawDate.trim().split('/');
                                        if (dateParts.length === 3 && dateParts[2].length === 4) {
                                            paymentDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                                        }
                                    }
                                }
                                
                                if (paymentTimeHeader && row[paymentTimeHeader]) {
                                    const rawTime = row[paymentTimeHeader];
                                    if (typeof rawTime === 'number' && !isNaN(rawTime) && rawTime < 1) {
                                        const jsDate = excelDateToJSDate(rawTime);
                                        if(jsDate) paymentTime = jsDate.toTimeString().split(' ')[0].substring(0, 5);
                                    } else if (typeof rawTime === 'string' && rawTime.trim() !== '') {
                                        paymentTime = rawTime.trim().substring(0, 5);
                                    }
                                }

                                const orderData = {
                                    bill_no: orderNumber,
                                    channel_code: 'PGTR',
                                    customer_name: row["ชื่อสกุลผู้รับ"],
                                    customer_address: `${row["ชื่อสกุลผู้รับ"] || ''},${row["ที่อยู่เต็ม"] || ''},${row["โทรศัพท์"] || ''}`,
                                    price: price, shipping_cost: shippingCost, discount: discount, total_amount: price + shippingCost - discount,
                                    payment_method: "โอน", promotion: "",
                                    payment_date: paymentDate,
                                    payment_time: paymentTime,
                                    admin_user: loggedInUsername, status: 'ลงข้อมูลเสร็จสิ้น', entry_date: new Date().toISOString().slice(0, 10),
                                    items: []
                                };
                                ordersMap.set(orderNumber, orderData);
                            }

                            const currentOrder = ordersMap.get(orderNumber);
                            const productName = row["ชื่อสินค้า"] || '';
                            const searchTerm = productName.toLowerCase();
                            const product = fullProductList.find(p => p.product_code.toLowerCase() === searchTerm || p.product_name.toLowerCase().includes(searchTerm));

                            if (!product) {
                                console.warn(`ไม่พบสินค้า '${productName}' สำหรับออร์เดอร์ ${orderNumber} - จะถูกข้ามไป`);
                                continue;
                            }
                            
                            const comment = row["comment"] || "";
                            const remark = row["remark"] || "";

                            const itemData = {
                                product_id: product.id, product_name: product.product_name,
                                ink_color: `${row["Ink"] || ''}${row["สี"] || ''}`, product_type: "",
                                cartoon_pattern: row["รหัสรูปแบบ"], line_pattern: row["Underline"], font: row["ฟอนต์"],
                                line_1: row["Label1"], line_2: row["Label2"], line_3: row["Label3"],
                                quantity: parseInt(row["จำนวน"]) || 1,
                                notes: comment && remark ? `${comment},${remark}` : (comment || remark),
                                file_attachment: ""
                            };
                            currentOrder.items.push(itemData);
                        }
                        
                        const processedOrders = Array.from(ordersMap.values());
                        if (processedOrders.length === 0) throw new Error("ไม่พบข้อมูลออร์เดอร์ที่สามารถประมวลผลได้ในไฟล์");

                        if (confirm(`พบ ${processedOrders.length} ออร์เดอร์ในไฟล์ PGTR นี้ คุณต้องการดำเนินการนำเข้าใช่หรือไม่?`)) {
                             await processAndSaveImportedOrders(processedOrders, true);
                        }
                        
                    } catch (err) {
                        console.error('Error importing PGTR file:', err);
                        alert('เกิดข้อผิดพลาดในการอ่านไฟล์ PGTR: ' + err.message);
                    } finally {
                        importOrdersFileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function handleWyImport(file) {
                if (!file) return;
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        if (jsonData.length === 0) throw new Error("ไม่พบข้อมูลในไฟล์");
                        
                        const headers = Object.keys(jsonData[0]);
                        const billNoHeader = findHeader(headers, ['เลขบิล', 'bill_no', 'เลขที่บิล']);
                        const dateTimeHeader = findHeader(headers, ['วันที่สั่งซื้อ']);

                        if(!billNoHeader){
                             throw new Error("ไม่พบคอลัมน์ 'เลขบิล' ในไฟล์");
                        }

                        const ordersMap = new Map();

                        for (const row of jsonData) {
                            const billNo = String(row[billNoHeader]).trim();
                            if (!billNo) continue;

                            if (!ordersMap.has(billNo)) {
                                const price = parseFloat(row['ราคาก่อนลด']) || 0;
                                const shippingCost = parseFloat(row['ค่าส่ง']) || 0;
                                const discount = parseFloat(row['ส่วนลด']) || 0;

                                const customerAddress = [
                                    `${row['ชื่อ'] || ''} ${row['นามสกุล'] || ''}`,
                                    `${row['เบอร์โทร'] || ''}`, `${row['ที่อยู่'] || ''}`,
                                    `ต.${row['แขวง/ตำบล'] || ''}`, `อ.${row['เขต/อำเภอ'] || ''}`,
                                    `จ.${row['จังหวัด'] || ''}`, `${row['เลขไปรษณีย์'] || ''}`
                                ].filter(Boolean).join(', ');
                                
                                let paymentDate = null;
                                let paymentTime = null;
                                if (dateTimeHeader && row[dateTimeHeader]) {
                                    const rawValue = row[dateTimeHeader];
                                    if (typeof rawValue === 'number' && !isNaN(rawValue)) {
                                        const jsDate = excelDateToJSDate(rawValue);
                                        if (jsDate) {
                                            paymentDate = jsDate.toISOString().split('T')[0];
                                            paymentTime = jsDate.toTimeString().split(' ')[0].substring(0, 5);
                                        }
                                    } else if (typeof rawValue === 'string' && rawValue.trim() !== '') {
                                        try {
                                            const dateTimeString = rawValue.trim();
                                            const parts = dateTimeString.split(/\s+/);
                                            if (parts.length >= 2) {
                                                const dateParts = parts[0].split('/');
                                                if (dateParts.length === 3) {
                                                    const day = dateParts[0];
                                                    const month = dateParts[1];
                                                    const year = dateParts[2];
                                                    if (year.length === 4 && !isNaN(parseInt(year))) {
                                                       paymentDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                                    }
                                                }
                                                if (/^\d{1,2}:\d{2}/.test(parts[1])) {
                                                    paymentTime = parts[1].substring(0, 5);
                                                }
                                            }
                                        } catch (dateErr) {
                                            console.warn(`Could not parse date string for bill ${billNo}:`, rawValue);
                                        }
                                    }
                                }

                                const orderData = {
                                    bill_no: billNo, channel_code: 'WY',
                                    customer_name: `${row['ชื่อ'] || ''} ${row['นามสกุล'] || ''}`,
                                    customer_address: customerAddress,
                                    price: price, shipping_cost: shippingCost, discount: discount,
                                    total_amount: parseFloat(row['ยอดสุทธิ']) || (price + shippingCost - discount),
                                    payment_method: 'โอน', promotion: row['โค้ดส่วนลด'] || '',
                                    payment_date: paymentDate,
                                    payment_time: paymentTime,
                                    admin_user: loggedInUsername, status: 'ลงข้อมูลเสร็จสิ้น', entry_date: new Date().toISOString().slice(0, 10),
                                    items: []
                                };
                                ordersMap.set(billNo, orderData);
                            }

                            const currentOrder = ordersMap.get(billNo);
                            const productNameFromFile = String(row['รหัส']).trim();
                            const product = fullProductList.find(p => p.product_name.toLowerCase() === productNameFromFile.toLowerCase());
                            
                            if (product) {
                                const itemData = {
                                    product_id: product.id, product_name: product.product_name,
                                    ink_color: "", product_type: "", cartoon_pattern: "", line_pattern: "",
                                    font: row['font'] || '', line_1: row['บรรทัด1'] || '', line_2: row['บรรทัด2'] || '', line_3: "",
                                    quantity: parseInt(row['จำนวน']) || 1,
                                    notes: row['หมายเหตุ'] || '', file_attachment: ""
                                };
                                currentOrder.items.push(itemData);
                            } else {
                                console.warn(`ไม่พบสินค้า '${productNameFromFile}' สำหรับบิล ${billNo} - จะถูกข้ามไป`);
                            }
                        }
                        
                        const processedOrders = Array.from(ordersMap.values());
                        if (processedOrders.length === 0) throw new Error("ไม่พบข้อมูลออร์เดอร์ที่สมบูรณ์ในไฟล์");

                        if (confirm(`พบ ${processedOrders.length} ออร์เดอร์ในไฟล์ WY นี้ คุณต้องการดำเนินการนำเข้าใช่หรือไม่?`)) {
                             await processAndSaveImportedOrders(processedOrders, true);
                        }

                    } catch (err) {
                        console.error('Error importing WY file:', err);
                        alert('เกิดข้อผิดพลาดในการอ่านไฟล์ WY: ' + err.message);
                    } finally {
                        importOrdersFileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function handleSmartImport(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', bookFiles: true });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        if (jsonData.length === 0) {
                            throw new Error("ไฟล์ที่เลือกไม่มีข้อมูล");
                        }

                        const firstRow = jsonData[0];
                        const headers = Object.keys(firstRow);

                        const orderNumberHeader = findHeader(headers, ['เลขออร์เดอร์', 'เลขที่ออเดอร์', 'Order Number']);
                        if (orderNumberHeader && String(firstRow[orderNumberHeader]).toUpperCase().startsWith('S2Y')) {
                            console.log("PGTR format detected.");
                            handlePgtrImport(file);
                            return;
                        }
                        
                        const billNoHeader = findHeader(headers, ['เลขบิล', 'bill_no', 'เลขที่บิล']);
                        if (billNoHeader && String(firstRow[billNoHeader]).toUpperCase().startsWith('WY')) {
                             console.log("WY format detected.");
                             handleWyImport(file);
                             return;
                        }
                        
                        console.log("Standard template format detected.");
                        handleExcelImport(file);

                    } catch (err) {
                        console.error('Error detecting file type:', err);
                        alert("ไม่สามารถระบุประเภทของไฟล์ได้ หรือไฟล์อาจมีรูปแบบไม่ถูกต้อง: " + err.message);
                        importOrdersFileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function toggleWorkOrder(headerElement) { 
                const content = headerElement.nextElementSibling; 
                if (content) { content.classList.toggle('show'); } 
            }
            function populateChannelDropdowns() { const dropdowns = [ container.querySelector('#channel_code'), container.querySelector('#filter-waiting'), container.querySelector('#filter-complete'), container.querySelector('#filter-cancelled'), container.querySelector('#filter-shipped') ]; dropdowns.forEach(dropdown => { if (!dropdown) return; const isFilter = dropdown.id.startsWith('filter-'); dropdown.innerHTML = isFilter ? '<option value="all">แสดงทั้งหมด</option>' : '<option value="">-- เลือกช่องทาง --</option>'; channelList.forEach(ch => { const opt = document.createElement('option'); opt.value = ch.channel_code; opt.textContent = ch.channel_name; dropdown.appendChild(opt); }); }); }
            function openTab(evt, tabName) { container.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active')); container.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active')); container.querySelector(`#${tabName}`).classList.add('active'); evt.currentTarget.classList.add('active'); if (tabName === 'tab-create') { setFormMode('create'); } }
            
            function setFormMode(mode, order = null) {
                orderForm.reset(); itemsTbody.innerHTML = ''; currentEditingOrderId = null;
                $(container.querySelectorAll('select')).not('#promotion').val(null).trigger('change'); 
                $('#promotion').val(null).trigger('change');
                adminUserInput.value = loggedInUsername;

                if (mode === 'create') {
                    container.querySelector('#form-title').textContent = 'สร้างออร์เดอร์ใหม่';
                    addItemRow();
                    formActions.innerHTML = `<button type="button" class="btn btn-secondary" id="save-waiting-btn">บันทึก (รอลงข้อมูล)</button> <button type="button" class="btn btn-success" id="save-complete-btn">บันทึก (ข้อมูลครบถ้วน)</button>`;
                } else if (mode === 'edit' && order) {
                    container.querySelector('#form-title').textContent = `แก้ไขออร์เดอร์: ${order.bill_no}`;
                    currentEditingOrderId = order.id;
                    Object.keys(order).forEach(key => {
                        const input = container.querySelector(`#${key}`);
                        if (input) {
                            if (input.tagName === 'SELECT') { 
                                if (key === 'promotion') {
                                    if (order[key] && !$('#promotion').find(`option[value='${order[key]}']`).length) {
                                        var newOption = new Option(order[key], order[key], true, true);
                                        $('#promotion').append(newOption).trigger('change');
                                    }
                                    $('#promotion').val(order[key]).trigger('change');
                                } else {
                                     $(input).val(order[key]).trigger('change'); 
                                }
                            } 
                            else { input.value = order[key]; }
                        }
                    });
                    container.querySelector('#payment_time').value = order.payment_time ? order.payment_time.substring(0, 5) : '';

                    const itemGroups = {};
                    (order.order_items || []).forEach(item => {
                        const key = [item.product_id, item.ink_color, item.product_type, item.cartoon_pattern, item.line_pattern, item.font, item.line_1, item.line_2, item.line_3, item.notes, item.file_attachment].join('||');
                        if (!itemGroups[key]) {
                            itemGroups[key] = { ...item, quantity: 1 };
                        } else {
                            itemGroups[key].quantity++;
                        }
                    });

                    Object.values(itemGroups).forEach(groupedItem => {
                        addItemRow(groupedItem);
                    });

                    if (order.status === 'รอลงข้อมูล') {
                        formActions.innerHTML = `<button type="button" class="btn btn-primary" id="update-waiting-btn">อัปเดต (ยังรอลงข้อมูล)</button> <button type="button" class="btn btn-success" id="move-to-complete-btn">ย้ายไป "ลงข้อมูลเสร็จสิ้น"</button> <button type="button" class="btn btn-danger" id="cancel-bill-btn">ยกเลิกบิล</button>`;
                    } else if (order.status === 'ลงข้อมูลเสร็จสิ้น') {
                        formActions.innerHTML = `<button type="button" class="btn btn-primary" id="update-complete-btn">อัปเดตข้อมูล</button> <button type="button" class="btn btn-danger" id="cancel-bill-btn">ยกเลิกบิล</button>`;
                    } else {
                        formActions.innerHTML = ``;
                    }
                }
                attachFormActionListeners(order);
                calculateTotal();
            }

            async function loadOrderForEditing(orderId) { loadingOverlay.style.display = 'flex'; try { const orderData = allOrdersData.find(o => o.id == orderId); if(!orderData) throw new Error('ไม่พบข้อมูล'); openTab({ currentTarget: container.querySelector('.tab-link[data-tab="tab-create"]') }, 'tab-create'); setFormMode('edit', orderData); } catch (error) { alert('ไม่สามารถโหลดข้อมูลออร์เดอร์ได้: ' + error.message); } finally { loadingOverlay.style.display = 'none'; } }
            async function moveOrder(orderId, newStatus) { if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการย้ายบิลนี้ไปสถานะ "${newStatus}"?`)) return; loadingOverlay.style.display = 'flex'; try { const { error } = await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId); if (error) throw error; alert(`ย้ายบิลสำเร็จ!`); await loadInitialData(); setFormMode('create'); } catch(error) { alert('เกิดข้อผิดพลาด: ' + error.message); } finally { loadingOverlay.style.display = 'none'; } }
            
            function getFontOptionsForChannel(channelCode) {
                const fontList = (channelCode === 'WY') ? wyFonts : standardFonts;
                const options = fontList.map(f => `<option value="${f}">${f}</option>`).join('');
                return `<option value="">--เลือก--</option>${options}`;
            }
            
            function updateAllFontDropdowns(channelCode) {
                const newFontOptionsHTML = getFontOptionsForChannel(channelCode);
                const fontDropdowns = itemsTbody.querySelectorAll('.item-font');
                
                fontDropdowns.forEach(fontSelect => {
                    const selectedValue = fontSelect.value;
                    fontSelect.innerHTML = newFontOptionsHTML;
                    
                    if (fontSelect.querySelector(`option[value="${selectedValue}"]`)) {
                        fontSelect.value = selectedValue;
                    } else {
                        fontSelect.value = ""; 
                    }
                });
            }

            function addItemRow(item = null, rowUid = null) {
                const newUid = rowUid || 'row-' + Date.now() + Math.random();
                const row = itemsTbody.insertRow();
                row.dataset.rowUid = newUid;
                
                const shelfOptions = ['1', '2', '3', '4', '5'].map(n => `<option value="${n}">${n}</option>`).join('');
                
                const currentChannel = container.querySelector('#channel_code').value;
                const fontOptions = getFontOptionsForChannel(currentChannel);

                row.innerHTML = `
                    <td><select class="item-product"></select></td>
                    <td><select class="item-ink_color"><option value="">--เลือกสี--</option></select></td>
                    <td><select class="item-shelf_location"><option value="">--เลือก--</option>${shelfOptions}</select></td>
                    <td><input type="text" class="item-cartoon_pattern"></td>
                    <td><input type="text" class="item-line_pattern"></td>
                    <td><select class="item-font">${fontOptions}</select></td>
                    <td><input type="text" class="item-line_1"></td>
                    <td><input type="text" class="item-line_2"></td>
                    <td><input type="text" class="item-line_3"></td>
                    <td><input type="number" class="item-quantity quantity-input" value="1" min="1"></td>
                    <td><input type="text" class="item-notes"></td>
                    <td><input type="text" class="item-file_attachment"></td>
                    <td class="action-cell"><button type="button" class="btn btn-danger remove-item-btn">X</button></td>`;
                
                const productSelect = $(row.querySelector('.item-product'));
                productSelect.select2({ data: productList, placeholder: 'เลือกสินค้า', width: '100%' });

                const inkSelect = row.querySelector('.item-ink_color');
                inkTypeList.forEach(ink => {
                    const opt = document.createElement('option');
                    opt.value = ink.ink_name;
                    opt.textContent = ink.ink_name;
                    inkSelect.appendChild(opt);
                });
                
                if (item) {
                    productSelect.val(item.product_id).trigger('change.select2');
                    inkSelect.value = item.ink_color || '';
                    row.querySelector('.item-shelf_location').value = item.product_type || '';
                    row.querySelector('.item-cartoon_pattern').value = item.cartoon_pattern || '';
                    row.querySelector('.item-line_pattern').value = item.line_pattern || '';
                    row.querySelector('.item-font').value = item.font || '';
                    row.querySelector('.item-line_1').value = item.line_1 || '';
                    row.querySelector('.item-line_2').value = item.line_2 || '';
                    row.querySelector('.item-line_3').value = item.line_3 || '';
                    row.querySelector('.item-notes').value = item.notes || '';
                    row.querySelector('.item-file_attachment').value = item.file_attachment || '';
                    row.querySelector('.item-quantity').value = item.quantity || 1;
                }
                return row;
            }
            
            function selectAll(tabKey) { const list = container.querySelector(`#tab-${tabKey} .order-list`); if (!list) return; const checkboxes = list.querySelectorAll('.order-checkbox'); const isAllChecked = Array.from(checkboxes).every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !isAllChecked); }
            function getSelectedOrderIds(listContainer) { return Array.from(listContainer.querySelectorAll('.order-checkbox:checked')).map(cb => cb.closest('.order-list-item').dataset.orderId); }
            
            async function createWorkOrder() {
                const selectedIds = getSelectedOrderIds(container.querySelector('#tab-complete .order-list'));
                if (selectedIds.length === 0) {
                    return alert('กรุณาเลือกออร์เดอร์อย่างน้อย 1 รายการ');
                }

                const selectedOrders = allOrdersData.filter(o => selectedIds.includes(String(o.id)));
                
                const ordersByChannel = selectedOrders.reduce((acc, order) => {
                    const channel = order.channel_code;
                    if (!acc[channel]) {
                        acc[channel] = [];
                    }
                    acc[channel].push(order);
                    return acc;
                }, {});

                const channelGroups = Object.keys(ordersByChannel);

                let confirmationMessage = "คุณต้องการสร้างใบงานสำหรับ:\n";
                channelGroups.forEach(channel => {
                    confirmationMessage += `- ${channel}: ${ordersByChannel[channel].length} บิล\n`;
                });
                confirmationMessage += "\nดำเนินการต่อใช่หรือไม่?";

                if (!confirm(confirmationMessage)) {
                    return;
                }

                loadingOverlay.style.display = 'flex';
                let successMessages = [];
                let errorMessages = [];

                for (const channelCode of channelGroups) {
                    const groupSelectedIds = ordersByChannel[channelCode].map(o => o.id);
                    try {
                        const today = new Date();
                        const datePart = today.toLocaleDateString('th-TH', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
                        const workOrderDate = today.toISOString().slice(0, 10);

                        const { data, error } = await supabaseClient
                            .from('work_orders')
                            .select('batch_number')
                            .eq('channel_code', channelCode)
                            .eq('production_date', workOrderDate)
                            .order('batch_number', { ascending: false })
                            .limit(1);

                        if (error) throw error;
                        
                        const lastBatchNumber = data.length > 0 ? data[0].batch_number : 0;
                        const batchNumber = lastBatchNumber + 1;
                        const workOrderName = `${channelCode}-${datePart}-R${batchNumber}`;

                        const { error: woError } = await supabaseClient.from('work_orders').insert({
                            work_order_name: workOrderName,
                            channel_code: channelCode,
                            production_date: workOrderDate,
                            batch_number: batchNumber,
                            order_count: groupSelectedIds.length,
                            created_by: loggedInUsername,
                            status: 'กำลังผลิต'
                        });
                        if (woError) throw woError;

                        const { error: updateError } = await supabaseClient.from('orders').update({ status: 'ใบงาน (กำลังผลิต)', work_order_name: workOrderName }).in('id', groupSelectedIds);
                        if (updateError) throw updateError;
                        
                        const billsInWorkOrder = ordersByChannel[channelCode];
                        const qty = { STAMP: 0, STK: 0, CTT: 0, LASER: 0, TUBE: 0, PACK: billsInWorkOrder.length };

                        billsInWorkOrder.forEach(order => {
                            (order.order_items || []).forEach(item => {
                                const product = fullProductList.find(p => p.id === item.product_id);
                                if (product && product.product_category) {
                                    const category = product.product_category.toUpperCase();
                                    if (category.includes('STAMP')) qty.STAMP++;
                                    if (category.includes('STK')) qty.STK++;
                                    if (category.includes('UV')) qty.CTT++;
                                    if (category.includes('LASER')) qty.LASER++;
                                    if (category.includes('TUBE')) qty.TUBE++;
                                }
                            });
                        });
                        
                        const creationTime = new Date();
                        const cutTime = `${String(creationTime.getHours()).padStart(2, '0')}:${String(creationTime.getMinutes()).padStart(2, '0')}`;

                        const { error: plannerError } = await supabaseClient.from('jobs').insert({
                            name: workOrderName,
                            date: workOrderDate,
                            cut: cutTime,
                            qty: qty,
                        });

                        if (plannerError) {
                            console.error('Failed to sync new work order to planner:', plannerError);
                             throw new Error(`สร้างใบงาน "${workOrderName}" สำเร็จ แต่ Sync ไปยัง Planner ล้มเหลว`);
                        }
                        
                        successMessages.push(`สร้างใบงาน "${workOrderName}" สำเร็จ`);

                    } catch (error) {
                        console.error(`Error creating work order for channel ${channelCode}:`, error);
                        errorMessages.push(`เกิดข้อผิดพลาดกับช่องทาง ${channelCode}: ${error.message}`);
                    }
                }
                
                loadingOverlay.style.display = 'none';
                let finalAlertMessage = successMessages.join('\n');
                if(errorMessages.length > 0) {
                    finalAlertMessage += '\n\nข้อผิดพลาด:\n' + errorMessages.join('\n');
                }
                alert(finalAlertMessage);
                await loadInitialData();
            }

            async function cancelSelectedOrders(tabKey) { const selectedIds = getSelectedOrderIds(container.querySelector(`#tab-${tabKey} .order-list`)); if (selectedIds.length === 0) return alert('กรุณาเลือกออร์เดอร์ที่ต้องการยกเลิก'); if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการยกเลิก ${selectedIds.length} ออร์เดอร์?`)) return; loadingOverlay.style.display = 'flex'; try { const { error } = await supabaseClient.from('orders').update({ status: 'ยกเลิก' }).in('id', selectedIds); if (error) throw error; alert('ยกเลิกออร์เดอร์สำเร็จ!'); await loadInitialData(); } catch (error) { alert(`เกิดข้อผิดพลาด: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            
            async function moveSelectedOrders(tabKey, newStatus) {
                const listContainer = container.querySelector(`#tab-${tabKey} .order-list`);
                const selectedIds = getSelectedOrderIds(listContainer);
                if (selectedIds.length === 0) {
                    return alert('กรุณาเลือกออร์เดอร์ที่ต้องการย้าย');
                }
                if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการย้าย ${selectedIds.length} ออร์เดอร์ ไปที่สถานะ "${newStatus}"?`)) {
                    return;
                }
                loadingOverlay.style.display = 'flex';
                try {
                    const { error } = await supabaseClient.from('orders').update({ status: newStatus }).in('id', selectedIds);
                    if (error) throw error;
                    alert('ย้ายสถานะออร์เดอร์สำเร็จ!');
                    await loadInitialData();
                } catch (error) {
                    alert(`เกิดข้อผิดพลาด: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            async function restoreSelectedOrders(newStatus) {
                const selectedIds = getSelectedOrderIds(container.querySelector('#tab-cancelled .order-list'));
                if (selectedIds.length === 0) {
                    return alert('กรุณาเลือกออร์เดอร์ที่ต้องการดึงกลับ');
                }
                const statusText = newStatus === 'รอลงข้อมูล' ? 'รอลงข้อมูล' : 'ลงข้อมูลเสร็จสิ้น';
                if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการดึงออร์เดอร์ ${selectedIds.length} รายการ กลับไปที่สถานะ "${statusText}"?`)) {
                    return;
                }
                loadingOverlay.style.display = 'flex';
                try {
                    const { error } = await supabaseClient.from('orders').update({ status: newStatus }).in('id', selectedIds);
                    if (error) throw error;
                    alert('ดึงออร์เดอร์กลับสำเร็จ!');
                    await loadInitialData();
                } catch (error) {
                    alert(`เกิดข้อผิดพลาด: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function selectAllInWorkOrder(buttonElement) { const billsContainer = buttonElement.closest('.work-order-bills'); const checkboxes = billsContainer.querySelectorAll('.order-checkbox'); const isAllChecked = Array.from(checkboxes).every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !isAllChecked); }
            
            async function updateWorkOrderCount(workOrderName) {
                const { count, error: countError } = await supabaseClient.from('orders').select('id', { count: 'exact', head: true }).eq('work_order_name', workOrderName);
                if (countError) {
                    console.error('Error counting remaining orders:', countError);
                    throw countError;
                }

                if (count === 0) {
                    console.log(`Work order "${workOrderName}" is empty. Updating status to 'จัดส่งแล้ว'.`);
                     const { error: updateError } = await supabaseClient.from('work_orders').update({ status: 'จัดส่งแล้ว' }).eq('work_order_name', workOrderName);
                    if (updateError) {
                         console.error('Error updating empty work order status:', updateError);
                         throw updateError;
                    }
                } else {
                    const { error: updateError } = await supabaseClient.from('work_orders').update({ order_count: count }).eq('work_order_name', workOrderName);
                     if (updateError) {
                         console.error('Error updating work order count:', updateError);
                         throw updateError;
                    }
                }
            }

            async function updatePlannerJob(workOrderName, selectedIds = []) {
                const remainingBills = allOrdersData.filter(order => order.work_order_name === workOrderName && !selectedIds.includes(String(order.id)));
                
                if (remainingBills.length > 0) {
                    const newQty = { STAMP: 0, STK: 0, CTT: 0, LASER: 0, TUBE: 0, PACK: 0 };
                    newQty.PACK = remainingBills.length;
                    remainingBills.forEach(order => {
                         (order.order_items || []).forEach(item => {
                            const product = fullProductList.find(p => p.id === item.product_id);
                            if (product && product.product_category) {
                                const category = product.product_category.toUpperCase();
                                if (category.includes('STAMP')) newQty.STAMP++;
                                if (category.includes('STK')) newQty.STK++;
                                if (category.includes('UV')) qty.CTT++;
                                if (category.includes('LASER')) qty.LASER++;
                                if (category.includes('TUBE')) qty.TUBE++;
                            }
                        });
                    });
                    const { error: updateJobError } = await supabaseClient.from('jobs').update({ qty: newQty }).eq('name', workOrderName);
                    if (updateJobError) console.error('Failed to update job qty in planner:', updateJobError);
                } else {
                    const { error: deleteJobError } = await supabaseClient.from('jobs').delete().eq('name', workOrderName);
                    if (deleteJobError) console.error('Failed to delete job from planner:', deleteJobError);
                }
            }

            async function revertSelectedBills(buttonElement, newStatus) {
                const workOrderName = buttonElement.dataset.workOrderName;
                const groupEl = buttonElement.closest('.work-order-group');
                const selectedIds = getSelectedOrderIds(groupEl);
                if (selectedIds.length === 0) return alert('กรุณาเลือกบิลที่ต้องการคืนสถานะ');
                if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการคืนสถานะ ${selectedIds.length} บิล กลับไปที่ "${newStatus}"?`)) return;
                
                loadingOverlay.style.display = 'flex';
                try {
                    const { error: updateError } = await supabaseClient.from('orders').update({ status: newStatus, work_order_name: null }).in('id', selectedIds);
                    if (updateError) throw updateError;
                    
                    await updateWorkOrderCount(workOrderName);
                    await updatePlannerJob(workOrderName, selectedIds);

                    alert('คืนสถานะบิลสำเร็จ!');
                    await loadInitialData();
                } catch (error) {
                    console.error('Error reverting bills:', error);
                    alert(`เกิดข้อผิดพลาด: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            async function cancelSelectedBillsFromWorkOrder(buttonElement) {
                const workOrderName = buttonElement.dataset.workOrderName;
                const groupEl = buttonElement.closest('.work-order-group');
                const selectedIds = getSelectedOrderIds(groupEl);
                if (selectedIds.length === 0) return alert('กรุณาเลือกบิลที่ต้องการยกเลิก');
                if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการ **ยกเลิก** ${selectedIds.length} บิล ออกจากใบงานนี้?`)) return;
                
                loadingOverlay.style.display = 'flex';
                try {
                    const { error: updateError } = await supabaseClient.from('orders').update({ status: 'ยกเลิก', work_order_name: null }).in('id', selectedIds);
                    if (updateError) throw updateError;

                    await updateWorkOrderCount(workOrderName);
                    await updatePlannerJob(workOrderName, selectedIds);
                    
                    alert('ยกเลิกบิลออกจากใบงานสำเร็จ!');
                    await loadInitialData();
                } catch (error) {
                    console.error('Error cancelling bills from work order:', error);
                    alert(`เกิดข้อผิดพลาด: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            async function cancelWorkOrder(workOrderName) {
                if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการ **ยกเลิกทั้งใบงาน** "${workOrderName}"? การกระทำนี้จะคืนสถานะบิลทั้งหมดกลับไปที่ "ลงข้อมูลเสร็จสิ้น"`)) return;
                loadingOverlay.style.display = 'flex';
                try {
                    const { error: updateError } = await supabaseClient.from('orders').update({ status: 'ลงข้อมูลเสร็จสิ้น', work_order_name: null }).eq('work_order_name', workOrderName);
                    if (updateError) throw updateError;
                    
                    const { error: deleteError } = await supabaseClient.from('work_orders').delete().eq('work_order_name', workOrderName);
                    if (deleteError) throw deleteError;

                    const { error: deleteJobError } = await supabaseClient.from('jobs').delete().eq('name', workOrderName);
                    if (deleteJobError) console.error(`Failed to delete job ${workOrderName} from planner:`, deleteJobError.message);

                    alert(`ยกเลิกใบงาน "${workOrderName}" และคืนสถานะบิลทั้งหมดเรียบร้อยแล้ว`);
                    await loadInitialData();
                } catch (error) {
                    console.error('Error cancelling work order:', error);
                    alert(`เกิดข้อผิดพลาด: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            async function saveOrUpdateOrder(status) {
                loadingOverlay.style.display = 'flex';
                const isUpdate = !!currentEditingOrderId;
                try {
                    const channelCode = container.querySelector('#channel_code').value;
                    if (!channelCode) throw new Error("กรุณาเลือกช่องทาง");
                    let billNo;
                    if (!isUpdate) {
                        billNo = await generateNextBillNo(channelCode);
                    } else {
                        const order = allOrdersData.find(o => o.id === currentEditingOrderId);
                        billNo = order.bill_no;
                    }

                    const paymentDateValue = container.querySelector('#payment_date').value;
                    const paymentTimeValue = container.querySelector('#payment_time').value;

                    const orderData = {
                        channel_code: channelCode, bill_no: billNo, status: isUpdate ? (status || allOrdersData.find(o => o.id === currentEditingOrderId).status) : status,
                        entry_date: new Date().toISOString().slice(0, 10), customer_name: container.querySelector('#customer_name').value, price: parseFloat(container.querySelector('#price').value),
                        shipping_cost: parseFloat(container.querySelector('#shipping_cost').value), discount: parseFloat(container.querySelector('#discount').value), total_amount: parseFloat(container.querySelector('#total_amount').value),
                        payment_method: container.querySelector('#payment_method').value, admin_user: adminUserInput.value, customer_address: container.querySelector('#customer_address').value, 
                        promotion: $('#promotion').val(),
                        payment_date: paymentDateValue ? paymentDateValue : null,
                        payment_time: paymentTimeValue ? paymentTimeValue : null,
                    };
                    let upsertedOrderId = currentEditingOrderId;
                    if (isUpdate) {
                        const { error } = await supabaseClient.from('orders').update(orderData).eq('id', currentEditingOrderId); if (error) throw error;
                    } else {
                        const { data: insertedOrder, error } = await supabaseClient.from('orders').insert(orderData).select().single(); if (error) throw error;
                        upsertedOrderId = insertedOrder.id;
                    }
                    await supabaseClient.from('order_items').delete().eq('order_id', upsertedOrderId);
                    
                    let allItemsToInsert = [];
                    let itemSequence = 1;
                    for (const row of itemsTbody.rows) {
                        const selectedData = $(row).find('.item-product').select2('data')[0];
                        if (!selectedData || !selectedData.id) continue;
                        
                        const originalProduct = fullProductList.find(p => p.id == selectedData.id);
                        if (!originalProduct) continue;
                        
                        const quantity = parseInt(row.querySelector('.item-quantity').value) || 1;
                        const baseItemData = { 
                            order_id: upsertedOrderId, bill_no: billNo, product_id: originalProduct.id, product_name: originalProduct.product_name, 
                            ink_color: row.querySelector('.item-ink_color').value, 
                            product_type: row.querySelector('.item-shelf_location').value, 
                            cartoon_pattern: row.querySelector('.item-cartoon_pattern').value, 
                            line_pattern: row.querySelector('.item-line_pattern').value, 
                            font: row.querySelector('.item-font').value, 
                            line_1: row.querySelector('.item-line_1').value, 
                            line_2: row.querySelector('.item-line_2').value, 
                            line_3: row.querySelector('.item-line_3').value, 
                            notes: row.querySelector('.item-notes').value, 
                            file_attachment: row.querySelector('.item-file_attachment').value 
                        };
                        for (let i = 0; i < quantity; i++) {
                            allItemsToInsert.push({ ...baseItemData, item_uid: `${billNo}-${itemSequence++}` }); 
                        }
                    }
                    if (allItemsToInsert.length > 0) { const { error: itemsError } = await supabaseClient.from('order_items').insert(allItemsToInsert); if (itemsError) throw itemsError; }
                    alert(isUpdate ? 'อัปเดตข้อมูลสำเร็จ!' : `บันทึกออร์เดอร์สำเร็จ! เลขบิล: ${billNo}`);
                    await loadInitialData(); setFormMode('create');
                } catch (error) { console.error('Error saving/updating order:', error); alert(`เกิดข้อผิดพลาด: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; }
            }
            
            function enterTrackingEditMode(trackingSpan) {
                const trackingTextEl = trackingSpan.querySelector('.tracking-text');
                const currentTracking = trackingTextEl ? trackingTextEl.textContent : '';
                trackingSpan.dataset.originalHtml = trackingSpan.innerHTML;

                trackingSpan.innerHTML = `
                    <div class="tracking-edit-container">
                        <input type="text" class="tracking-input" value="${currentTracking}">
                        <button class="btn btn-sm btn-success btn-save-tracking-confirm">✓</button>
                        <button class="btn btn-sm btn-secondary btn-cancel-tracking-edit">X</button>
                    </div>
                `;
                trackingSpan.querySelector('.tracking-input').focus();
            }

            function exitTrackingEditMode(trackingSpan, newTrackingNumber = null) {
                const orderItem = trackingSpan.closest('.order-list-item');
                const originalTrackingNumber = allOrdersData.find(o => o.id == orderItem.dataset.orderId).tracking_number;
                
                let finalTrackingNumber = originalTrackingNumber;
                if (newTrackingNumber !== null) {
                     finalTrackingNumber = newTrackingNumber;
                }
               
                trackingSpan.innerHTML = `<span class="tracking-text">${finalTrackingNumber}</span> <button class="btn btn-sm btn-edit-tracking" title="แก้ไขเลขพัสดุ">✏️</button>`;
            }

            async function saveTrackingNumber(trackingSpan) {
                const orderItem = trackingSpan.closest('.order-list-item');
                const orderId = orderItem.dataset.orderId;
                const newTrackingNumber = trackingSpan.querySelector('.tracking-input').value.trim();

                if (!newTrackingNumber) {
                    alert('เลขพัสดุไม่สามารถเป็นค่าว่างได้');
                    return;
                }
                loadingOverlay.style.display = 'flex';
                try {
                    const { error } = await supabaseClient
                        .from('orders')
                        .update({ tracking_number: newTrackingNumber })
                        .eq('id', orderId);
                    
                    if (error) throw error;
                    const orderToUpdate = allOrdersData.find(o => o.id == orderId);
                    if(orderToUpdate) orderToUpdate.tracking_number = newTrackingNumber;
                    
                    exitTrackingEditMode(trackingSpan, newTrackingNumber);
                    alert('อัปเดตเลขพัสดุสำเร็จ!');
                } catch (error) {
                    console.error('Error updating tracking number:', error);
                    alert('เกิดข้อผิดพลาดในการอัปเดต: ' + error.message);
                    exitTrackingEditMode(trackingSpan);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            async function generateNextBillNo(channelCode) {
                const today = new Date();
                const year = String(today.getFullYear() + 543).slice(-2);
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const prefix = `${channelCode}${year}${month}`;

                const { data, error } = await supabaseClient
                    .from('orders')
                    .select('bill_no')
                    .like('bill_no', `${prefix}%`)
                    .order('bill_no', { ascending: false })
                    .limit(1);

                if (error) {
                    throw new Error(`ไม่สามารถค้นหาเลขบิลล่าสุดได้: ${error.message}`);
                }

                let nextSequence = 1;
                if (data.length > 0) {
                    const lastBillNo = data[0].bill_no;
                    const lastSequence = parseInt(lastBillNo.slice(prefix.length), 10);
                    if (!isNaN(lastSequence)) {
                        nextSequence = lastSequence + 1;
                    }
                }
                
                return `${prefix}${String(nextSequence).padStart(5, '0')}`;
            }

            function calculateTotal() { const price = parseFloat(container.querySelector('#price').value) || 0; const shipping = parseFloat(container.querySelector('#shipping_cost').value) || 0; const discount = parseFloat(container.querySelector('#discount').value) || 0; container.querySelector('#total_amount').value = (price + shipping - discount).toFixed(2); }
            
            function exportForProduction(workOrderName) {
                const ordersInWorkOrder = allOrdersData.filter(order => order.work_order_name === workOrderName);
                if (ordersInWorkOrder.length === 0) {
                    alert("ไม่พบข้อมูลออร์เดอร์ในใบงานนี้");
                    return;
                }

                const headers = ['ชื่อใบงาน', 'เลขบิล', 'Item UID', 'ชื่อสินค้า', 'ชั้นที่', 'สีหมึก', 'ลายการ์ตูน', 'ลายเส้น', 'ฟอนต์', 'บรรทัด 1', 'บรรทัด 2', 'บรรทัด 3', 'จำนวน', 'หมายเหตุ', 'ไฟล์แนบ'];
                const dataToExport = [];

                ordersInWorkOrder.forEach(order => {
                    if (order.order_items && order.order_items.length > 0) {
                        order.order_items.forEach(item => {
                            dataToExport.push([
                                workOrderName,
                                item.bill_no,
                                item.item_uid,
                                item.product_name,
                                item.product_type,
                                item.ink_color,
                                item.cartoon_pattern,
                                item.line_pattern,
                                item.font,
                                item.line_1,
                                item.line_2,
                                item.line_3,
                                1, 
                                item.notes,
                                item.file_attachment
                            ]);
                        });
                    }
                });
                
                if (dataToExport.length === 0) {
                    alert("ไม่พบรายการสินค้าสำหรับ Export ในใบงานนี้");
                    return;
                }

                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "ProductionData");
                XLSX.writeFile(workbook, `Production_${workOrderName}.xlsx`);
            }
            
            function attachFormActionListeners(order) {
                const idMap = {
                    'save-waiting-btn': () => saveOrUpdateOrder('รอลงข้อมูล'),
                    'save-complete-btn': () => saveOrUpdateOrder('ลงข้อมูลเสร็จสิ้น'),
                    'update-waiting-btn': () => saveOrUpdateOrder('รอลงข้อมูล'),
                    'move-to-complete-btn': () => saveOrUpdateOrder('ลงข้อมูลเสร็จสิ้น'),
                    'update-complete-btn': () => saveOrUpdateOrder(null),
                    'cancel-bill-btn': () => moveOrder(order.id, 'ยกเลิก')
                };
                for(const id in idMap) {
                    const btn = document.getElementById(id);
                    if (btn) btn.addEventListener('click', idMap[id]);
                }
            }

            function checkAndApplyStampInkLogic(rowElement) {
                const linkedInkRowUid = rowElement.dataset.linkedInkRowUid;
                if (linkedInkRowUid) {
                    const oldInkRow = itemsTbody.querySelector(`tr[data-row-uid="${linkedInkRowUid}"]`);
                    if (oldInkRow) {
                        $(oldInkRow).find('.item-product').select2('destroy');
                        oldInkRow.remove();
                    }
                }
                rowElement.removeAttribute('data-linked-ink-row-uid');

                const productId = $(rowElement).find('.item-product').val();
                const inkColor = $(rowElement).find('.item-ink_color').val();
                const product = fullProductList.find(p => p.id == productId);

                if (!product || !product.product_category || !product.product_category.toUpperCase().includes('STAMP')) {
                    return;
                }

                const targetColors = { 'เขียว': 'เขียว', 'ดำ': 'ดำ', 'แดง': 'แดง', 'น้ำเงิน': 'น้ำเงิน' };
                const matchedColor = Object.keys(targetColors).find(c => inkColor.includes(c) && inkColor.includes('พลาสติก'));
                if (!matchedColor) {
                    return;
                }

                const inkProductName = `หมึกแฟลชพลาสติก 5 ml. (${matchedColor})`;
                const inkProductToAdd = fullProductList.find(p => p.product_name === inkProductName);
                
                if (!inkProductToAdd) {
                    console.warn(`Could not find product to auto-add: ${inkProductName}`);
                    return;
                }
                
                const newInkRowUid = 'ink-' + Date.now() + Math.random();
                const newInkRow = addItemRow({ product_id: inkProductToAdd.id, quantity: 1 }, newInkRowUid);
                newInkRow.dataset.isAutoAdded = "true";
                newInkRow.style.backgroundColor = '#f0fff0';
                rowElement.dataset.linkedInkRowUid = newInkRowUid;
            }

            function handleCondoStampExpansion(changedRow) {
                if (changedRow.dataset.isCondoPart) {
                    return;
                }
                const productId = $(changedRow).find('.item-product').val();
                if (!productId) return;
                const product = fullProductList.find(p => p.id == productId);

                if (product && product.product_category && product.product_category.trim().toUpperCase() === 'CONDO STAMP') {
                    if (window.isExpandingCondo) return;
                    window.isExpandingCondo = true;

                    const templateItem = { product_id: product.id };

                    changedRow.querySelector('.item-shelf_location').value = '1';
                    changedRow.dataset.isCondoPart = 'true';
                    const qtyInput = changedRow.querySelector('.item-quantity');
                    qtyInput.value = 1;
                    qtyInput.readOnly = true;

                    for (let i = 2; i <= 5; i++) {
                        const newItemRow = addItemRow(templateItem);
                        newItemRow.querySelector('.item-shelf_location').value = i.toString();
                        newItemRow.dataset.isCondoPart = 'true';
                        const newQtyInput = newItemRow.querySelector('.item-quantity');
                        newQtyInput.value = 1;
                        newQtyInput.readOnly = true;
                    }
                    
                    setTimeout(() => { window.isExpandingCondo = false; }, 100);
                }
            }

            function showPickingSlipModal(workOrderName) {
                const modal = document.getElementById('picking-slip-modal');
                const modalTitle = document.getElementById('picking-slip-modal-title');
                const previewContainer = document.getElementById('picking-slip-preview');
                const pngContainer = document.getElementById('picking-slip-png-container');

                modalTitle.textContent = `ใบเบิกสินค้า: ${workOrderName}`;
                
                const itemsInWorkOrder = [];
                allOrdersData.forEach(order => {
                    if (order.work_order_name === workOrderName && order.order_items) {
                        order.order_items.forEach(item => {
                            const fullProduct = fullProductList.find(p => p.id === item.product_id);
                            itemsInWorkOrder.push({ ...item, ...fullProduct });
                        });
                    }
                });

                if (itemsInWorkOrder.length === 0) {
                    alert('ไม่พบรายการสินค้าในใบงานนี้');
                    return;
                }
                
                const mainItemsAggregated = {};
                const excludedCategories = ['UV', 'STK', 'TUBE'];
                itemsInWorkOrder
                    .filter(item => item.product_category && !excludedCategories.some(cat => item.product_category.toUpperCase().includes(cat)))
                    .forEach(item => {
                        const key = item.product_id;
                        if (!mainItemsAggregated[key]) {
                            mainItemsAggregated[key] = {
                                name: item.product_name,
                                code: item.product_code,
                                location: item.storage_location || 'N/A',
                                category: item.product_category,
                                qty: 0
                            };
                        }
                        mainItemsAggregated[key].qty += 1;
                    });
                
                for (const key in mainItemsAggregated) {
                    const item = mainItemsAggregated[key];
                    if (item.category && item.category.trim().toUpperCase() === 'CONDO STAMP') {
                        item.qty = Math.ceil(item.qty / 5);
                    }
                }

                const mainItems = Object.values(mainItemsAggregated).sort((a, b) => a.location.localeCompare(b.location));
                
                const sparePartsAggregated = {};
                itemsInWorkOrder
                    .filter(item => item.rubber_code)
                    .forEach(item => {
                        const key = item.rubber_code;
                        if (!sparePartsAggregated[key]) {
                            sparePartsAggregated[key] = {
                                name: `หน้ายาง+โฟม ${item.rubber_code}`,
                                qty: 0
                            };
                        }
                        sparePartsAggregated[key].qty += 1;
                    });

                const spareParts = Object.values(sparePartsAggregated);
                
                const today = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const picker = loggedInUsername || '';
                
                let mainItemsHtml = '<h3>รายการสินค้าหลัก</h3><table><thead><tr><th>จุดจัดเก็บ</th><th>รหัสสินค้า</th><th>รายการสินค้า</th><th>จำนวนเบิก</th></tr></thead><tbody>';
                mainItems.forEach(item => { mainItemsHtml += `<tr><td>${item.location}</td><td>${item.code}</td><td>${item.name}</td><td>${item.qty}</td></tr>`; });
                mainItemsHtml += '</tbody></table>';

                let sparePartsHtml = spareParts.length > 0 ? '<h3>รายการอะไหล่</h3><table><thead><tr><th>รายการอะไหล่</th><th>จำนวนอะไหล่</th></tr></thead><tbody>' : '';
                if(spareParts.length > 0) {
                    spareParts.forEach(part => { sparePartsHtml += `<tr><td>${part.name}</td><td>${part.qty}</td></tr>`; });
                    sparePartsHtml += '</tbody></table>';
                }
                
                previewContainer.innerHTML = mainItemsHtml + sparePartsHtml;
                
                const pngHeaderHtml = `
                    <div class="png-header">
                        <div class="png-header-box"><b>เพจ:</b> ${workOrderName.split('-')[0]} <b>รอบ:</b> ${workOrderName.split('-')[2].replace('R','')}</div>
                        <div class="png-header-box"><b>วันที่เบิก:</b> ${today}</div>
                    </div>`;

                const pngMainTable = `<table>
                                        <thead><tr><th>จุดจัดเก็บ</th><th>รหัสสินค้า</th><th>รายการสินค้า</th><th>จำนวนเบิก</th></tr></thead>
                                        <tbody>${mainItems.map(item => `<tr><td>${item.location}</td><td>${item.code}</td><td>${item.name}</td><td style="text-align:center;">${item.qty}</td></tr>`).join('')}</tbody>
                                      </table>`;
                const pngSpareTable = spareParts.length > 0 ? `<table>
                                        <thead><tr><th>รายการอะไหล่</th><th>จำนวนอะไหล่</th></tr></thead>
                                        <tbody>${spareParts.map(part => `<tr><td>${part.name}</td><td style="text-align:center;">${part.qty}</td></tr>`).join('')}</tbody>
                                       </table>` : '';
                
                const pngSignatureHtml = `
                    <div class="png-signature-boxes">
                        <div class="png-signature-box"><div class="title">ผู้เบิก</div><div class="space">${picker}</div></div>
                        <div class="png-signature-box"><div class="title">ผู้จ่าย</div><div class="space"></div></div>
                        <div class="png-signature-box"><div class="title">ผู้รับ</div><div class="space"></div></div>
                    </div>`;

                const pngFooterHtml = `<div class="png-footer">Page 1 of 1</div>`;

                pngContainer.innerHTML = `<div class="png-body">${pngHeaderHtml}${pngMainTable}${pngSpareTable}</div>${pngSignatureHtml}${pngFooterHtml}`;
                
                document.getElementById('export-picking-slip-png-btn').onclick = () => exportPickingSlipAsPNG(workOrderName);
                document.getElementById('export-picking-slip-csv-btn').onclick = () => exportPickingSlipAsCSV(workOrderName);
                
                modal.style.display = 'flex';
            }

            function hidePickingSlipModal() {
                document.getElementById('picking-slip-modal').style.display = 'none';
            }

            function exportPickingSlipAsPNG(workOrderName) {
                const element = document.getElementById("picking-slip-png-container");
                loadingOverlay.style.display = 'flex';
                html2canvas(element, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `ใบเบิก_${workOrderName}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    loadingOverlay.style.display = 'none';
                }).catch(err => {
                    console.error('Error generating PNG:', err);
                    alert('เกิดข้อผิดพลาดในการสร้างไฟล์ PNG');
                    loadingOverlay.style.display = 'none';
                });
            }

            function exportPickingSlipAsCSV(workOrderName) {
                const headers = ['รหัสทำรายการ', 'รหัสสินค้า', 'รายการสินค้า', 'จำนวนเบิก'];
                
                const itemsInWorkOrder = [];
                allOrdersData.forEach(order => {
                    if (order.work_order_name === workOrderName && order.order_items) {
                        order.order_items.forEach(item => {
                            const fullProduct = fullProductList.find(p => p.id === item.product_id);
                            itemsInWorkOrder.push({
                                transactionCode: workOrderName, 
                                productCode: fullProduct ? fullProduct.product_code : 'N/A',
                                productName: item.product_name,
                                quantity: 1,
                                category: fullProduct ? fullProduct.product_category : ''
                            });
                        });
                    }
                });

                if (itemsInWorkOrder.length === 0) {
                    alert('ไม่พบข้อมูลสำหรับ Export');
                    return;
                }
                
                const aggregatedItems = {};
                itemsInWorkOrder.forEach(item => {
                    const key = item.productCode; 
                    if (!aggregatedItems[key]) {
                       aggregatedItems[key] = { ...item, quantity: 0 };
                    }
                    aggregatedItems[key].quantity += 1;
                });

                Object.values(aggregatedItems).forEach(item => {
                    if (item.category && item.category.trim().toUpperCase() === 'CONDO STAMP') {
                        item.quantity = Math.ceil(item.quantity / 5);
                    }
                });

                const finalRows = Object.values(aggregatedItems);

                const escapeCsv = (field) => {
                    const str = String(field || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                const csvContent = [
                    headers.join(','),
                    ...finalRows.map(row => [
                        escapeCsv(row.transactionCode),
                        escapeCsv(row.productCode),
                        escapeCsv(row.productName),
                        escapeCsv(row.quantity)
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${workOrderName}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function initializeEventListeners() {
                trackingFileInput.addEventListener('change', (e) => handleTrackingImport(e.target.files[0]));
                
                container.querySelector('#channel_code').addEventListener('change', (e) => {
                    updateAllFontDropdowns(e.target.value);
                });

                itemsTbody.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = (e.clipboardData || window.clipboardData).getData('text');
                    const rowsData = pasteData.split(/[\r\n]+/).filter(row => row.trim() !== '');
                    let targetCell = e.target.closest('td'); 
                    if (!targetCell) return;
                    
                    let startRowIndex = Array.from(itemsTbody.children).indexOf(targetCell.parentElement);
                    let startCellIndex = targetCell.cellIndex;
                    const modifiedRows = []; 

                    rowsData.forEach((rowData, rowIndex) => {
                        const cellsData = rowData.split('\t'); 
                        let currentRow; 
                        const currentRowIndex = startRowIndex + rowIndex;
                        
                        if (currentRowIndex >= itemsTbody.rows.length) { 
                           if (itemsTbody.rows.length === 1 && $(itemsTbody.rows[0]).find('.item-product').val() === null) {
                               currentRow = itemsTbody.rows[0];
                           } else {
                               currentRow = addItemRow();
                           }
                        } else {
                           currentRow = itemsTbody.rows[currentRowIndex];
                        }
                        if (!currentRow) return;

                        cellsData.forEach((cellData, cellIndex) => {
                            const targetCellIndex = startCellIndex + cellIndex;
                            if (targetCellIndex < currentRow.cells.length - 1) { 
                                const input = currentRow.cells[targetCellIndex].querySelector('input, select');
                                if (input) {
                                    if (input.classList.contains('item-product')) {
                                        const pastedValue = cellData.trim().toLowerCase();
                                        const product = fullProductList.find(p => p.product_code.toLowerCase() === pastedValue || p.product_name.toLowerCase() === pastedValue);
                                        if (product) {
                                            $(input).val(product.id).trigger('change.select2');
                                        } else {
                                            $(input).val(null).trigger('change.select2');
                                        }
                                    } else if (input.tagName === 'SELECT') {
                                        const trimmedCellData = cellData.trim().toLowerCase();
                                        const matchedOption = [...input.options].find(opt => opt.text.toLowerCase() === trimmedCellData || opt.value.toLowerCase() === trimmedCellData);
                                        if (matchedOption) {
                                            input.value = matchedOption.value;
                                        }
                                    } else { 
                                        input.value = cellData.trim(); 
                                    }
                                }
                            }
                        });
                        modifiedRows.push(currentRow); 
                    });

                    modifiedRows.forEach(row => {
                        if (row) {
                           checkAndApplyStampInkLogic(row);
                        }
                    });
                });

                container.addEventListener('click', (event) => {
                    const target = event.target;
                    
                    if (target.tagName === 'STRONG' && target.closest('.order-list-item')) {
                        const orderId = target.closest('.order-list-item').dataset.orderId;
                        if (orderId) {
                            loadOrderForEditing(orderId);
                        }
                    }
                    
                    const trackingSpan = target.closest('.order-tracking');
                    if (trackingSpan) {
                         if (target.closest('.btn-edit-tracking')) {
                            event.stopPropagation();
                            event.preventDefault();
                            enterTrackingEditMode(trackingSpan);
                        }
                        if (target.closest('.btn-save-tracking-confirm')) {
                            event.stopPropagation();
                            event.preventDefault();
                            saveTrackingNumber(trackingSpan);
                        }
                        if (target.closest('.btn-cancel-tracking-edit')) {
                            event.stopPropagation();
                            event.preventDefault();
                            exitTrackingEditMode(trackingSpan);
                        }
                    }

                    const header = target.closest('.work-order-header');
                    if (header) {
                         const classToAction = {
                            'picking-slip-btn': (btn) => showPickingSlipModal(btn.dataset.workOrderName),
                            'export-production-btn': (btn) => exportForProduction(btn.dataset.workOrderName),
                            'prepare-waybill-btn': (btn) => prepareForWaybill(btn.dataset.workOrderName),
                            'import-wo-csv-btn': () => trackingFileInput.click(),
                            'cancel-wo-btn': (btn) => cancelWorkOrder(btn.dataset.workOrderName)
                        };

                        let actionFound = false;
                        for (const className in classToAction) {
                            const btn = target.closest(`.${className}`);
                            if (btn) {
                                event.stopPropagation();
                                classToAction[className](btn);
                                actionFound = true;
                                break;
                            }
                        }
                        if (!actionFound) {
                            toggleWorkOrder(header);
                        }
                    }
                    
                    const billsContainer = target.closest('.work-order-bills');
                    if(billsContainer) {
                         const classToAction = {
                            'select-all-in-wo-btn': (btn) => selectAllInWorkOrder(btn),
                            'revert-to-waiting-btn': (btn) => revertSelectedBills(btn, 'รอลงข้อมูล'),
                            'revert-to-complete-btn': (btn) => revertSelectedBills(btn, 'ลงข้อมูลเสร็จสิ้น'),
                            'cancel-bills-from-wo-btn': (btn) => cancelSelectedBillsFromWorkOrder(btn)
                        };
                         for (const className in classToAction) {
                            const btn = target.closest(`.${className}`);
                            if (btn) {
                                classToAction[className](btn);
                                break;
                            }
                        }
                    }
                });

                addItemBtn.addEventListener('click', () => addItemRow());

                $(itemsTbody).on('select2:select', '.item-product', function(e) {
                    const row = e.target.closest('tr');
                    if (!row.dataset.isAutoAdded) {
                        handleCondoStampExpansion(row);
                        checkAndApplyStampInkLogic(row);
                    }
                });
                
                itemsTbody.addEventListener('change', (e) => {
                    if (e.target.classList.contains('item-ink_color')) {
                        const row = e.target.closest('tr');
                        if (!row.dataset.isAutoAdded) {
                            checkAndApplyStampInkLogic(row);
                        }
                    }
                });

                itemsTbody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-item-btn')) {
                        const rowToRemove = e.target.closest('tr');
                        const linkedInkRowUid = rowToRemove.dataset.linkedInkRowUid;

                        if (linkedInkRowUid) {
                            const inkRow = itemsTbody.querySelector(`tr[data-row-uid="${linkedInkRowUid}"]`);
                            if (inkRow) {
                                $(inkRow).find('.item-product').select2('destroy');
                                inkRow.remove();
                            }
                        }
                        
                        $(rowToRemove).find('.item-product').select2('destroy');
                        rowToRemove.remove();
                    }
                });
                
                const pickingSlipModal = document.getElementById('picking-slip-modal');
                document.getElementById('cancel-picking-slip-modal-btn').addEventListener('click', hidePickingSlipModal);
                pickingSlipModal.addEventListener('click', (e) => {
                    if (e.target === pickingSlipModal) hidePickingSlipModal();
                });

                [container.querySelector('#price'), container.querySelector('#shipping_cost'), container.querySelector('#discount')].forEach(input => input.addEventListener('input', calculateTotal));
                tabLinks.forEach(link => { link.addEventListener('click', (e) => openTab(e, e.target.dataset.tab)); });
                
                ['filter-waiting', 'filter-complete', 'filter-cancelled', 'filter-shipped'].forEach(id => { const el = container.querySelector(`#${id}`); if (el) el.addEventListener('change', renderAllTabs); });
                ['search-waiting', 'search-complete', 'search-shipped', 'search-cancelled'].forEach(id => {
                    const el = container.querySelector(`#${id}`);
                    if (el) el.addEventListener('input', renderAllTabs);
                });
                
                downloadTemplateBtn.addEventListener('click', downloadOrderTemplate);
                importOrdersBtn.addEventListener('click', () => importOrdersFileInput.click());
                importOrdersFileInput.addEventListener('change', (e) => handleSmartImport(e.target.files[0]));
                
                document.getElementById('move-to-waiting-btn').addEventListener('click', () => moveSelectedOrders('complete', 'รอลงข้อมูล'));
                document.getElementById('move-to-complete-from-waiting-btn').addEventListener('click', () => moveSelectedOrders('waiting', 'ลงข้อมูลเสร็จสิ้น'));
                document.getElementById('select-all-waiting-btn').addEventListener('click', () => selectAll('waiting'));
                document.getElementById('cancel-selected-waiting-btn').addEventListener('click', () => cancelSelectedOrders('waiting'));
                document.getElementById('select-all-complete-btn').addEventListener('click', () => selectAll('complete'));
                document.getElementById('create-work-order-btn').addEventListener('click', createWorkOrder);
                document.getElementById('cancel-selected-complete-btn').addEventListener('click', () => cancelSelectedOrders('complete'));
                document.getElementById('select-all-shipped-btn').addEventListener('click', () => selectAll('shipped'));
                document.getElementById('select-all-cancelled-btn').addEventListener('click', () => selectAll('cancelled'));
                document.getElementById('restore-to-waiting-btn').addEventListener('click', () => restoreSelectedOrders('รอลงข้อมูล'));
                document.getElementById('restore-to-complete-btn').addEventListener('click', () => restoreSelectedOrders('ลงข้อมูลเสร็จสิ้น'));
            }

            return { initializeApp, loadInitialData };
        })();

        // --- PACKING SYSTEM MODULE ---
        window.packingSystem = (() => {
            const container = document.getElementById("packing-system-container");
            const selectionView = container.querySelector("#work-order-selection-view");
            const workOrderList = container.querySelector("#work-order-list");
            const mainView = container.querySelector("#packing-main-view");
            const exportBtn = container.querySelector("#export-all-button");
            const resetBtn = container.querySelector("#reset-packing-btn");
            const searchInput = container.querySelector("#search-input");
            const orderList = container.querySelector("#order-list");
            const orderCounter = container.querySelector("#order-counter");
            const resultContainer = container.querySelector("#result-container");
            const actionPanel = container.querySelector("#action-panel");
            const itemScanInput = container.querySelector("#item-scan-input");
            const confirmationInput = container.querySelector("#confirmation-input");
            const statusMessage = container.querySelector("#status-message");
            const successSound = container.querySelector("#success-sound");
            const errorSound = container.querySelector("#error-sound");
            const headerTitle = container.querySelector("#packing-header-title");
            const backBtn = container.querySelector("#back-to-wo-selection");

            let allOrdersForPacking = [];
            let aggregatedData = [];
            let completedIndices = new Set();
            let currentIndex = -1;
            let currentWorkOrderName = null;
            let packingState = {}; // To hold the state of packing

            // --- STATE MANAGEMENT ---
            function savePackingState() {
                try {
                    sessionStorage.setItem('packingState', JSON.stringify(packingState));
                } catch (e) {
                    console.error('Failed to save packing state:', e);
                }
            }

            function loadPackingState() {
                try {
                    const savedState = sessionStorage.getItem('packingState');
                    if (savedState) {
                        packingState = JSON.parse(savedState);
                    } else {
                        packingState = {};
                    }
                } catch (e) {
                    console.error('Failed to load packing state:', e);
                    packingState = {};
                }
            }
            // ------------------------

            async function loadWorkOrdersForPacking() {
                loadPackingState(); // Load state on view entry
                showPackingView("selection");
                workOrderList.innerHTML = "<li>กำลังโหลดใบงาน...</li>";
                const { data, error } = await supabaseClient.from("work_orders").select("*").eq('status', 'กำลังผลิต').order("created_at", { ascending: false });
                if (error) { workOrderList.innerHTML = "<li>เกิดข้อผิดพลาดในการโหลดใบงาน</li>"; return; }
                if (!data || data.length === 0) { workOrderList.innerHTML = "<li>ไม่พบใบงานที่อยู่ในสถานะกำลังผลิต</li>"; return; }
                workOrderList.innerHTML = "";
                data.forEach(wo => {
                    const li = document.createElement("li");
                    li.className = "work-order-item";
                    const btn = document.createElement("button");
                    btn.textContent = `${wo.work_order_name} (${wo.order_count} บิล)`;
                    btn.dataset.workOrderName = wo.work_order_name;
                    btn.addEventListener("click", () => loadPackingData(wo.work_order_name));
                    li.appendChild(btn);
                    workOrderList.appendChild(li);
                });
            }

            async function loadPackingData(workOrderName) {
                loadingOverlay.style.display = "flex";
                
                if(currentWorkOrderName !== workOrderName) {
                    packingState[workOrderName] = packingState[workOrderName] || { completedIndices: [], items: {} };
                }
                currentWorkOrderName = workOrderName;

                const { data, error } = await supabaseClient.from("orders").select("*, order_items(*)").eq("work_order_name", workOrderName);
                loadingOverlay.style.display = "none";
                if (error) { alert("ไม่สามารถดึงข้อมูลออร์เดอร์ของใบงานนี้ได้: " + error.message); return; }
                
                const ordersWithTracking = data.filter(order => order.tracking_number && order.tracking_number.trim() !== "");
                
                if (data.length > 0 && ordersWithTracking.length === 0) {
                    alert("ใบงานนี้ยังไม่มีการนำเข้าเลขพัสดุ กรุณานำเข้าเลขพัสดุก่อน"); return;
                }
                if (data.length > ordersWithTracking.length) {
                    alert(`มี ${data.length - ordersWithTracking.length} ออร์เดอร์ในใบงานนี้ยังไม่มีเลขพัสดุ จะไม่ถูกนำมาแสดงในรายการแพ็ค`);
                }

                prepareDataForPacking(ordersWithTracking);
                
                if (aggregatedData.length > 0) {
                    headerTitle.textContent = `จัดของใบงาน: ${workOrderName}`;
                    showPackingView("main");
                    renderOrderNav();
                    const nextIndex = aggregatedData.findIndex((_, i) => !completedIndices.has(i));
                    displayOrder(nextIndex !== -1 ? nextIndex : 0);
                    exportBtn.disabled = false;
                } else {
                    alert("ไม่พบออร์เดอร์ที่มีเลขพัสดุสำหรับจัดในใบงานนี้");
                }
            }

            async function finalizeWorkOrderAndMoveStatus(workOrderName) {
                loadingOverlay.style.display = 'flex';
                try {
                    const { error: updateOrdersError } = await supabaseClient
                        .from('orders')
                        .update({ status: 'จัดส่งแล้ว' })
                        .eq('work_order_name', workOrderName);
                    if (updateOrdersError) throw updateOrdersError;

                    const { error: updateWOError } = await supabaseClient
                        .from('work_orders')
                        .update({ status: 'จัดส่งแล้ว' })
                        .eq('work_order_name', workOrderName);
                    if (updateWOError) throw updateWOError;
                    
                    delete packingState[workOrderName];
                    savePackingState();
                    
                    alert(`ย้ายใบงาน "${workOrderName}" ไปยังสถานะ "จัดส่งแล้ว" สำเร็จ!`);
                    await window.orderSystem.loadInitialData();
                } catch (err) {
                    alert('เกิดข้อผิดพลาดในการย้ายสถานะ: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                    showPackingView('selection');
                }
            }
            
            function prepareDataForPacking(orders) {
                let flatData = [];
                const woState = packingState[currentWorkOrderName] || { completedIndices: [], items: {} };
                completedIndices = new Set(woState.completedIndices);
                
                orders.forEach(order => {
                    if (order.order_items && order.order_items.length > 0) {
                        order.order_items.forEach(item => {
                            const isScanned = item.packing_status === 'สแกนแล้ว' || (woState.items[item.item_uid] ? woState.items[item.item_uid].scanned : false);
                            const scanTime = item.item_scan_time || (woState.items[item.item_uid] ? woState.items[item.item_uid].itemScanTime : "");
                             if (isScanned && !woState.items[item.item_uid]) {
                                if(!packingState[currentWorkOrderName]) packingState[currentWorkOrderName] = { completedIndices: [], items: {} };
                                packingState[currentWorkOrderName].items[item.item_uid] = { scanned: true, itemScanTime: scanTime };
                                savePackingState();
                            }

                            flatData.push({
                                'tracking_number': order.tracking_number,
                                'customer_name': order.customer_name,
                                'order_id': order.id,
                                'product_name': item.product_name, 
                                'details': [item.line_1, item.line_2, item.line_3].filter(Boolean).join(" // "), 
                                'font': item.font,
                                'ink_color': item.ink_color, 
                                'notes': item.notes,
                                'shelf_location': item.product_type,
                                'cartoon_pattern': item.cartoon_pattern,
                                'line_pattern': item.line_pattern,
                                'file_attachment': item.file_attachment,
                                'item_uid': item.item_uid,
                                scanned: isScanned, 
                                'itemScanTime': scanTime
                            });
                        });
                    }
                });
                
                allOrdersForPacking = flatData;
                const groupedByTracking = {};
                allOrdersForPacking.forEach(item => {
                    const tracking = item.tracking_number;
                    if (!groupedByTracking[tracking]) groupedByTracking[tracking] = [];
                    groupedByTracking[tracking].push(item);
                });
                
                aggregatedData = Object.values(groupedByTracking);
                currentIndex = -1;
                searchInput.value = '';
            }

            function renderOrderNav() {
                orderList.innerHTML = "";
                aggregatedData.forEach((group, index) => {
                    const trackingId = String(group[0].tracking_number).trim();
                    const isCompleted = completedIndices.has(index);
                    const li = document.createElement("li");
                    li.className = "order-item";
                    if (isCompleted) li.classList.add("completed");
                    li.dataset.index = index;
                    li.dataset.trackingId = trackingId;
                    li.innerHTML = `<span class="tracking-id">${isCompleted ? '✅' : '📦'} ${trackingId}</span><span class="customer-name">${group[0].customer_name || 'N/A'}</span>`;
                    li.addEventListener("click", () => displayOrder(index));
                    orderList.appendChild(li);
                });
                updateCounter();
            }
            
            function displayOrder(index) {
                if (index < 0 || index >= aggregatedData.length) return;
                currentIndex = index;
                const orderGroup = aggregatedData[index];

                // Sort items by Item UID before rendering
                orderGroup.sort((a, b) => (a.item_uid || '').localeCompare(b.item_uid || ''));
                
                let headerHTML = `<h2>เลขพัสดุ: ${orderGroup[0].tracking_number}</h2><p><strong>ลูกค้า:</strong> ${orderGroup[0].customer_name}</p>`;
                let tableHTML = `<table><thead><tr>
                        <th>Item UID</th><th>ชื่อสินค้า</th><th>รายละเอียด</th><th>สีหมึก</th><th>ชั้นที่</th><th>ลายการ์ตูน</th>
                        <th>ลายเส้น</th><th>ฟอนต์</th><th>หมายเหตุ</th><th>ไฟล์แนบ</th>
                    </tr></thead><tbody>`;
                
                orderGroup.forEach(item => {
                    tableHTML += `<tr class="${item.scanned ? 'item-scanned' : ''}" data-item-uid="${item.item_uid}">
                        <td><strong>${item.item_uid || ''}</strong></td>
                        <td>${item.product_name || ''}</td>
                        <td>${item.details || ''}</td>
                        <td>${item.ink_color || ''}</td>
                        <td>${item.shelf_location || ''}</td>
                        <td>${item.cartoon_pattern || ''}</td>
                        <td>${item.line_pattern || ''}</td>
                        <td>${item.font || ''}</td>
                        <td>${item.notes || ''}</td>
                        <td>${item.file_attachment || ''}</td>
                    </tr>`;
                });
                tableHTML += "</tbody></table>";
                resultContainer.innerHTML = headerHTML + tableHTML;

                actionPanel.style.display = "block";
                confirmationInput.value = "";
                updateInputStates();
                updateActiveNavItem();
            }

            async function resetCurrentOrderPacking() {
                if (currentIndex < 0 || !currentWorkOrderName) return;
                if (!confirm('คุณต้องการรีเซ็ตการแพ็คสำหรับออร์เดอร์นี้ (แพ็คใหม่) หรือไม่?')) return;

                loadingOverlay.style.display = 'flex';
                try {
                    const currentOrderGroup = aggregatedData[currentIndex];
                    const itemUidsToReset = currentOrderGroup.map(item => item.item_uid);

                    // Update database
                    const { error } = await supabaseClient
                        .from('order_items')
                        .update({ packing_status: null, item_scan_time: null })
                        .in('item_uid', itemUidsToReset);
                    
                    if (error) throw error;

                    // Update local state
                    currentOrderGroup.forEach(item => {
                        item.scanned = false;
                        item.itemScanTime = null;
                        if (packingState[currentWorkOrderName] && packingState[currentWorkOrderName].items) {
                            delete packingState[currentWorkOrderName].items[item.item_uid];
                        }
                    });
                    savePackingState();

                    alert('รีเซ็ตการแพ็คสำหรับออร์เดอร์นี้เรียบร้อย');
                    displayOrder(currentIndex); // This will re-render with sorted items

                } catch (err) {
                    alert('เกิดข้อผิดพลาดในการรีเซ็ต: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            async function confirmShipment() {
                const confirmationValue = confirmationInput.value.trim();
                if (!confirmationValue || completedIndices.has(currentIndex) || currentIndex < 0) return;
                
                const currentOrderGroup = aggregatedData[currentIndex];
                const currentTrackingId = String(currentOrderGroup[0].tracking_number).trim();
                const currentOrderId = currentOrderGroup[0].order_id;
                
                if (confirmationValue === currentTrackingId) {
                    confirmationInput.value = ""; // Clear input immediately
                    const timestamp = new Date().toISOString();
                    
                    const { error } = await supabaseClient.from('orders').update({
                        shipped_by: loggedInUsername,
                        shipped_time: timestamp
                    }).eq('id', currentOrderId);

                    if (error) {
                        alert('เกิดข้อผิดพลาดในการบันทึกข้อมูลการจัดส่ง: ' + error.message);
                        errorSound.play();
                        return;
                    }

                    completedIndices.add(currentIndex);
                    if(packingState[currentWorkOrderName]){
                        packingState[currentWorkOrderName].completedIndices = Array.from(completedIndices);
                        currentOrderGroup.forEach(item => {
                            delete packingState[currentWorkOrderName].items[item.item_uid];
                        });
                        savePackingState();
                    }
                    
                    markNavItemAsComplete(currentIndex, true);
                    updateStatus("✅ จัดส่งสำเร็จ! กำลังไปรายการถัดไป...", "success");
                    successSound.play();
                    
                    setTimeout(async () => {
                        if (completedIndices.size === aggregatedData.length) {
                             if (confirm(`ใบงาน "${currentWorkOrderName}" จัดของเสร็จสมบูรณ์แล้ว\nต้องการย้ายบิลทั้งหมดและใบงานไปสถานะ "จัดส่งแล้ว" หรือไม่?`)) {
                                await finalizeWorkOrderAndMoveStatus(currentWorkOrderName);
                            } else {
                                updateStatus("🎉 ยอดเยี่ยม! จัดส่งครบทุกออเดอร์แล้ว", "success");
                                actionPanel.style.display = "none";
                            }
                        } else {
                            searchInput.value = '';
                            filterNavList();
                            const nextIndex = aggregatedData.findIndex((_, i) => !completedIndices.has(i));
                            if (nextIndex !== -1) {
                                displayOrder(nextIndex);
                            }
                        }
                    }, 1200);
                } else {
                    updateStatus("❌ ผิดพลาด! เลขพัสดุไม่ตรงกัน", "error");
                    errorSound.play();
                    confirmationInput.select();
                }
            }

            async function scanItem() {
                const scanValue = itemScanInput.value.trim();
                if (!scanValue || currentIndex < 0) return;
                
                const currentOrderGroup = aggregatedData[currentIndex];
                const itemToScan = currentOrderGroup.find(item => !item.scanned && item.item_uid === scanValue);

                if (itemToScan) {
                    itemScanInput.value = ""; // Clear input immediately
                    const timestamp = new Date().toISOString();
                    
                    const { error } = await supabaseClient.from('order_items').update({
                        item_scan_time: timestamp,
                        packing_status: 'สแกนแล้ว'
                    }).eq('item_uid', itemToScan.item_uid);
                    
                    if (error) {
                        alert('เกิดข้อผิดพลาดในการบันทึกเวลาสแกน: ' + error.message);
                        errorSound.play();
                        return;
                    }

                    successSound.play();
                    itemToScan.scanned = true;
                    itemToScan.itemScanTime = timestamp;
                    if(!packingState[currentWorkOrderName]) packingState[currentWorkOrderName] = { completedIndices: [], items: {} };
                    packingState[currentWorkOrderName].items[itemToScan.item_uid] = { scanned: true, itemScanTime: timestamp };
                    savePackingState();

                    const row = resultContainer.querySelector(`tr[data-item-uid="${itemToScan.item_uid}"]`);
                    if(row) row.classList.add('item-scanned');
                    updateInputStates();
                } else {
                    errorSound.play();
                    const alreadyScanned = currentOrderGroup.find(item => item.scanned && item.item_uid === scanValue);
                    updateStatus(alreadyScanned ? "❌ Item UID นี้ถูกสแกนไปแล้ว!" : "❌ Item UID ไม่ถูกต้อง!", "error");
                    itemScanInput.select();
                }
            };
            
            function showPackingView(view) { 
                if (view === 'selection') {
                    currentWorkOrderName = null; 
                    selectionView.style.display = "block";
                    mainView.style.display = "none"; 
                } else { 
                    selectionView.style.display = "none";
                    mainView.style.display = "block"; 
                } 
            }

            const getTimestamp = () => new Date().toISOString();
            const exportToExcel = () => { /* ... (existing code) ... */ };
            const filterNavList = () => { /* ... (existing code) ... */ };
            const updateInputStates = () => { if (currentIndex < 0) return; const allScanned = aggregatedData[currentIndex].every(item => item.scanned); itemScanInput.disabled = allScanned; confirmationInput.disabled = !allScanned; if (allScanned) { updateStatus("สินค้าครบแล้ว! กรุณายืนยันการจัดส่ง", "success"); confirmationInput.focus(); } else { updateStatus(`รอสแกนสินค้า ${aggregatedData[currentIndex].filter(i => !i.scanned).length} ชิ้น...`, ""); itemScanInput.focus(); } };
            const updateCounter = () => { orderCounter.textContent = `สำเร็จ ${completedIndices.size} / ${aggregatedData.length} ออเดอร์`; };
            const updateActiveNavItem = () => { container.querySelectorAll(".order-item").forEach(item => item.classList.toggle("active", parseInt(item.dataset.index) === currentIndex)); };
            const markNavItemAsComplete = (index, isComplete) => { const item = container.querySelector(`.order-item[data-index='${index}']`); if (item) { item.classList.toggle("completed", isComplete); item.querySelector('.tracking-id').innerHTML = `✅ ${item.querySelector('.tracking-id').textContent.split(' ').pop()}`; } updateCounter(); };
            const updateStatus = (text, type) => { statusMessage.textContent = text; statusMessage.className = `status-${type}`; };

            exportBtn.addEventListener("click", exportToExcel);
            searchInput.addEventListener("input", filterNavList);
            itemScanInput.addEventListener("input", scanItem); // Changed from keyup to input for faster response
            confirmationInput.addEventListener("input", confirmShipment); // Changed from keyup to input
            backBtn.addEventListener("click", () => {
                showPackingView('selection');
            });
            resetBtn.addEventListener("click", resetCurrentOrderPacking);

            return { loadWorkOrdersForPacking };
        })();

        // --- PRODUCT SYSTEM MODULE ---
        window.productSystem = (() => {
            let isInitialized = false;
            const container = document.getElementById('product-system-container');
            const addBtn = document.getElementById('add-product-btn');
            const importBtn = document.getElementById('import-product-btn');
            const importInput = document.getElementById('import-product-input');
            const downloadTemplateBtn = document.getElementById('download-product-template-btn');
            const searchInput = document.getElementById('search-product-input');
            const tableBody = document.getElementById('products-tbody');
            const modal = document.getElementById('product-modal');
            const modalTitle = document.getElementById('product-modal-title');
            const productForm = document.getElementById('product-form');
            const cancelModalBtn = document.getElementById('cancel-product-modal-btn');
            const categoryInput = document.getElementById('product-category-input');
            const rubberCodeGroup = document.getElementById('rubber-code-group');
            
            let allProductsData = [];

            function initializeApp() {
                if(isInitialized) return;
                addBtn.addEventListener('click', () => showProductModal());
                importBtn.addEventListener('click', () => importInput.click());
                importInput.addEventListener('change', (e) => handleProductImport(e.target.files[0]));
                downloadTemplateBtn.addEventListener('click', downloadProductTemplate);
                cancelModalBtn.addEventListener('click', hideProductModal);
                modal.addEventListener('click', (e) => { if(e.target === modal) hideProductModal(); });
                productForm.addEventListener('submit', saveProduct);
                tableBody.addEventListener('click', handleTableClick);
                searchInput.addEventListener('input', () => renderProductTable(searchInput.value));

                categoryInput.addEventListener('input', (e) => {
                    const isStamp = (e.target.value || '').toUpperCase().includes('STAMP');
                    rubberCodeGroup.style.display = isStamp ? 'block' : 'none';
                });
                loadProducts();
                isInitialized = true;
            }

            async function loadProducts() {
                loadingOverlay.style.display = 'flex';
                try {
                    const { data, error } = await supabaseClient.from('products').select('*').order('product_code');
                    if (error) throw error;
                    allProductsData = data;
                    renderProductTable();
                } catch (err) {
                    alert('เกิดข้อผิดพลาดในการโหลดข้อมูลสินค้า: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function renderProductTable(searchTerm = '') {
                tableBody.innerHTML = '';
                const lowercasedFilter = searchTerm.toLowerCase();
                const filteredData = allProductsData.filter(p => 
                    (p.product_code || '').toLowerCase().includes(lowercasedFilter) || 
                    (p.product_name || '').toLowerCase().includes(lowercasedFilter)
                );

                if (filteredData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">ไม่พบข้อมูลสินค้า</td></tr>';
                    return;
                }

                filteredData.forEach(product => {
                    const row = `
                        <tr>
                            <td>${product.product_code || ''}</td>
                            <td>${product.product_name || ''}</td>
                            <td>${product.product_category || ''}</td>
                            <td>${product.product_type || ''}</td>
                            <td>${product.rubber_code || ''}</td>
                            <td>${product.storage_location || ''}</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-product-btn" data-product-code="${product.product_code}">แก้ไข</button>
                                <button class="btn btn-danger btn-sm delete-product-btn" data-product-code="${product.product_code}">ลบ</button>
                            </td>
                        </tr>`;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function showProductModal(product = null) {
                productForm.reset();
                if (product) {
                    modalTitle.textContent = 'แก้ไขข้อมูลสินค้า';
                    document.getElementById('product-id-input').value = product.id;
                    document.getElementById('product-code-input').value = product.product_code;
                    document.getElementById('product-code-input').readOnly = true;
                    document.getElementById('product-name-input').value = product.product_name;
                    document.getElementById('product-category-input').value = product.product_category || '';
                    document.getElementById('product-type-input').value = product.product_type || '';
                    document.getElementById('product-rubber-code-input').value = product.rubber_code || '';
                    document.getElementById('storage-location-input').value = product.storage_location || '';
                } else {
                    modalTitle.textContent = 'เพิ่มสินค้าใหม่';
                    document.getElementById('product-code-input').readOnly = false;
                }
                
                const isStamp = (categoryInput.value || '').toUpperCase().includes('STAMP');
                rubberCodeGroup.style.display = isStamp ? 'block' : 'none';
                
                modal.style.display = 'flex';
            }

            function hideProductModal() {
                modal.style.display = 'none';
            }

            async function saveProduct(e) {
                e.preventDefault();
                loadingOverlay.style.display = 'flex';

                const productData = {
                    product_code: document.getElementById('product-code-input').value.trim(),
                    product_name: document.getElementById('product-name-input').value.trim(),
                    product_category: document.getElementById('product-category-input').value.trim() || null,
                    product_type: document.getElementById('product-type-input').value.trim() || null,
                    rubber_code: document.getElementById('product-rubber-code-input').value.trim() || null,
                    storage_location: document.getElementById('storage-location-input').value.trim() || null,
                };
                
                if (!productData.product_code || !productData.product_name) {
                    alert('กรุณากรอกรหัสสินค้าและชื่อสินค้า');
                    loadingOverlay.style.display = 'none';
                    return;
                }

                try {
                    const { error } = await supabaseClient.from('products').upsert(productData, { onConflict: 'product_code' });
                    if (error) throw error;
                    
                    alert('บันทึกข้อมูลสินค้าสำเร็จ!');
                    hideProductModal();
                    await loadProducts();
                } catch (err) {
                    alert('เกิดข้อผิดพลาด: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            async function deleteProduct(productCode) {
                if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบสินค้า "${productCode}"?`)) return;

                loadingOverlay.style.display = 'flex';
                try {
                    const { error } = await supabaseClient.from('products').delete().eq('product_code', productCode);
                    if (error) throw error;

                    alert('ลบสินค้าสำเร็จ!');
                    await loadProducts();
                } catch (err) {
                    alert('เกิดข้อผิดพลาด: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function handleTableClick(e) {
                if (e.target.classList.contains('edit-product-btn')) {
                    const productCode = e.target.dataset.productCode;
                    const productToEdit = allProductsData.find(p => p.product_code === productCode);
                    if (productToEdit) showProductModal(productToEdit);
                }
                if (e.target.classList.contains('delete-product-btn')) {
                    const productCode = e.target.dataset.productCode;
                    deleteProduct(productCode);
                }
            }
            
            function downloadProductTemplate() {
                const headers = ["product_code", "product_name", "product_category", "product_type", "rubber_code", "storage_location"];
                const sampleData = [
                    ["P001", "สติกเกอร์กันน้ำ", "STK", "FINISHPRODUCT", "", "3Aชั้น2แถว2"],
                    ["S001", "ตรายาง E1 เป็ด", "FANCY STAMP", "FINISHPRODUCT", "R-E1", "4Aชั้น4แถว3"],
                ];
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "ProductTemplate");
                XLSX.writeFile(workbook, "Product_Import_Template.xlsx");
            }

            function handleProductImport(file) {
                 if (!file) return;
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        const headers = (XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0] || []).map(h => String(h).trim());
                        if (!headers.includes('product_code') || !headers.includes('product_name')) {
                            throw new Error("ไฟล์ที่นำเข้าต้องมีคอลัมน์ 'product_code' และ 'product_name' เป็นอย่างน้อย");
                        }

                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        if (jsonData.length === 0) throw new Error("ไม่พบข้อมูลในไฟล์");

                        const productsToUpsert = jsonData.map(row => ({
                            product_code: String(row.product_code || '').trim(),
                            product_name: String(row.product_name || '').trim(),
                            product_category: String(row.product_category || '').trim() || null,
                            product_type: String(row.product_type || '').trim() || null,
                            rubber_code: String(row.rubber_code || '').trim() || null,
                            storage_location: String(row.storage_location || '').trim() || null,
                        })).filter(p => p.product_code && p.product_name);

                        if (productsToUpsert.length === 0) throw new Error("ไม่พบข้อมูลสินค้าที่ถูกต้องในไฟล์");

                        loadingOverlay.style.display = 'flex';
                        const { error } = await supabaseClient.from('products').upsert(productsToUpsert, { onConflict: 'product_code' });
                        if (error) throw error;
                        
                        alert(`นำเข้าข้อมูลสินค้าสำเร็จ! (ประมวลผล ${productsToUpsert.length} รายการ)`);
                        await loadProducts();
                    } catch (err) {
                        alert('เกิดข้อผิดพลาดในการนำเข้าไฟล์: ' + err.message);
                    } finally {
                        loadingOverlay.style.display = 'none';
                        importInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            return { initializeApp, loadProducts };
        })();

        // --- PLANNER SYSTEM MODULE ---
        window.plannerSystem = (() => {
            let isInitialized = false;
            let container = null;
            let currentUserRole = null;
            let state = { jobs: [] };

            const el = (sel, context = document) => context.querySelector(sel);
            const cel = (tag, attrs = {}) => { const n = document.createElement(tag); for (const k in attrs) { if (k === 'text') n.textContent = attrs[k]; else n.setAttribute(k, attrs[k]); } return n; };
            const sameDay = (d1, d2) => d1 === d2;

            function setupEventListeners() {
                el('#j_date').addEventListener('change', renderJobs);
                el('#j_search').addEventListener('input', renderJobs);
                el('#j_clear').addEventListener('click', () => { el('#j_date').value = ''; el('#j_search').value = ''; renderJobs(); });
                el('#btnExportForSorting').addEventListener('click', exportJobsForSorting);
                 el('#tableJobs').addEventListener('click', handleTableClick);
            }

            async function initializeApp(userRole) {
                if (isInitialized && currentUserRole === userRole) {
                    await internal_load();
                    return;
                }
                container = el('#planner-system-container');
                currentUserRole = userRole;

                loadingOverlay.style.display = 'flex';
                await internal_load();
                loadingOverlay.style.display = 'none';

                if (!isInitialized) {
                    setupEventListeners();
                    setupRealtimeSubscriptions();
                }
                
                updateAccessControls();
                isInitialized = true;
            }

            async function internal_load() {
                try {
                    const { data: jobsData, error: jobsError } = await supabaseClient.from('jobs').select('*').order('created_at', { ascending: false });
                    if (jobsError) throw new Error('Could not load jobs: ' + jobsError.message);
                    state.jobs = jobsData || [];
                } catch (e) {
                    console.error("Critical error during planner load:", e);
                    alert('ไม่สามารถโหลดข้อมูลใบงานได้! ' + e.message);
                    state.jobs = [];
                }
                renderAll();
            }
            
            function updateAccessControls() {
                const unlocked = currentUserRole === 'superadmin';
                container.querySelectorAll('#viewJobs input, #viewJobs select, #viewJobs button').forEach(elem => {
                    elem.disabled = !unlocked;
                });
                renderAll();
            }
            
            function renderAll() {
                if (!container) return;
                populateJobDateFilter();
                renderJobs();
            }

            function populateJobDateFilter() {
                const dateSelect = el('#j_date');
                if (!dateSelect) return;
                const uniqueDates = [...new Set(state.jobs.map(j => j.date))].sort().reverse();
                const currentVal = dateSelect.value;
                dateSelect.innerHTML = '<option value="">ทุกวัน</option>';
                uniqueDates.forEach(d => dateSelect.add(new Option(d, d)));
                if ([...dateSelect.options].some(o => o.value === currentVal)) dateSelect.value = currentVal;
            }

            function renderJobs() {
                const tbody = el('#tableJobs tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                const qDate = el('#j_date').value;
                const qStr = (el('#j_search').value || '').toLowerCase();
                
                const filteredJobs = state.jobs
                    .filter(j => !qDate || sameDay(j.date, qDate))
                    .filter(j => !qStr || j.name.toLowerCase().includes(qStr));

                if (filteredJobs.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;">ไม่พบใบงานตามเงื่อนไข</td></tr>`;
                    return;
                }

                filteredJobs.forEach(j => {
                    const tr = cel('tr');
                    tr.dataset.jobId = j.id;
                    tr.innerHTML = `<td class="checkbox-cell"><input type="checkbox" class="job-checkbox" data-id="${j.id}"></td>`;
                    const qtyCell = cel('td');
                    const qtyContainer = cel('div', { class: 'qty-pills-container' });
                    const depts = ['STAMP', 'STK', 'CTT', 'LASER', 'TUBE', 'PACK'];
                    depts.forEach(d => {
                        const q = j.qty?.[d] || 0;
                        if (q > 0) qtyContainer.appendChild(cel('span', { class: 'pill', text: `${d}: ${q}` }));
                    });
                    qtyCell.appendChild(qtyContainer);
                    
                    let cutTimeText = j.cut || '-';
                    if (cutTimeText && cutTimeText.length > 5) cutTimeText = cutTimeText.substring(0, 5);

                    const nameCell = cel('td');
                    nameCell.innerHTML = `<strong>${j.name}</strong>`;
                    const dateCell = cel('td', { text: j.date });
                    const cutCell = cel('td', { text: cutTimeText });
                    const tdAct = cel('td');
                    tdAct.innerHTML = `
                        <button class="btn btn-warning btn-sm edit-job-btn" data-job-id="${j.id}">แก้ไข</button>
                        <button class="btn btn-danger btn-sm delete-job-btn" data-job-id="${j.id}">ลบ</button>
                    `;
                    
                    tr.append(nameCell, dateCell, cutCell, qtyCell, tdAct);
                    tbody.appendChild(tr);
                });
            }

            function handleTableClick(e) {
                const target = e.target;
                if (target.classList.contains('edit-job-btn')) {
                    const jobId = target.dataset.jobId;
                    showJobEditor(jobId);
                }
                if (target.classList.contains('delete-job-btn')) {
                    const jobId = target.dataset.jobId;
                    deleteJob(jobId);
                }
            }
            
            async function deleteJob(jobId) {
                const jobToDelete = state.jobs.find(j => j.id == jobId);
                if(!jobToDelete) return;
                if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบใบงาน "${jobToDelete.name}"?`)) return;
                
                loadingOverlay.style.display = 'flex';
                try {
                    const { error } = await supabaseClient.from('jobs').delete().eq('id', jobId);
                    if (error) throw error;
                    alert('ลบใบงานสำเร็จ');
                } catch(err) {
                    alert('เกิดข้อผิดพลาดในการลบ: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function showJobEditor(jobId) {
                const job = state.jobs.find(j => j.id == jobId);
                if (!job) return;

                const formContainer = document.createElement('div');
                formContainer.id = 'job-editor-modal-container'; 
                formContainer.innerHTML = `
                    <div class="modal-overlay" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px;">
                            <h2 id="job-editor-title">แก้ไขใบงาน: ${job.name}</h2>
                            <div id="job-editor-form">
                                <div class="planner-form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                   <div class="planner-form-group">
                                       <label for="edit_j_date">วันที่</label>
                                       <input type="date" id="edit_j_date" value="${job.date}">
                                   </div>
                                   <div class="planner-form-group">
                                       <label for="edit_j_cut">เวลาตัด</label>
                                       <input type="time" id="edit_j_cut" value="${job.cut || ''}">
                                   </div>
                                </div>
                                <h3 class="planner-section-title">จำนวนต่อแผนก</h3>
                                <div id="edit_j_qty" class="planner-form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px 20px;"></div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" id="edit_j_cancel">ยกเลิก</button>
                                    <button type="button" class="btn btn-primary" id="edit_j_save">บันทึก</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(formContainer);

                const qtyHost = formContainer.querySelector('#edit_j_qty');
                const depts = ['STAMP', 'STK', 'CTT', 'LASER', 'TUBE', 'PACK'];
                depts.forEach(d => {
                    const qty = job.qty?.[d] || 0;
                    const div = cel('div', { class: 'planner-qty-group' });
                    div.innerHTML = `
                        <label>${d}</label>
                        <input type="number" class="edit-qty" data-dept="${d}" value="${qty}" min="0">
                    `;
                    qtyHost.appendChild(div);
                });

                const closeModal = () => document.body.removeChild(formContainer);

                formContainer.querySelector('#edit_j_save').onclick = async () => {
                    const newQty = {};
                    qtyHost.querySelectorAll('.edit-qty').forEach(inp => {
                        newQty[inp.dataset.dept] = parseInt(inp.value, 10) || 0;
                    });
                    const updates = {
                        date: formContainer.querySelector('#edit_j_date').value,
                        cut: formContainer.querySelector('#edit_j_cut').value,
                        qty: newQty,
                    };
                    loadingOverlay.style.display = 'flex';
                    const { error } = await supabaseClient.from('jobs').update(updates).eq('id', jobId);
                    loadingOverlay.style.display = 'none';
                    if (error) {
                        alert('การอัปเดตข้อมูลล้มเหลว: ' + error.message);
                    } else {
                        alert('อัปเดตสำเร็จ');
                        closeModal();
                    }
                };
                formContainer.querySelector('#edit_j_cancel').onclick = closeModal;
                formContainer.querySelector('.modal-overlay').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) closeModal();
                });
            }

            function exportJobsForSorting() {
                const qDate = el('#j_date').value;
                const qStr = (el('#j_search').value || '').toLowerCase();

                const filteredJobs = state.jobs
                    .filter(j => !qDate || sameDay(j.date, qDate))
                    .filter(j => !qStr || j.name.toLowerCase().includes(qStr))
                    .sort((a, b) => (a.date.localeCompare(b.date)) || (a.order_index - b.order_index));

                if (filteredJobs.length === 0) {
                    alert('ไม่พบใบงานที่ตรงกับตัวกรองสำหรับ Export');
                    return;
                }
                const headers = ['date', 'name', 'cut', 'STAMP', 'STK', 'CTT', 'LASER', 'TUBE', 'PACK'];
                const dataToExport = filteredJobs.map(job => {
                    const qty = job.qty || {};
                    return [
                        job.date, job.name, job.cut || '',
                        qty.STAMP || 0, qty.STK || 0, qty.CTT || 0,
                        qty.LASER || 0, qty.TUBE || 0, qty.PACK || 0
                    ];
                });
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Jobs");
                const today = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(workbook, `Jobs_For_Sorting_${today}.xlsx`);
            }

            function setupRealtimeSubscriptions() {
                const jobChannel = supabaseClient.channel('public:jobs');
                jobChannel.on('postgres_changes', { event: '*', schema: 'public', table: 'jobs' }, async (payload) => {
                    await internal_load();
                }).subscribe();
            }

            return { initializeApp };
        })();
        
        // --- INITIAL LOAD ---
        checkAuth();

        window.addEventListener('pageshow', function (event) {
            if (event.persisted) {
                console.log("Page loaded from bfcache. Re-initializing app.");
                checkAuth();
            }
        });
    });
    </script>
</body>
</html>

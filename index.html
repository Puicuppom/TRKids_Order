<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR Kids - Integrated System</title>
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        :root{--sidebar-width:240px;--sidebar-width-collapsed:65px;--top-bar-height:60px;--primary-color:#0071e3;--sidebar-bg:#1d2b3a;--sidebar-link-color:#c5d6de;--sidebar-link-hover-bg:#2a3f54;--sidebar-link-active-bg:#0071e3;--top-bar-bg:#4F634A}*{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background-color:#f4f7f9}.app-container{display:flex;height:100vh}.sidebar{width:var(--sidebar-width);height:100%;position:fixed;z-index:1001;top:0;left:0;background-color:var(--sidebar-bg);transition:width .3s ease;color:#fff;padding-top:20px;flex-shrink:0}.page-wrapper{display:flex;flex-direction:column;width:100%;margin-left:var(--sidebar-width);transition:margin-left .3s ease}.top-bar{height:var(--top-bar-height);background-color:var(--top-bar-bg);color:#fff;display:flex;align-items:center;justify-content:flex-end;padding:0 30px;flex-shrink:0;box-shadow:0 2px 5px rgba(0,0,0,.1)}.main-content{flex-grow:1;overflow-y:auto;padding:0;height:calc(100vh - var(--top-bar-height))}.system-content{display:none}.system-content.active{display:block}.sidebar .sidebar-header{padding:0 20px 20px;text-align:center;border-bottom:1px solid #3a4b5f;white-space:nowrap}.sidebar .sidebar-header h2{margin:0;font-size:1.6em;font-weight:600}.sidebar .sidebar-header .toggle-btn{position:absolute;top:15px;right:-25px;width:50px;height:50px;background-color:var(--sidebar-bg);border:2px solid #fff;border-radius:50%;color:#fff;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;z-index:1002;box-shadow:0 0 10px rgba(0,0,0,.5);transition:transform .3s ease}.sidebar nav ul{list-style-type:none;padding:20px 0;margin:0}.sidebar nav li a{display:flex;align-items:center;padding:15px 20px;text-decoration:none;font-size:16px;color:var(--sidebar-link-color);white-space:nowrap;transition:background-color .2s ease-in-out}.sidebar nav li a .icon{margin-right:15px;font-size:1.5em;width:30px;text-align:center}.sidebar nav li a:hover{background-color:var(--sidebar-link-hover-bg)}.sidebar nav li a.active{background-color:var(--sidebar-link-active-bg);color:#fff;font-weight:700}body.sidebar-collapsed .sidebar{width:var(--sidebar-width-collapsed)}body.sidebar-collapsed .page-wrapper{margin-left:var(--sidebar-width-collapsed)}body.sidebar-collapsed .sidebar .sidebar-header h2,body.sidebar-collapsed .sidebar .nav-text{opacity:0;visibility:hidden}body.sidebar-collapsed .sidebar .nav-link .icon{margin-right:0}body.sidebar-collapsed .sidebar .toggle-btn{transform:rotate(180deg)}#user-info-bar{display:flex;align-items:center;gap:15px;font-size:14px}#logout-btn{background-color:#6c757d;color:#fff;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-size:14px}.full-page-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#f4f7f9;z-index:2000;display:flex;justify-content:center;align-items:center}#main-app-container{display:none}#order-system-container .view{display:none}#order-system-container .view.active{display:block}#order-system-container #app-view{padding:20px}
        #order-system-container .container{max-width:1800px;margin:auto;background:#fff;padding:25px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
        #order-system-container h1,#order-system-container h2,#order-system-container h3{color:#333}#order-system-container h1{text-align:center;color:#0071e3}#order-system-container .btn{padding:12px 20px;border:none;border-radius:4px;font-size:16px;cursor:pointer}#order-system-container .btn.btn-sm{padding:5px 10px;font-size:12px}#order-system-container .btn-primary{background-color:#0071e3;color:#fff}#order-system-container .btn-secondary{background-color:#6c757d;color:#fff}#order-system-container .btn-success{background-color:#28a745;color:#fff}#order-system-container .btn-warning{background-color:#ffc107;color:#000}#order-system-container .btn-danger{background-color:#dc3545;color:#fff}#order-system-container .btn-info{background-color:#17a2b8;color:#fff}#loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);color:#fff;display:none;justify-content:center;align-items:center;z-index:1500;font-size:2em}#order-system-container .batch-actions{margin-bottom:20px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}#order-system-container .order-list-item{display:flex;align-items:center;gap:15px;padding:15px;border:1px solid #ddd;margin-bottom:10px;border-radius:4px;flex-wrap:wrap}#order-system-container .order-info{flex-grow:1;cursor:pointer}#order-system-container .order-info:hover{text-decoration:underline}#order-system-container .order-info strong{font-size:1.1em;color:#0071e3;display:block;margin-bottom:4px}#order-system-container .order-info .order-tracking{font-size:.9em;color:#28a745;font-weight:700}#order-system-container .order-list-item-details{display:flex;justify-content:flex-end;flex-grow:1;align-items:center;gap:15px;color:#6c757d;font-size:.9em}#order-system-container .work-order-group{border:1px solid #0071e3;border-radius:4px;margin-bottom:15px}#order-system-container .work-order-header{background-color:#e0effc;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;font-weight:700;cursor:pointer}#order-system-container .wo-name{flex-grow:1}#order-system-container .wo-header-actions{display:flex;align-items:center;gap:15px}#order-system-container .work-order-header:hover{background-color:#cce4fa}#order-system-container .work-order-bills{background-color:#fff;padding:0 15px;max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out;border-top:1px solid transparent}#order-system-container .work-order-bills.show{max-height:1500px;padding:15px;transition:max-height .5s ease-in,padding .5s ease-in;border-top:1px solid #ddd}#order-system-container .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        #order-system-container .form-grid.form-grid-main { display: grid; grid-template-columns: 1fr 1fr 2.5fr; gap: 20px; }
        #order-system-container .form-group.full-width { grid-column: 1 / -1; }
        #order-system-container label{margin-bottom:5px;font-weight:600}#order-system-container input,#order-system-container select,#order-system-container textarea{padding:10px;border:1px solid #ccc;border-radius:4px;font-size:16px;box-sizing:border-box}#order-system-container hr{border:0;height:1px;background:#e0e0e0;margin:25px 0}#order-system-container .tabs{border-bottom:2px solid #dee2e6;display:flex;flex-wrap:wrap;margin-bottom:20px}#order-system-container .tab-link{padding:10px 15px;cursor:pointer;background:0 0;border:none;font-size:16px;border-bottom:3px solid transparent}#order-system-container .tab-link.active{border-bottom-color:#0071e3;font-weight:600;color:#0071e3}#order-system-container .tab-content{display:none}#order-system-container .tab-content.active{display:block}#order-system-container .tab-filter{margin-bottom:15px;display:flex;align-items:center;gap:10px}#order-system-container .order-list{list-style:none;padding:0;max-height:60vh;overflow-y:auto}#order-system-container .items-table-container{overflow-x:auto}#order-system-container #items-table{width:100%;border-collapse:collapse;margin-bottom:10px;table-layout:fixed;}#order-system-container #items-table th,#order-system-container #items-table td{border:1px solid #ddd;padding:2px;text-align:left;vertical-align:top;word-wrap:break-word;}#order-system-container #items-table th{background-color:#f8f9fa;font-size:14px;padding:8px;white-space:nowrap}
        #items-table th:nth-child(1) { width: 250px; } #items-table th:nth-child(2) { width: 120px; } #items-table th:nth-child(3) { width: 80px; } #items-table th:nth-child(4) { width: 120px; } #items-table th:nth-child(5) { width: 100px; } #items-table th:nth-child(6) { width: 120px; } #items-table th:nth-child(7) { width: 150px; } #items-table th:nth-child(8) { width: 150px; } #items-table th:nth-child(9) { width: 150px; } #items-table th:nth-child(10) { width: 70px; } #items-table th:nth-child(11) { width: 180px; } #items-table th:nth-child(12) { width: 120px; } #items-table th:nth-child(13) { width: 50px; }
        #order-system-container #items-table input,#order-system-container #items-table select{width:100%;font-size:14px;padding:6px;border:none;background:0 0;box-sizing:border-box}#order-system-container #items-table input:focus{outline:2px solid #0071e3;background:#fff}#order-system-container #items-table .select2-container{width:100%!important}#order-system-container #items-table .select2-selection--single{height:32px!important;border:none!important}#order-system-container #items-table .select2-selection__rendered{line-height:30px!important}#order-system-container #items-table .select2-selection__arrow{height:30px!important}#order-system-container #items-table .quantity-input{width:70px;text-align:center}#order-system-container #items-table .action-cell{width:50px;text-align:center}#order-system-container #items-table .remove-item-btn{font-size:12px;padding:4px 8px}#order-system-container .work-order-bills .order-list-item{padding:10px;border-left:3px solid #6c757d}
        .btn-edit-tracking { background: transparent; border: none; cursor: pointer; padding: 0 5px; font-size: 14px; }
        .tracking-input { padding: 4px; border-radius: 4px; border: 1px solid #ccc; width: 160px; }
        #packing-system-container{--primary-color:#0071e3;--success-color:#28a745;--danger-color:#dc3545;padding:20px}#packing-system-container .header{text-align:center;padding-bottom:20px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;gap:20px;flex-wrap:wrap;margin-bottom:20px}#packing-system-container .header h1{margin:0;font-size:24px;color:var(--primary-color)}#packing-system-container .header .action-buttons{display:flex;gap:10px}#packing-system-container .btn{padding:8px 15px;border:none;border-radius:6px;cursor:pointer;font-size:14px}#packing-system-container .btn-export{background-color:var(--success-color);color:#fff}#packing-system-container .btn-export:disabled{background-color:#a5d6a7;cursor:not-allowed}#packing-system-container .btn-back{background-color:#6c757d;color:#fff}#work-order-selection-view{padding:40px;text-align:center}#work-order-selection-view h2{margin-top:0}#work-order-list{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;list-style:none;padding:0}.work-order-item button{padding:20px 30px;font-size:1.1em;cursor:pointer;border:1px solid #0071e3;background-color:#f0f8ff;border-radius:8px;transition:all .2s}.work-order-item button:hover{background-color:#e0effc;box-shadow:0 2px 5px rgba(0,0,0,.1)}#packing-main-view{display:none}#packing-main-view .main-container{display:flex;height:calc(100vh - var(--top-bar-height) - 180px)}#packing-main-view #order-nav-panel{width:300px;background:#fff;border-right:1px solid #d2d2d7;display:flex;flex-direction:column;flex-shrink:0}#packing-main-view #nav-header{padding:15px;border-bottom:1px solid #d2d2d7;text-align:center}#packing-main-view #order-counter{font-size:16px;font-weight:600}#packing-main-view #search-input{width:calc(100% - 24px);padding:8px 12px;margin-top:10px;border:1px solid #d2d2d7;border-radius:6px}#packing-main-view #order-list{list-style:none;padding:0;margin:0;overflow-y:auto;flex-grow:1}#packing-main-view .order-item{padding:12px 15px;border-bottom:1px solid #e5e5e5;cursor:pointer;-webkit-user-select:none;user-select:none}#packing-main-view .order-item.active{background-color:#e0effc}#packing-main-view .order-item.completed{color:var(--success-color)}#packing-main-view .order-item .tracking-id{font-weight:700;display:block}#packing-main-view .order-item .customer-name{font-size:.9em;color:#6e6e73}#packing-main-view #content-panel{flex-grow:1;display:flex;flex-direction:column;overflow:hidden;background:#fff}#packing-main-view #action-panel{padding:20px;flex-shrink:0;background-color:#f8f8fa;border-bottom:1px solid #d2d2d7}#packing-main-view .action-step{margin-bottom:15px}#packing-main-view .action-step:last-child{margin-bottom:0}#packing-main-view .action-step h3{margin:0 0 10px;font-size:18px;text-align:center}#packing-main-view .action-step input{font-size:16px;padding:10px;text-align:center;border:2px solid;border-radius:8px;max-width:400px;width:100%;display:block;margin:0 auto}#packing-main-view #item-scan-input{border-color:var(--primary-color)}#packing-main-view #confirmation-input{border-color:var(--success-color)}#packing-main-view input:disabled{background-color:#e9ecef;border-color:#ced4da;cursor:not-allowed}#packing-main-view #status-message{margin-top:15px;font-size:20px;font-weight:700;height:28px;text-align:center}#packing-main-view .status-success{color:var(--success-color)}#packing-main-view .status-error{color:var(--danger-color)}#packing-main-view #result-container{padding:25px;overflow-y:auto;flex-grow:1}#packing-main-view table{width:100%;border-collapse:collapse;margin-top:15px}#packing-main-view th,#packing-main-view td{padding:12px;border:1px solid #d2d2d7;text-align:left;transition:background-color .3s;white-space:nowrap}#packing-main-view thead{background-color:#f0f0f0}#packing-main-view tr.item-scanned{background-color:#e2f0e3}#packing-main-view tr.item-scanned td:first-child::before{content:"‚úÖ "}
    </style>
</head>
<body class="sidebar-collapsed">

    <div id="loading-overlay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div id="login-overlay" class="full-page-overlay">
        <div id="login-container" style="background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px;">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
            <form id="login-form">
                <div style="margin-bottom: 20px; text-align: left;"><label for="email" style="display: block; margin-bottom: 5px; font-weight: 600;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="email" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;"></div>
                <div style="margin-bottom: 20px; text-align: left;"><label for="password" style="display: block; margin-bottom: 5px; font-weight: 600;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="password" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;"></div>
                <button type="submit" style="width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; background-color: #0071e3; color: white;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <p id="error-message" style="color: #dc3545; margin-top: 15px; height: 20px;"></p>
            </form>
        </div>
    </div>
    
    <div id="main-app-container" class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>TR Kids</h2>
                <button class="toggle-btn" id="sidebar-toggle">‚ùÆ</button>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-target="order-system-container"><span class="icon">üìù</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</span></a></li>
                    <li><a href="#" class="nav-link" data-target="packing-system-container"><span class="icon">üì¶</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</span></a></li>
                    <!-- ===== NEW LINK ADDED HERE ===== -->
                    <li><a href="accounting.html" class="nav-link"><span class="icon">üìä</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></a></li>
                </ul>
            </nav>
        </div>

        <div class="page-wrapper">
            <header class="top-bar">
                <div id="user-info-bar">
                    <span id="welcome-message"></span>
                    <button type="button" id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </header>
            <main class="main-content">
                <div id="order-system-container" class="system-content active">
                    <div id="app-view" class="view active">
                        <input type="file" id="tracking-file-input" style="display: none;" accept=".csv, text/csv">
                        <input type="file" id="import-excel-input" style="display: none;" accept=".xlsx, .xls">
                        <input type="file" id="import-pgtr-input" style="display: none;" accept=".xlsx, .xls">
                        
                        <div class="container">
                            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
                            <div class="tabs">
                                <button class="tab-link active" data-tab="tab-create">‡∏™‡∏£‡πâ‡∏≤‡∏á / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="tab-link" data-tab="tab-waiting">‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                <button class="tab-link" data-tab="tab-complete">‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                                <button class="tab-link" data-tab="tab-work-orders">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)</button>
                                <button class="tab-link" data-tab="tab-shipped">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>
                                <button class="tab-link" data-tab="tab-cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            </div>
                            <div id="tab-create" class="tab-content active">
                                <h2 id="form-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</h2>
                                <form id="order-form">
                                    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å</h3>
                                    <div class="form-grid form-grid-main">
                                        <div class="form-group"><label for="channel_code">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><select id="channel_code" required><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option></select></div>
                                        <div class="form-group"><label for="admin_user">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label><input type="text" id="admin_user" required readonly></div>
                                        <div class="form-group"><label for="customer_name">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="customer_name" required></div>
                                        <div class="form-group full-width"><label for="customer_address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><textarea id="customer_address" rows="4" required></textarea></div>
                                    </div>
                                    <hr>
                                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                                    
                                    <div class="batch-actions">
                                        <button type="button" id="download-template-btn" class="btn btn-info">üì• Download Template</button>
                                        <button type="button" id="import-excel-btn" class="btn btn-success">üì§ Import Multiple Orders</button>
                                        <button type="button" id="import-pgtr-btn" class="btn btn-primary">üì§ Import PGTR</button>
                                    </div>

                                    <div class="items-table-container"><table id="items-table"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å</th><th>‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</th><th>‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô</th><th>‡∏ü‡∏≠‡∏ô‡∏ï‡πå</th><th>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1</th><th>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2</th><th>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th><th></th></tr></thead><tbody id="items-tbody"></tbody></table></div><button type="button" id="add-item-btn" class="btn btn-secondary">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button><hr>
                                    
                                    <!-- ===== NEW LAYOUT FOR PAYMENT SECTION ===== -->
                                    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                                    <div class="form-grid">
                                        <div class="form-group"><label for="price">‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="number" id="price" value="0" step="0.01"></div>
                                        <div class="form-group"><label for="shipping_cost">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</label><input type="number" id="shipping_cost" value="0" step="0.01"></div>
                                        <div class="form-group"><label for="discount">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label><input type="number" id="discount" value="0" step="0.01"></div>
                                        <div class="form-group"><label for="total_amount">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label><input type="number" id="total_amount" readonly></div>
                                    </div>
                                    <div class="form-grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr;">
                                        <div class="form-group">
                                            <label for="payment_method">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
                                            <select id="payment_method">
                                                <option value="‡πÇ‡∏≠‡∏ô">‡πÇ‡∏≠‡∏ô</option>
                                                <option value="COD">COD</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="promotion">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</label>
                                            <input type="text" id="promotion">
                                        </div>
                                    </div>
                                    <!-- ===== END OF NEW LAYOUT ===== -->
                                    
                                    <div id="form-actions" style="margin-top: 25px; text-align: right;"></div>
                                </form>
                            </div>
                            <!-- ... The rest of the tabs are unchanged ... -->
                            <div id="tab-waiting" class="tab-content">
                                <div class="tab-filter"><label for="filter-waiting">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label><select id="filter-waiting"></select></div>
                                <div class="batch-actions">
                                    <button id="select-all-waiting-btn" class="btn btn-secondary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                    <button id="cancel-selected-waiting-btn" class="btn btn-danger">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                                </div>
                                <ul class="order-list"></ul>
                            </div>
                            <div id="tab-complete" class="tab-content">
                                <div class="tab-filter"><label for="filter-complete">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label><select id="filter-complete"></select></div>
                                <div class="batch-actions">
                                    <button id="select-all-complete-btn" class="btn btn-secondary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                    <button id="create-work-order-btn" class="btn btn-success">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                                    <button id="cancel-selected-complete-btn" class="btn btn-danger">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                                </div>
                                <ul class="order-list"></ul>
                            </div>
                            
                            <div id="tab-work-orders" class="tab-content">
                                <!-- Content is generated by JavaScript -->
                            </div>

                            <div id="tab-shipped" class="tab-content">
                                <div class="tab-filter"><label for="filter-shipped">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label><select id="filter-shipped"></select></div>
                                <div class="batch-actions">
                                    <button id="select-all-shipped-btn" class="btn btn-secondary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                </div>
                                <ul class="order-list"></ul>
                            </div>
                            
                            <div id="tab-cancelled" class="tab-content">
                                <div class="tab-filter"><label for="filter-cancelled">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label><select id="filter-cancelled"></select></div>
                                <div class="batch-actions">
                                    <button id="select-all-cancelled-btn" class="btn btn-secondary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                    <button id="restore-to-waiting-btn" class="btn btn-warning">‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ "‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</button>
                                    <button id="restore-to-complete-btn" class="btn btn-info">‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"</button>
                                </div>
                                <ul class="order-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="packing-system-container" class="system-content">
                    <div id="work-order-selection-view"><h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</h2><p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï" ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p><ul id="work-order-list"></ul></div>
                    <div id="packing-main-view"><header class="header"><h1 id="packing-header-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</h1><div class="action-buttons"><button id="back-to-wo-selection" class="btn btn-back">‚ùÆ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</button><button id="export-all-button" class="btn btn-export" disabled>üì• Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div></header><div class="main-container"><nav id="order-nav-panel"><div id="nav-header"><span id="order-counter">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span><input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏..."></div><ul id="order-list"></ul></nav><main id="content-panel"><div id="action-panel" style="display: none;"><div class="action-step"><h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3><input type="text" id="item-scan-input" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î Item UID"></div><div class="action-step"><h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3><input type="text" id="confirmation-input" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á" disabled></div><p id="status-message"></p></div><div id="result-container"></div></main></div></div>
                    <audio id="success-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio><audio id="error-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>
                </div>
            </main>
        </div>
    </div>
    
    <script>
    // The entire script block from your original file remains here.
    // It's very long, so I'll just indicate that it's the same.
    // Make sure to copy the *entire* <script> block from your
    // last working version (the one I provided that fixed the CSV import).
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & GLOBAL STATE ---
        const SUPABASE_URL = 'https://scxcuwjhjbkxvqmpywqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeGN1d2poamJreHZxbXB5d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODM4NTMsImV4cCI6MjA3NDg1OTg1M30.UqcmQUxCkOxgDxjtUa8Sbb0cLHT26qOuHfdbtdilkI8';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let loggedInUsername = null;

        // --- CORE UI ELEMENTS ---
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const navLinks = document.querySelectorAll('.nav-link');
        const systemContents = document.querySelectorAll('.system-content');
        const loginOverlay = document.getElementById('login-overlay');
        const mainAppContainer = document.getElementById('main-app-container');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutBtn = document.getElementById('logout-btn');

        // --- CORE APP LOGIC ---
        sidebarToggle.addEventListener('click', () => document.body.classList.toggle('sidebar-collapsed'));

        navLinks.forEach(link => {
            // Updated logic to handle navigation without breaking for the new external link
            if (link.hasAttribute('data-target')) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Don't deactivate the accounting link if it was clicked
                    if (e.currentTarget.getAttribute('href') !== 'accounting.html') {
                       document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                       e.currentTarget.classList.add('active');
                    }
                    const targetId = link.getAttribute('data-target');
                    systemContents.forEach(content => content.classList.toggle('active', content.id === targetId));
                    if (targetId === 'packing-system-container') {
                        window.packingSystem.loadWorkOrdersForPacking();
                    }
                });
            }
        });

        async function mainAppInitializer(user) {
            loadingOverlay.style.display = 'flex';
            try {
                const { data: userData, error } = await supabaseClient.from('users').select('username').eq('id', user.id).single();
                if (error || !userData) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                
                loggedInUsername = userData.username;
                welcomeMessage.textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${loggedInUsername}`;
                
                loginOverlay.style.display = 'none';
                mainAppContainer.style.display = 'flex';
                
                await window.orderSystem.initializeApp(loggedInUsername);

            } catch (err) {
                alert(err.message); await logout();
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); errorMessage.textContent = ''; loadingOverlay.style.display = 'flex';
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            loadingOverlay.style.display = 'none';
            if (error) { errorMessage.textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; } 
            else if (data.user) { await mainAppInitializer(data.user); }
        });

        async function logout() {
            await supabaseClient.auth.signOut(); loggedInUsername = null;
            mainAppContainer.style.display = 'none';
            loginOverlay.style.display = 'flex';
            document.getElementById('email').value = ''; document.getElementById('password').value = ''; errorMessage.textContent = '';
        }
        logoutBtn.addEventListener('click', logout);

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) { await mainAppInitializer(session.user); } 
            else { 
                loginOverlay.style.display = 'flex'; 
                mainAppContainer.style.display = 'none'; 
            }
        }
        
        // --- ORDER SYSTEM MODULE ---
        window.orderSystem = (() => {
            const container = document.getElementById('order-system-container');
            const adminUserInput = container.querySelector('#admin_user');
            const itemsTbody = container.querySelector('#items-tbody');
            const formActions = container.querySelector('#form-actions');
            const orderForm = container.querySelector('#order-form');
            const tabLinks = container.querySelectorAll('.tab-link');
            const addItemBtn = container.querySelector('#add-item-btn');
            const trackingFileInput = document.getElementById('tracking-file-input');
            const workOrdersTab = container.querySelector('#tab-work-orders');
            const downloadTemplateBtn = document.getElementById('download-template-btn');
            const importExcelBtn = document.getElementById('import-excel-btn');
            const importExcelInput = document.getElementById('import-excel-input');
            const importPgtrBtn = document.getElementById('import-pgtr-btn');
            const importPgtrInput = document.getElementById('import-pgtr-input');
            let productList = [], channelList = [], allOrdersData = [], allWorkOrdersData = [], inkTypeList = [], currentEditingOrderId = null;

            async function initializeApp(username) {
                adminUserInput.value = username;
                await loadInitialData();
                setFormMode('create');
                initializeEventListeners();
            }

            async function loadInitialData() {
                loadingOverlay.style.display = 'flex';
                try {
                    const [productsRes, ordersRes, channelsRes, workOrdersRes, inkTypesRes] = await Promise.all([
                        supabaseClient.from('products').select('id, product_name'),
                        supabaseClient.from('orders').select('*, order_items(*)').order('created_at', { ascending: false }),
                        supabaseClient.from('channels').select('channel_code, channel_name'),
                        supabaseClient.from('work_orders').select('*').order('created_at', { ascending: false }),
                        supabaseClient.from('ink_types').select('ink_name').order('id')
                    ]);
                    if (productsRes.error) throw new Error('Could not load products');
                    productList = productsRes.data.map(p => ({ id: p.id, text: p.product_name }));
                    if (channelsRes.error) throw new Error('Could not load channels');
                    channelList = channelsRes.data;
                    if (inkTypesRes.error) throw new Error('Could not load ink types');
                    inkTypeList = inkTypesRes.data;
                    populateChannelDropdowns();
                    if (ordersRes.error) throw new Error('Could not load orders');
                    allOrdersData = ordersRes.data;
                    if (workOrdersRes.error) throw new Error('Could not load work orders');
                    allWorkOrdersData = workOrdersRes.data;
                    renderAllTabs();
                } catch(err) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function renderAllTabs() {
                const filters = { waiting: container.querySelector('#filter-waiting').value, complete: container.querySelector('#filter-complete').value, cancelled: container.querySelector('#filter-cancelled').value, shipped: container.querySelector('#filter-shipped').value };
                const lists = { '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': container.querySelector('#tab-waiting .order-list'), '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': container.querySelector('#tab-complete .order-list'), '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å': container.querySelector('#tab-cancelled .order-list'), '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß': container.querySelector('#tab-shipped .order-list') };
                const workOrderContainer = container.querySelector('#tab-work-orders');
                Object.values(lists).forEach(list => { if(list) list.innerHTML = ''; });
                if(workOrderContainer) workOrderContainer.innerHTML = '';

                allOrdersData.forEach(order => {
                    const list = lists[order.status];
                    if (list) {
                        const tabId = list.parentElement.id;
                        const filterKey = tabId.split('-')[1];
                        const filterValue = filters[filterKey];
                        if (filterValue === 'all' || filterValue === order.channel_code) {
                            const trackingHTML = order.tracking_number
                                ? `<span class="order-tracking">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: <span class="tracking-text">${order.tracking_number}</span> <button class="btn btn-sm btn-edit-tracking" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏">‚úèÔ∏è</button></span>`
                                : '';
                            list.innerHTML += `<li class="order-list-item" data-order-id="${order.id}"><input type="checkbox" class="order-checkbox"><div class="order-info"><strong>${order.bill_no || 'N/A'}</strong><span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${order.customer_name || 'N/A'}</span>${trackingHTML}</div><div class="order-list-item-details"><span>${order.work_order_name || ''}</span><span>${new Date(order.created_at).toLocaleDateString('th-TH')}</span></div></li>`;
                        }
                    }
                });

                allWorkOrdersData.forEach(wo => {
                    const billsInWorkOrder = allOrdersData.filter(order => order.work_order_name === wo.work_order_name);
                    const groupEl = document.createElement('div');
                    groupEl.className = 'work-order-group';
                    let billsHTML = '<ul class="order-list">';
                    billsInWorkOrder.forEach(bill => { 
                        const trackingHTML = bill.tracking_number
                            ? `<span class="order-tracking">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: <span class="tracking-text">${bill.tracking_number}</span> <button class="btn btn-sm btn-edit-tracking" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏">‚úèÔ∏è</button></span>`
                            : '';
                        billsHTML += `<li class="order-list-item" data-order-id="${bill.id}"><input type="checkbox" class="order-checkbox"><div class="order-info"><strong>${bill.bill_no}</strong><span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${bill.customer_name || 'N/A'}</span>${trackingHTML}</div></li>`; 
                    });
                    billsHTML += '</ul>';
                    
                    groupEl.innerHTML = `
                        <div class="work-order-header"> 
                            <span class="wo-name">${wo.work_order_name} (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${billsInWorkOrder.length} ‡∏ö‡∏¥‡∏•)</span>
                            <div class="wo-header-actions">
                                <button class="btn btn-primary btn-sm export-production-btn" data-work-order-name="${wo.work_order_name}">üì§ Export ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï</button>
                                <button class="btn btn-warning btn-sm prepare-waybill-btn" data-work-order-name="${wo.work_order_name}">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ó‡∏≥‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤</button>
                                <button class="btn btn-info btn-sm import-wo-csv-btn" data-work-order-name="${wo.work_order_name}">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</button>
                                <button class="btn btn-danger btn-sm cancel-wo-btn" data-work-order-name="${wo.work_order_name}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</button>
                            </div>
                        </div>
                        <div class="work-order-bills">
                            <div class="batch-actions">
                                <button class="btn btn-secondary select-all-in-wo-btn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <button class="btn btn-warning revert-to-waiting-btn" data-work-order-name="${wo.work_order_name}">‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ "‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</button>
                                <button class="btn btn-info revert-to-complete-btn" data-work-order-name="${wo.work_order_name}">‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏õ "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"</button>
                                <button class="btn btn-danger cancel-bills-from-wo-btn" data-work-order-name="${wo.work_order_name}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                            </div>
                            ${billsHTML}
                        </div>`;
                    workOrderContainer.appendChild(groupEl);
                });
            }

            function prepareForWaybill(workOrderName) {
                const ordersToProcess = allOrdersData.filter(order => order.work_order_name === workOrderName);
                if (ordersToProcess.length === 0) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ"); return; }
                const headers = ['bill_no', 'customer_address', 'payment_method', 'total_amount'];
                const rows = ordersToProcess.map(order => {
                    const escapeCsvField = (field) => {
                        const strField = String(field || '');
                        if (strField.includes(',') || strField.includes('"') || strField.includes('\n')) { return `"${strField.replace(/"/g, '""')}"`; }
                        return strField;
                    };
                    return [
                        escapeCsvField(order.bill_no), escapeCsvField(order.customer_address),
                        escapeCsvField(order.payment_method), escapeCsvField(order.total_amount)
                    ].join(',');
                });
                const csvContent = [headers.join(','), ...rows].join('\n');
                try {
                    localStorage.setItem('waybillDataForFlash', csvContent);
                    localStorage.setItem('workOrderNameForFlash', workOrderName);
                    window.open('flash_express_tool.html', '_blank');
                } catch (e) {
                    console.error("Error accessing localStorage or opening new window:", e);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå");
                }
            }
            
            async function handleTrackingImport(file) {
                if (!file) return;
                loadingOverlay.style.display = 'flex';
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const csv = event.target.result;
                        const lines = csv.split(/[\r\n]+/).filter(line => line.trim() !== '');
                        if (lines.length <= 1) throw new Error('‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        const billNoIndex = headers.indexOf('bill_no');
                        const trackingIndex = headers.indexOf('tracking_number');
                        if (billNoIndex === -1 || trackingIndex === -1) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ bill_no ‡πÅ‡∏•‡∏∞ tracking_number ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV');
                        
                        const updates = lines.slice(1).map(line => {
                            const values = line.split(',');
                            const bill_no = values[billNoIndex]?.trim().replace(/"/g, '');
                            const tracking_number = values[trackingIndex]?.trim().replace(/"/g, '');
                            if (!bill_no || !tracking_number) return null;
                            return { bill_no, tracking_number };
                        }).filter(Boolean);

                        if (updates.length === 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV');
                        const { data: updatedCount, error } = await supabaseClient.rpc('update_tracking_numbers_batch', { p_updates: updates });
                        if (error) throw error;
                        alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ ${updatedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                        await loadInitialData();
                    } catch (err) {
                        console.error('Error importing tracking numbers:', err);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤: ' + err.message);
                    } finally {
                        loadingOverlay.style.display = 'none';
                        trackingFileInput.value = '';
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }

            function downloadOrderTemplate() {
                const headers = [
                    "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞", "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô",
                    "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å", "‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà", "‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô", "‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô", "‡∏ü‡∏≠‡∏ô‡∏ï‡πå", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", "‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö"
                ];
                
                const sampleData = [
                    [
                        "SP", "‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ", "123/45 ‡∏ñ.‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á ‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢ ‡∏Å‡∏ó‡∏°. 10110", 300, 30, 0, "‡πÇ‡∏≠‡∏ô", "‡πÇ‡∏õ‡∏£ 9.9",
                        "‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏µ‡∏î‡∏ï‡∏¥‡∏î", "‡∏î‡∏≥", "A1", "‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢", "‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥", "TH-Sarabun", "‡∏î.‡∏ä. ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏ä‡∏±‡πâ‡∏ô ‡∏õ.1", "", 2, "‡πÑ‡∏°‡πà‡∏°‡∏µ", ""
                    ],
                    [
                        "", "", "", "", "", "", "", "",
                        "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≥", "‡∏™‡∏µ", "B2", "‡πÑ‡∏î‡πÇ‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå", "‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏ô‡∏≤", "TH-Mali", "‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏≠‡πÉ‡∏à", "", "", 1, "‡∏Ç‡∏≠‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô", ""
                    ],
                    [
                        "LAZ", "‡∏™‡∏°‡∏®‡∏£‡∏µ ‡∏°‡∏µ‡∏™‡∏∏‡∏Ç", "456 ‡∏´‡∏°‡∏π‡πà 7 ‡∏ï.‡∏™‡∏∏‡πÄ‡∏ó‡∏û ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà 50200", 159, 25, 10, "COD", "",
                        "‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏µ‡∏î‡∏ï‡∏¥‡∏î", "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", "A5", "‡∏à‡∏£‡∏ß‡∏î", "‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥", "TH-Sarabun", "‡∏î.‡∏ä. ‡∏°‡∏≤‡∏ô‡∏∞", "‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3", "", 1, "", ""
                    ]
                ];
                
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "OrderTemplate");
                XLSX.writeFile(workbook, "TRKids_Multi_Order_Template_Simple.xlsx");
            }
            
            async function processAndSaveImportedOrders(ordersToImport) {
                loadingOverlay.style.display = 'flex';
                let successCount = 0;
                let totalItemsCount = 0;
                let failedOrders = [];

                for (const order of ordersToImport) {
                    try {
                        const billNo = await generateNextBillNo(order.channel_code);
                        const orderData = { ...order };
                        delete orderData.items; 

                        const { data: insertedOrder, error: orderError } = await supabaseClient
                            .from('orders').insert({ ...orderData, bill_no: billNo }).select().single();
                        if (orderError) throw orderError;
                        
                        const allItemsToInsert = [];
                        let itemSequence = 1;
                        for (const item of order.items) {
                            const quantity = item.quantity || 1;
                            const baseItemData = { ...item };
                            delete baseItemData.quantity;

                            for (let i = 0; i < quantity; i++) {
                                allItemsToInsert.push({
                                    ...baseItemData,
                                    order_id: insertedOrder.id,
                                    bill_no: billNo,
                                    item_uid: `${billNo}-${itemSequence++}`
                                });
                            }
                        }

                        if (allItemsToInsert.length > 0) {
                            const { error: itemsError } = await supabaseClient.from('order_items').insert(allItemsToInsert);
                            if (itemsError) throw itemsError;
                            totalItemsCount += allItemsToInsert.length;
                        }
                        successCount++;
                    } catch (err) {
                        console.error(`Error processing order for ${order.customer_name}:`, err);
                        failedOrders.push(order.customer_name || 'N/A');
                    }
                }
                
                loadingOverlay.style.display = 'none';
                let alertMessage = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏£‡∏ß‡∏° ${totalItemsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)`;
                if (failedOrders.length > 0) {
                    alertMessage += `\n\n‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á: ${failedOrders.join(', ')}.`;
                }
                alert(alertMessage);
                await loadInitialData();
            }

            function handleExcelImport(file) {
                if (!file) return;
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        const rowsData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                        if (rowsData.length <= 1) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel");

                        const processedOrders = [];
                        let currentOrder = null;

                        for (let i = 1; i < rowsData.length; i++) {
                            const row = rowsData[i];
                             if (row.every(cell => String(cell).trim() === '')) continue;
                            
                            const channelCode = String(row[0]).trim();
                            const customerName = String(row[1]).trim();
                            const productName = String(row[8]).trim();

                            if (channelCode && customerName) {
                                const price = parseFloat(row[3]) || 0;
                                const shippingCost = parseFloat(row[4]) || 0;
                                const discount = parseFloat(row[5]) || 0;
                                
                                currentOrder = {
                                    channel_code: channelCode, customer_name: customerName, customer_address: String(row[2]),
                                    price: price, shipping_cost: shippingCost, discount: discount, total_amount: price + shippingCost - discount,
                                    payment_method: String(row[6]), promotion: String(row[7]),
                                    admin_user: loggedInUsername, 
                                    status: '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                                    entry_date: new Date().toISOString().slice(0, 10),
                                    items: []
                                };
                                processedOrders.push(currentOrder);
                            }

                            if (productName) {
                                if (!currentOrder) throw new Error(`‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${productName}' ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß ${i + 1} ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå`);
                                
                                const product = productList.find(p => p.text.toLowerCase().includes(productName.toLowerCase()));
                                if (!product) {
                                    console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${productName}' ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß ${i+1} - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ`);
                                    continue;
                                }

                                const itemData = {
                                    product_id: product.id, product_name: product.text,
                                    ink_color: String(row[9]), product_type: String(row[10]), cartoon_pattern: String(row[11]),
                                    line_pattern: String(row[12]), font: String(row[13]), line_1: String(row[14]),
                                    line_2: String(row[15]), line_3: String(row[16]), 
                                    quantity: parseInt(row[17]) || 1, 
                                    notes: String(row[18]), file_attachment: String(row[19])
                                };
                                currentOrder.items.push(itemData);
                            }
                        }

                        if (processedOrders.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå");

                        if (confirm(`‡∏û‡∏ö ${processedOrders.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                             await processAndSaveImportedOrders(processedOrders);
                        }
                        
                    } catch (err) {
                        console.error('Error importing Excel file:', err);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: ' + err.message);
                    } finally {
                        importExcelInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function handlePgtrImport(file) {
                if (!file) return;
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const originalDataArray = XLSX.utils.sheet_to_json(worksheet);

                        if (originalDataArray.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel");

                        const processedOrders = [];

                        for (const row of originalDataArray) {
                            const comment = row["comment"] || "";
                            const remark = row["remark"] || "";
                            const transformedRow = {
                                "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á": "PGTR",
                                "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤": row["‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö"],
                                "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤": `${row["‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö"] || ''},${row["‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°"] || ''},${row["‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] || ''}`,
                                "‡∏£‡∏≤‡∏Ñ‡∏≤": parseFloat(row["‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î"]) || 0,
                                "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á": parseFloat(row["‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á"]) || 0,
                                "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î": parseFloat(row["‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î admin"]) || 0,
                                "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞": "‡πÇ‡∏≠‡∏ô",
                                "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô": "",
                                "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": row["‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"],
                                "‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å": `${row["Ink"] || ''}${row["‡∏™‡∏µ"] || ''}`,
                                "‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà": "", 
                                "‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô": row["‡∏£‡∏´‡∏±‡∏™‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö"],
                                "‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô": row["Underline"],
                                "‡∏ü‡∏≠‡∏ô‡∏ï‡πå": row["‡∏ü‡∏≠‡∏ô‡∏ï‡πå"],
                                "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1": row["Label1"],
                                "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2": row["Label2"],
                                "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3": row["Label3"],
                                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": parseInt(row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]) || 1,
                                "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏": comment && remark ? `${comment},${remark}` : (comment || remark),
                                "‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö": ""
                            };
                            
                            const price = transformedRow.‡∏£‡∏≤‡∏Ñ‡∏≤;
                            const shippingCost = transformedRow.‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á;
                            const discount = transformedRow.‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î;

                            const product = productList.find(p => p.text.toLowerCase().includes(String(transformedRow.‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤).toLowerCase()));
                            if (!product) {
                                console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${transformedRow.‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤}' ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PGTR - ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á '${transformedRow.‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤}' ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ`);
                                continue;
                            }
                            
                            const order = {
                                channel_code: transformedRow.‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á,
                                customer_name: transformedRow.‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤,
                                customer_address: transformedRow.‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤,
                                price: price,
                                shipping_cost: shippingCost,
                                discount: discount,
                                total_amount: price + shippingCost - discount,
                                payment_method: transformedRow.‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞,
                                promotion: transformedRow.‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô,
                                admin_user: loggedInUsername,
                                status: '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                                entry_date: new Date().toISOString().slice(0, 10),
                                items: [{
                                    product_id: product.id,
                                    product_name: product.text,
                                    ink_color: transformedRow.‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å,
                                    product_type: transformedRow.‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà,
                                    cartoon_pattern: transformedRow.‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô,
                                    line_pattern: transformedRow.‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô,
                                    font: transformedRow.‡∏ü‡∏≠‡∏ô‡∏ï‡πå,
                                    line_1: transformedRow["‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1"],
                                    line_2: transformedRow["‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2"],
                                    line_3: transformedRow["‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3"],
                                    quantity: transformedRow.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,
                                    notes: transformedRow.‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,
                                    file_attachment: transformedRow.‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
                                }]
                            };
                            processedOrders.push(order);
                        }

                        if (processedOrders.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå");

                        if (confirm(`‡∏û‡∏ö ${processedOrders.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PGTR ‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                             await processAndSaveImportedOrders(processedOrders);
                        }
                        
                    } catch (err) {
                        console.error('Error importing PGTR file:', err);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå PGTR: ' + err.message);
                    } finally {
                        importPgtrInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function toggleWorkOrder(headerElement) { 
                const content = headerElement.nextElementSibling; 
                if (content) { content.classList.toggle('show'); } 
            }
            function populateChannelDropdowns() { const dropdowns = [ container.querySelector('#channel_code'), container.querySelector('#filter-waiting'), container.querySelector('#filter-complete'), container.querySelector('#filter-cancelled'), container.querySelector('#filter-shipped') ]; dropdowns.forEach(dropdown => { if (!dropdown) return; const isFilter = dropdown.id.startsWith('filter-'); dropdown.innerHTML = isFilter ? '<option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' : '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option>'; channelList.forEach(ch => { const opt = document.createElement('option'); opt.value = ch.channel_code; opt.textContent = ch.channel_name; dropdown.appendChild(opt); }); }); }
            function openTab(evt, tabName) { container.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active')); container.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active')); container.querySelector(`#${tabName}`).classList.add('active'); evt.currentTarget.classList.add('active'); if (tabName === 'tab-create') { setFormMode('create'); } }
            
            function setFormMode(mode, order = null) {
                orderForm.reset(); itemsTbody.innerHTML = ''; currentEditingOrderId = null;
                $(container.querySelectorAll('select')).val(null).trigger('change');
                adminUserInput.value = loggedInUsername;

                if (mode === 'create') {
                    container.querySelector('#form-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà';
                    addItemRow();
                    formActions.innerHTML = `<button type="button" class="btn btn-secondary" id="save-waiting-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</button> <button type="button" class="btn btn-success" id="save-complete-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)</button>`;
                } else if (mode === 'edit' && order) {
                    container.querySelector('#form-title').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå: ${order.bill_no}`;
                    currentEditingOrderId = order.id;
                    Object.keys(order).forEach(key => {
                        const input = container.querySelector(`#${key}`);
                        if (input) {
                            if (input.tagName === 'SELECT') { $(input).val(order[key]).trigger('change'); } 
                            else { input.value = order[key]; }
                        }
                    });

                    const itemGroups = {};
                    (order.order_items || []).forEach(item => {
                        const key = [item.product_id, item.ink_color, item.product_type, item.cartoon_pattern, item.line_pattern, item.font, item.line_1, item.line_2, item.line_3, item.notes, item.file_attachment].join('||');
                        if (!itemGroups[key]) {
                            itemGroups[key] = { ...item, quantity: 1 };
                        } else {
                            itemGroups[key].quantity++;
                        }
                    });

                    Object.values(itemGroups).forEach(groupedItem => {
                        addItemRow(groupedItem);
                    });

                    if (order.status === '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') {
                        formActions.innerHTML = `<button type="button" class="btn btn-primary" id="update-waiting-btn">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</button> <button type="button" class="btn btn-success" id="move-to-complete-btn">‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"</button> <button type="button" class="btn btn-danger" id="cancel-bill-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</button>`;
                    } else if (order.status === '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') {
                        formActions.innerHTML = `<button type="button" class="btn btn-primary" id="update-complete-btn">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button> <button type="button" class="btn btn-danger" id="cancel-bill-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</button>`;
                    } else {
                        formActions.innerHTML = ``;
                    }
                }
                attachFormActionListeners(order);
                calculateTotal();
            }

            async function loadOrderForEditing(orderId) { loadingOverlay.style.display = 'flex'; try { const orderData = allOrdersData.find(o => o.id == orderId); if(!orderData) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); openTab({ currentTarget: container.querySelector('.tab-link[data-tab="tab-create"]') }, 'tab-create'); setFormMode('edit', orderData); } catch (error) { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ: ' + error.message); } finally { loadingOverlay.style.display = 'none'; } }
            async function moveOrder(orderId, newStatus) { if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "${newStatus}"?`)) return; loadingOverlay.style.display = 'flex'; try { const { error } = await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId); if (error) throw error; alert(`‡∏¢‡πâ‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`); await loadInitialData(); setFormMode('create'); } catch(error) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); } finally { loadingOverlay.style.display = 'none'; } }
            
            itemsTbody.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = (e.clipboardData || window.clipboardData).getData('text');
                const rowsData = pasteData.split(/[\r\n]+/).filter(row => row.trim() !== '');
                let targetCell = e.target.closest('td'); if (!targetCell) return;
                let startRowIndex = Array.from(itemsTbody.children).indexOf(targetCell.parentElement);
                let startCellIndex = targetCell.cellIndex;
                rowsData.forEach((rowData, rowIndex) => {
                    const cellsData = rowData.split('\t'); let currentRow; const currentRowIndex = startRowIndex + rowIndex;
                    if (currentRowIndex >= itemsTbody.rows.length) { addItemRow(); }
                    currentRow = itemsTbody.rows[currentRowIndex]; if (!currentRow) return;
                    cellsData.forEach((cellData, cellIndex) => {
                        const targetCellIndex = startCellIndex + cellIndex;
                        if (targetCellIndex < currentRow.cells.length - 1) { 
                            const input = currentRow.cells[targetCellIndex].querySelector('input, select');
                            if (input) {
                                if (input.tagName === 'SELECT') {
                                    const matchedOption = [...input.options].find(opt => opt.text.toLowerCase().includes(cellData.trim().toLowerCase()));
                                    if(matchedOption) input.value = matchedOption.value;
                                } else { input.value = cellData.trim(); }
                            }
                        }
                    });
                });
            });

            function addItemRow(item = null) {
                const row = itemsTbody.insertRow();
                row.innerHTML = `<td><select class="item-product"></select></td><td><select class="item-ink_color"><option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ--</option></select></td><td><input type="text" class="item-shelf_location"></td><td><input type="text" class="item-cartoon_pattern"></td><td><input type="text" class="item-line_pattern"></td><td><input type="text" class="item-font"></td><td><input type="text" class="item-line_1"></td><td><input type="text" class="item-line_2"></td><td><input type="text" class="item-line_3"></td><td><input type="number" class="item-quantity quantity-input" value="1" min="1"></td><td><input type="text" class="item-notes"></td><td><input type="text" class="item-file_attachment"></td><td class="action-cell"><button type="button" class="btn btn-danger remove-item-btn">X</button></td>`;
                
                const productSelect = $(row.querySelector('.item-product'));
                productSelect.select2({ data: productList, placeholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', width: '100%' });

                const inkSelect = row.querySelector('.item-ink_color');
                inkTypeList.forEach(ink => {
                    const opt = document.createElement('option');
                    opt.value = ink.ink_name;
                    opt.textContent = ink.ink_name;
                    inkSelect.appendChild(opt);
                });
                
                if (item) {
                    productSelect.val(item.product_id).trigger('change');
                    inkSelect.value = item.ink_color || '';
                    row.querySelector('.item-shelf_location').value = item.product_type || '';
                    row.querySelector('.item-cartoon_pattern').value = item.cartoon_pattern || '';
                    row.querySelector('.item-line_pattern').value = item.line_pattern || '';
                    row.querySelector('.item-font').value = item.font || '';
                    row.querySelector('.item-line_1').value = item.line_1 || '';
                    row.querySelector('.item-line_2').value = item.line_2 || '';
                    row.querySelector('.item-line_3').value = item.line_3 || '';
                    row.querySelector('.item-notes').value = item.notes || '';
                    row.querySelector('.item-file_attachment').value = item.file_attachment || '';
                    row.querySelector('.item-quantity').value = item.quantity || 1;
                }
            }
            
            function selectAll(tabKey) { const list = container.querySelector(`#tab-${tabKey} .order-list`); if (!list) return; const checkboxes = list.querySelectorAll('.order-checkbox'); const isAllChecked = Array.from(checkboxes).every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !isAllChecked); }
            function getSelectedOrderIds(listContainer) { return Array.from(listContainer.querySelectorAll('.order-checkbox:checked')).map(cb => cb.closest('.order-list-item').dataset.orderId); }
            
            async function createWorkOrder() { const selectedIds = getSelectedOrderIds(container.querySelector('#tab-complete .order-list')); if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); const firstOrder = allOrdersData.find(o => o.id == selectedIds[0]); const channelCode = firstOrder.channel_code; const today = new Date().toISOString().slice(0, 10); if (!selectedIds.every(id => allOrdersData.find(o => o.id == id).channel_code === channelCode)) { return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); } loadingOverlay.style.display = 'flex'; try { const { data: batchNumber, error: rpcError } = await supabaseClient.rpc('get_next_batch_number', { p_channel_code: channelCode, p_date: today }); if (rpcError) throw rpcError; const datePart = new Date().toLocaleDateString('th-TH', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, ''); const workOrderName = `${channelCode}-${datePart}-R${batchNumber}`; const { error: woError } = await supabaseClient.from('work_orders').insert({ work_order_name: workOrderName, channel_code: channelCode, production_date: today, batch_number: batchNumber, order_count: selectedIds.length, created_by: loggedInUsername }); if (woError) throw woError; const { error: updateError } = await supabaseClient.from('orders').update({ status: '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï)', work_order_name: workOrderName }).in('id', selectedIds); if (updateError) throw updateError; alert(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô "${workOrderName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`); await loadInitialData(); } catch (error) { console.error('Error creating work order:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            async function cancelSelectedOrders(tabKey) { const selectedIds = getSelectedOrderIds(container.querySelector(`#tab-${tabKey} .order-list`)); if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'); if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ${selectedIds.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå?`)) return; loadingOverlay.style.display = 'flex'; try { const { error } = await supabaseClient.from('orders').update({ status: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }).in('id', selectedIds); if (error) throw error; alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await loadInitialData(); } catch (error) { alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            
            async function restoreSelectedOrders(newStatus) {
                const selectedIds = getSelectedOrderIds(container.querySelector('#tab-cancelled .order-list'));
                if (selectedIds.length === 0) {
                    return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö');
                }
                const statusText = newStatus === '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' ? '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå ${selectedIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "${statusText}"?`)) {
                    return;
                }
                loadingOverlay.style.display = 'flex';
                try {
                    const { error } = await supabaseClient.from('orders').update({ status: newStatus }).in('id', selectedIds);
                    if (error) throw error;
                    alert('‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    await loadInitialData();
                } catch (error) {
                    alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function selectAllInWorkOrder(buttonElement) { const billsContainer = buttonElement.closest('.work-order-bills'); const checkboxes = billsContainer.querySelectorAll('.order-checkbox'); const isAllChecked = Array.from(checkboxes).every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !isAllChecked); }
            
            async function updateWorkOrderCount(workOrderName) {
                const { count, error: countError } = await supabaseClient.from('orders').select('id', { count: 'exact', head: true }).eq('work_order_name', workOrderName);
                if (countError) throw countError;
                if (count === 0) { await supabaseClient.from('work_orders').delete().eq('work_order_name', workOrderName); } 
                else { await supabaseClient.from('work_orders').update({ order_count: count }).eq('work_order_name', workOrderName); }
            }

            async function revertSelectedBills(workOrderName, newStatus) { const groupEl = Array.from(container.querySelectorAll('.work-order-header')).find(h => h.textContent.includes(workOrderName)).parentElement; const selectedIds = getSelectedOrderIds(groupEl); if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'); if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${selectedIds.length} ‡∏ö‡∏¥‡∏• ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà "${newStatus}"?`)) return; loadingOverlay.style.display = 'flex'; try { const { error: updateError } = await supabaseClient.from('orders').update({ status: newStatus, work_order_name: null }).in('id', selectedIds); if (updateError) throw updateError; await updateWorkOrderCount(workOrderName); alert('‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await loadInitialData(); } catch (error) { console.error('Error reverting bills:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            async function cancelSelectedBillsFromWorkOrder(workOrderName) { const groupEl = Array.from(container.querySelectorAll('.work-order-header')).find(h => h.textContent.includes(workOrderName)).parentElement; const selectedIds = getSelectedOrderIds(groupEl); if (selectedIds.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'); if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å** ${selectedIds.length} ‡∏ö‡∏¥‡∏• ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?`)) return; loadingOverlay.style.display = 'flex'; try { const { error: updateError } = await supabaseClient.from('orders').update({ status: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', work_order_name: null }).in('id', selectedIds); if (updateError) throw updateError; await updateWorkOrderCount(workOrderName); alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await loadInitialData(); } catch (error) { console.error('Error cancelling bills from work order:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            async function cancelWorkOrder(workOrderName) { if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô** "${workOrderName}"? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"`)) return; loadingOverlay.style.display = 'flex'; try { const { error: updateError } = await supabaseClient.from('orders').update({ status: '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', work_order_name: null }).eq('work_order_name', workOrderName); if (updateError) throw updateError; const { error: deleteError } = await supabaseClient.from('work_orders').delete().eq('work_order_name', workOrderName); if (deleteError) throw deleteError; alert(`‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏á‡∏≤‡∏ô "${workOrderName}" ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`); await loadInitialData(); } catch (error) { console.error('Error cancelling work order:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; } }
            
            async function saveOrUpdateOrder(status) {
                loadingOverlay.style.display = 'flex';
                const isUpdate = !!currentEditingOrderId;
                try {
                    const channelCode = container.querySelector('#channel_code').value;
                    if (!channelCode) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á");
                    let billNo;
                    if (!isUpdate) {
                        billNo = await generateNextBillNo(channelCode);
                    } else {
                        const order = allOrdersData.find(o => o.id === currentEditingOrderId);
                        billNo = order.bill_no;
                    }

                    const orderData = {
                        channel_code: channelCode, bill_no: billNo, status: isUpdate ? (status || allOrdersData.find(o => o.id === currentEditingOrderId).status) : status,
                        entry_date: new Date().toISOString().slice(0, 10), customer_name: container.querySelector('#customer_name').value, price: parseFloat(container.querySelector('#price').value),
                        shipping_cost: parseFloat(container.querySelector('#shipping_cost').value), discount: parseFloat(container.querySelector('#discount').value), total_amount: parseFloat(container.querySelector('#total_amount').value),
                        payment_method: container.querySelector('#payment_method').value, admin_user: adminUserInput.value, customer_address: container.querySelector('#customer_address').value, promotion: container.querySelector('#promotion').value,
                    };
                    let upsertedOrderId = currentEditingOrderId;
                    if (isUpdate) {
                        const { error } = await supabaseClient.from('orders').update(orderData).eq('id', currentEditingOrderId); if (error) throw error;
                    } else {
                        const { data: insertedOrder, error } = await supabaseClient.from('orders').insert(orderData).select().single(); if (error) throw error;
                        upsertedOrderId = insertedOrder.id;
                    }
                    await supabaseClient.from('order_items').delete().eq('order_id', upsertedOrderId);
                    
                    let allItemsToInsert = [];
                    let itemSequence = 1;
                    for (const row of itemsTbody.rows) {
                        const selectedData = $(row).find('.item-product').select2('data')[0];
                        if (!selectedData || !selectedData.id) continue;
                        const quantity = parseInt(row.querySelector('.item-quantity').value) || 1;
                        const baseItemData = { 
                            order_id: upsertedOrderId, bill_no: billNo, product_id: selectedData.id, product_name: selectedData.text, 
                            ink_color: row.querySelector('.item-ink_color').value, product_type: row.querySelector('.item-shelf_location').value, 
                            cartoon_pattern: row.querySelector('.item-cartoon_pattern').value, line_pattern: row.querySelector('.item-line_pattern').value, 
                            font: row.querySelector('.item-font').value, line_1: row.querySelector('.item-line_1').value, 
                            line_2: row.querySelector('.item-line_2').value, line_3: row.querySelector('.item-line_3').value, 
                            notes: row.querySelector('.item-notes').value, file_attachment: row.querySelector('.item-file_attachment').value 
                        };
                        for (let i = 0; i < quantity; i++) {
                            allItemsToInsert.push({ ...baseItemData, item_uid: `${billNo}-${itemSequence++}` }); 
                        }
                    }
                    if (allItemsToInsert.length > 0) { const { error: itemsError } = await supabaseClient.from('order_items').insert(allItemsToInsert); if (itemsError) throw itemsError; }
                    alert(isUpdate ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•: ${billNo}`);
                    await loadInitialData(); setFormMode('create');
                } catch (error) { console.error('Error saving/updating order:', error); alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; }
            }
            
            function enterTrackingEditMode(trackingSpan) {
                const trackingTextEl = trackingSpan.querySelector('.tracking-text');
                const currentTracking = trackingTextEl.textContent;
                trackingSpan.dataset.originalTracking = currentTracking;

                trackingSpan.innerHTML = `
                    <input type="text" class="tracking-input" value="${currentTracking}">
                    <button class="btn btn-sm btn-success btn-save-tracking-confirm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button class="btn btn-sm btn-secondary btn-cancel-tracking-edit">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                `;
                trackingSpan.querySelector('.tracking-input').focus();
            }

            function exitTrackingEditMode(trackingSpan) {
                const originalTracking = trackingSpan.dataset.originalTracking;
                trackingSpan.innerHTML = `‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: <span class="tracking-text">${originalTracking}</span> <button class="btn btn-sm btn-edit-tracking" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏">‚úèÔ∏è</button>`;
            }

            async function saveTrackingNumber(orderId, newTrackingNumber) {
                if (!newTrackingNumber) {
                    alert('‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ');
                    return;
                }
                loadingOverlay.style.display = 'flex';
                try {
                    const { error } = await supabaseClient
                        .from('orders')
                        .update({ tracking_number: newTrackingNumber })
                        .eq('id', orderId);
                    
                    if (error) throw error;

                    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    await loadInitialData();
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' + error.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            async function generateNextBillNo(channelCode) { const { data, error } = await supabaseClient.rpc('increment_bill_no', { p_channel_code: channelCode }); if (error) { throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡πÑ‡∏î‡πâ: ${error.message}`); } const today = new Date(); const year = String(today.getFullYear() + 543).slice(-2); const month = String(today.getMonth() + 1).padStart(2, '0'); const prefix = `${channelCode}${year}${month}`; const nextSequence = String(data).padStart(5, '0'); return `${prefix}${nextSequence}`; }
            function calculateTotal() { const price = parseFloat(container.querySelector('#price').value) || 0; const shipping = parseFloat(container.querySelector('#shipping_cost').value) || 0; const discount = parseFloat(container.querySelector('#discount').value) || 0; container.querySelector('#total_amount').value = (price + shipping - discount).toFixed(2); }
            
            function exportForProduction(workOrderName) {
                const ordersInWorkOrder = allOrdersData.filter(order => order.work_order_name === workOrderName);
                if (ordersInWorkOrder.length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ");
                    return;
                }

                const headers = ['‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Item UID', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà', '‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å', '‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô', '‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô', '‡∏ü‡∏≠‡∏ô‡∏ï‡πå', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2', '‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö'];
                const dataToExport = [];

                ordersInWorkOrder.forEach(order => {
                    if (order.order_items && order.order_items.length > 0) {
                        order.order_items.forEach(item => {
                            dataToExport.push([
                                workOrderName,
                                item.bill_no,
                                item.item_uid,
                                item.product_name,
                                item.product_type, //‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà
                                item.ink_color,
                                item.cartoon_pattern,
                                item.line_pattern,
                                item.font,
                                item.line_1,
                                item.line_2,
                                item.line_3,
                                1, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô always 1 for production line
                                item.notes,
                                item.file_attachment
                            ]);
                        });
                    }
                });
                
                if (dataToExport.length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export ‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ");
                    return;
                }

                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "ProductionData");
                XLSX.writeFile(workbook, `Production_${workOrderName}.xlsx`);
            }
            
            function attachFormActionListeners(order) {
                const idMap = {
                    'save-waiting-btn': () => saveOrUpdateOrder('‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'),
                    'save-complete-btn': () => saveOrUpdateOrder('‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'),
                    'update-waiting-btn': () => saveOrUpdateOrder('‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'),
                    'move-to-complete-btn': () => saveOrUpdateOrder('‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'),
                    'update-complete-btn': () => saveOrUpdateOrder(null),
                    'cancel-bill-btn': () => moveOrder(order.id, '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')
                };
                for(const id in idMap) {
                    const btn = document.getElementById(id);
                    if (btn) btn.addEventListener('click', idMap[id]);
                }
            }
            
            function initializeEventListeners() {
                trackingFileInput.addEventListener('change', (e) => handleTrackingImport(e.target.files[0]));
                
                container.addEventListener('click', (event) => {
                    const target = event.target;
                    
                    if (target.closest('.order-info') && !target.closest('.order-tracking')) {
                        const orderItem = target.closest('.order-list-item');
                        if (orderItem) {
                            loadOrderForEditing(orderItem.dataset.orderId);
                        }
                    }

                    if (target.closest('.btn-edit-tracking')) {
                        event.stopPropagation();
                        event.preventDefault();
                        const trackingSpan = target.closest('.order-tracking');
                        enterTrackingEditMode(trackingSpan);
                    }
                    if (target.closest('.btn-save-tracking-confirm')) {
                        event.stopPropagation();
                        event.preventDefault();
                        const orderItem = target.closest('.order-list-item');
                        const orderId = orderItem.dataset.orderId;
                        const newTrackingNumber = orderItem.querySelector('.tracking-input').value.trim();
                        saveTrackingNumber(orderId, newTrackingNumber);
                    }
                    if (target.closest('.btn-cancel-tracking-edit')) {
                        event.stopPropagation();
                        event.preventDefault();
                        exitTrackingEditMode(target.closest('.order-tracking'));
                    }

                    const header = target.closest('.work-order-header');
                    if (header) {
                         const classToAction = {
                            'export-production-btn': (btn) => exportForProduction(btn.dataset.workOrderName),
                            'prepare-waybill-btn': (btn) => prepareForWaybill(btn.dataset.workOrderName),
                            'import-wo-csv-btn': () => trackingFileInput.click(),
                            'cancel-wo-btn': (btn) => cancelWorkOrder(btn.dataset.workOrderName)
                        };

                        let actionFound = false;
                        for (const className in classToAction) {
                            const btn = target.closest(`.${className}`);
                            if (btn) {
                                event.stopPropagation();
                                classToAction[className](btn);
                                actionFound = true;
                                break;
                            }
                        }
                        if (!actionFound) {
                            toggleWorkOrder(header);
                        }
                    }
                    
                    const billsContainer = target.closest('.work-order-bills');
                    if(billsContainer) {
                         const classToAction = {
                            'select-all-in-wo-btn': (btn) => selectAllInWorkOrder(btn),
                            'revert-to-waiting-btn': (btn) => revertSelectedBills(btn.dataset.workOrderName, '‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'),
                            'revert-to-complete-btn': (btn) => revertSelectedBills(btn.dataset.workOrderName, '‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'),
                            'cancel-bills-from-wo-btn': (btn) => cancelSelectedBillsFromWorkOrder(btn.dataset.workOrderName)
                        };
                         for (const className in classToAction) {
                            const btn = target.closest(`.${className}`);
                            if (btn) {
                                classToAction[className](btn);
                                break;
                            }
                        }
                    }
                });

                addItemBtn.addEventListener('click', () => addItemRow());
                itemsTbody.addEventListener('click', (e) => { if (e.target.classList.contains('remove-item-btn')) { $(e.target).closest('tr').find('.item-product').select2('destroy'); e.target.closest('tr').remove(); }});
                [container.querySelector('#price'), container.querySelector('#shipping_cost'), container.querySelector('#discount')].forEach(input => input.addEventListener('input', calculateTotal));
                tabLinks.forEach(link => { link.addEventListener('click', (e) => openTab(e, e.target.dataset.tab)); });
                ['filter-waiting', 'filter-complete', 'filter-cancelled', 'filter-shipped'].forEach(id => { const el = container.querySelector(`#${id}`); if (el) el.addEventListener('change', renderAllTabs); });
                
                downloadTemplateBtn.addEventListener('click', downloadOrderTemplate);
                importExcelBtn.addEventListener('click', () => importExcelInput.click());
                importExcelInput.addEventListener('change', (e) => handleExcelImport(e.target.files[0]));
                
                importPgtrBtn.addEventListener('click', () => importPgtrInput.click());
                importPgtrInput.addEventListener('change', (e) => handlePgtrImport(e.target.files[0]));
                
                document.getElementById('select-all-waiting-btn').addEventListener('click', () => selectAll('waiting'));
                document.getElementById('cancel-selected-waiting-btn').addEventListener('click', () => cancelSelectedOrders('waiting'));
                document.getElementById('select-all-complete-btn').addEventListener('click', () => selectAll('complete'));
                document.getElementById('create-work-order-btn').addEventListener('click', createWorkOrder);
                document.getElementById('cancel-selected-complete-btn').addEventListener('click', () => cancelSelectedOrders('complete'));
                document.getElementById('select-all-shipped-btn').addEventListener('click', () => selectAll('shipped'));
                document.getElementById('select-all-cancelled-btn').addEventListener('click', () => selectAll('cancelled'));
                document.getElementById('restore-to-waiting-btn').addEventListener('click', () => restoreSelectedOrders('‡∏£‡∏≠‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'));
                document.getElementById('restore-to-complete-btn').addEventListener('click', () => restoreSelectedOrders('‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'));
            }

            return { initializeApp, loadInitialData };
        })();

        // --- PACKING SYSTEM MODULE ---
        window.packingSystem = (() => {
            const container = document.getElementById("packing-system-container");
            const selectionView = container.querySelector("#work-order-selection-view");
            const workOrderList = container.querySelector("#work-order-list");
            const mainView = container.querySelector("#packing-main-view");
            const exportBtn = container.querySelector("#export-all-button");
            const searchInput = container.querySelector("#search-input");
            const orderList = container.querySelector("#order-list");
            const orderCounter = container.querySelector("#order-counter");
            const resultContainer = container.querySelector("#result-container");
            const actionPanel = container.querySelector("#action-panel");
            const itemScanInput = container.querySelector("#item-scan-input");
            const confirmationInput = container.querySelector("#confirmation-input");
            const statusMessage = container.querySelector("#status-message");
            const successSound = container.querySelector("#success-sound");
            const errorSound = container.querySelector("#error-sound");
            const headerTitle = container.querySelector("#packing-header-title");
            const backBtn = container.querySelector("#back-to-wo-selection");

            let allOrdersForPacking = [];
            let aggregatedData = [];
            let completedIndices = new Set();
            let currentIndex = -1;
            let currentWorkOrderName = null;
            const columnHeaders = { 
                tracking: "‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏", customerName: "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", productName: "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", 
                details: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", font: "‡∏ü‡∏≠‡∏ô‡∏ï‡πå", inkColor: "‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å", notes: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", 
                item_uid: "Item UID", shipped: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß", shippedTime: "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á", 
                itemScanTime: "‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
            };

            async function loadWorkOrdersForPacking() {
                showPackingView("selection");
                workOrderList.innerHTML = "<li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô...</li>";
                const { data, error } = await supabaseClient.from("work_orders").select("*").order("created_at", { ascending: false });
                if (error) { workOrderList.innerHTML = "<li>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</li>"; return; }
                if (!data || data.length === 0) { workOrderList.innerHTML = "<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï</li>"; return; }
                workOrderList.innerHTML = "";
                data.forEach(wo => {
                    const li = document.createElement("li");
                    li.className = "work-order-item";
                    const btn = document.createElement("button");
                    btn.textContent = `${wo.work_order_name} (${wo.order_count} ‡∏ö‡∏¥‡∏•)`;
                    btn.dataset.workOrderName = wo.work_order_name;
                    btn.addEventListener("click", () => loadPackingData(wo.work_order_name));
                    li.appendChild(btn);
                    workOrderList.appendChild(li);
                });
            }

            async function loadPackingData(workOrderName) {
                loadingOverlay.style.display = "flex";
                currentWorkOrderName = workOrderName;
                const { data, error } = await supabaseClient.from("orders").select("*, order_items(*)").eq("work_order_name", workOrderName);
                loadingOverlay.style.display = "none";
                if (error) { alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ: " + error.message); return; }
                
                const ordersWithTracking = data.filter(order => order.tracking_number && order.tracking_number.trim() !== "");
                
                if (data.length > 0 && ordersWithTracking.length === 0) {
                    alert("‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏ô"); return;
                }
                if (data.length > ordersWithTracking.length) {
                    alert(`‡∏°‡∏µ ${data.length - ordersWithTracking.length} ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πá‡∏Ñ`);
                }

                prepareDataForPacking(ordersWithTracking);
                
                if (aggregatedData.length > 0) {
                    headerTitle.textContent = `‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô: ${workOrderName}`;
                    showPackingView("main");
                    renderOrderNav();
                    displayOrder(0);
                    exportBtn.disabled = false;
                } else {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ");
                }
            }

            async function finalizeWorkOrderAndMoveStatus(workOrderName) {
                loadingOverlay.style.display = 'flex';
                try {
                    const { error: updateError } = await supabaseClient
                        .from('orders')
                        .update({ status: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' })
                        .eq('work_order_name', workOrderName);
                    if (updateError) throw updateError;

                    const { error: deleteError } = await supabaseClient
                        .from('work_orders')
                        .delete()
                        .eq('work_order_name', workOrderName);
                    if (deleteError) throw deleteError;
                    
                    alert(`‡∏¢‡πâ‡∏≤‡∏¢‡πÉ‡∏ö‡∏á‡∏≤‡∏ô "${workOrderName}" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    await window.orderSystem.loadInitialData();
                } catch (err) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + err.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                    showPackingView('selection');
                }
            }
            
            function prepareDataForPacking(orders) {
                let flatData = []; aggregatedData = [];
                orders.forEach(order => {
                    if (order.order_items && order.order_items.length > 0) {
                        order.order_items.forEach(item => {
                            const details = [item.line_1, item.line_2, item.line_3].filter(Boolean).join(" // ");
                            flatData.push({
                                [columnHeaders.tracking]: order.tracking_number, [columnHeaders.customerName]: order.customer_name,
                                [columnHeaders.productName]: item.product_name, 
                                [columnHeaders.details]: details, 
                                [columnHeaders.font]: item.font,
                                [columnHeaders.inkColor]: item.ink_color, 
                                [columnHeaders.notes]: item.notes,
                                'shelf_location': item.product_type,
                                'cartoon_pattern': item.cartoon_pattern,
                                'line_pattern': item.line_pattern,
                                'file_attachment': item.file_attachment,
                                'item_uid': item.item_uid,
                                scanned: false, 
                                [columnHeaders.itemScanTime]: "",
                            });
                        });
                    }
                });
                
                allOrdersForPacking = flatData;
                const groupedByTracking = {};
                allOrdersForPacking.forEach(item => {
                    const tracking = item[columnHeaders.tracking];
                    if (!groupedByTracking[tracking]) groupedByTracking[tracking] = [];
                    groupedByTracking[tracking].push(item);
                });
                
                aggregatedData = Object.values(groupedByTracking);
                completedIndices.clear();
                currentIndex = -1;
                searchInput.value = '';
            }

            function renderOrderNav() {
                orderList.innerHTML = "";
                aggregatedData.forEach((group, index) => {
                    const trackingId = String(group[0][columnHeaders.tracking]).trim();
                    const li = document.createElement("li");
                    li.className = "order-item";
                    li.dataset.index = index;
                    li.dataset.trackingId = trackingId;
                    li.innerHTML = `<span class="tracking-id">üì¶ ${trackingId}</span><span class="customer-name">${group[0][columnHeaders.customerName] || 'N/A'}</span>`;
                    li.addEventListener("click", () => displayOrder(index));
                    orderList.appendChild(li);
                });
                updateCounter();
            }
            
            function displayOrder(index) {
                if (index < 0 || index >= aggregatedData.length) return;
                currentIndex = index;
                const orderGroup = aggregatedData[index];
                
                let headerHTML = `<h2>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: ${orderGroup[0][columnHeaders.tracking]}</h2><p><strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${orderGroup[0][columnHeaders.customerName]}</p>`;
                let tableHTML = `<table><thead><tr>
                        <th>Item UID</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏™‡∏µ‡∏´‡∏°‡∏∂‡∏Å</th><th>‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</th>
                        <th>‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô</th><th>‡∏ü‡∏≠‡∏ô‡∏ï‡πå</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th>
                    </tr></thead><tbody>`;
                
                orderGroup.forEach(item => {
                    tableHTML += `<tr class="${item.scanned ? 'item-scanned' : ''}" data-item-uid="${item.item_uid}">
                        <td><strong>${item.item_uid || ''}</strong></td>
                        <td>${item[columnHeaders.productName] || ''}</td>
                        <td>${item[columnHeaders.details] || ''}</td>
                        <td>${item[columnHeaders.inkColor] || ''}</td>
                        <td>${item.shelf_location || ''}</td>
                        <td>${item.cartoon_pattern || ''}</td>
                        <td>${item.line_pattern || ''}</td>
                        <td>${item[columnHeaders.font] || ''}</td>
                        <td>${item[columnHeaders.notes] || ''}</td>
                        <td>${item.file_attachment || ''}</td>
                    </tr>`;
                });
                tableHTML += "</tbody></table>";
                resultContainer.innerHTML = headerHTML + tableHTML;

                actionPanel.style.display = "block";
                confirmationInput.value = "";
                updateInputStates();
                updateActiveNavItem();
            }

            function confirmShipment() {
                const confirmationValue = confirmationInput.value.trim();
                if (!confirmationValue || completedIndices.has(currentIndex) || currentIndex < 0) return;
                
                const currentTrackingId = String(aggregatedData[currentIndex][0][columnHeaders.tracking]).trim();
                if (confirmationValue === currentTrackingId) {
                    const timestamp = getTimestamp();
                    allOrdersForPacking.forEach(item => { if (String(item[columnHeaders.tracking]).trim() === currentTrackingId) { item[columnHeaders.shipped] = true; item[columnHeaders.shippedTime] = timestamp; }});
                    completedIndices.add(currentIndex);
                    markNavItemAsComplete(currentIndex, true);
                    updateStatus("‚úÖ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ...", "success");
                    successSound.play();
                    
                    setTimeout(async () => {
                        if (completedIndices.size === aggregatedData.length) {
                             if (confirm(`‡πÉ‡∏ö‡∏á‡∏≤‡∏ô "${currentWorkOrderName}" ‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                await finalizeWorkOrderAndMoveStatus(currentWorkOrderName);
                            } else {
                                updateStatus("üéâ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß", "success");
                                actionPanel.style.display = "none";
                            }
                        } else {
                            searchInput.value = '';
                            filterNavList();
                            const nextIndex = aggregatedData.findIndex((_, i) => !completedIndices.has(i));
                            if (nextIndex !== -1) {
                                displayOrder(nextIndex);
                            }
                        }
                    }, 1200);
                } else {
                    updateStatus("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î! ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô", "error");
                    errorSound.play();
                    confirmationInput.select();
                }
            }

            const scanItem = () => {
                const scanValue = itemScanInput.value.trim();
                if (!scanValue || currentIndex < 0) return;
                
                const currentOrderGroup = aggregatedData[currentIndex];
                const itemToScan = currentOrderGroup.find(item => !item.scanned && item.item_uid === scanValue);

                if (itemToScan) {
                    successSound.play();
                    itemToScan.scanned = true;
                    itemToScan[columnHeaders.itemScanTime] = getTimestamp();
                    itemScanInput.value = "";
                    const row = resultContainer.querySelector(`tr[data-item-uid="${itemToScan.item_uid}"]`);
                    if(row) row.classList.add('item-scanned');
                    updateInputStates();
                } else {
                    errorSound.play();
                    const alreadyScanned = currentOrderGroup.find(item => item.scanned && item.item_uid === scanValue);
                    updateStatus(alreadyScanned ? "‚ùå Item UID ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!" : "‚ùå Item UID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!", "error");
                    itemScanInput.select();
                }
            };
            
            function showPackingView(view) { if (view === 'selection') { selectionView.style.display = "block"; mainView.style.display = "none"; } else { selectionView.style.display = "none"; mainView.style.display = "block"; } }
            const getTimestamp = () => { const now = new Date(); const pad = (n) => String(n).padStart(2, '0'); return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`; };
            const exportToExcel = () => { if (allOrdersForPacking.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export"); return; } const dataToExport = JSON.parse(JSON.stringify(allOrdersForPacking)); dataToExport.forEach(d => delete d.scanned); const worksheet = XLSX.utils.json_to_sheet(dataToExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Updated Data"); XLSX.writeFile(workbook, `Updated_Packing_List_${getTimestamp().replace(/[:\s-]/g, "")}.xlsx`); };
            const filterNavList = () => { const searchTerm = searchInput.value.trim().toLowerCase(); container.querySelectorAll(".order-item").forEach(item => { item.style.display = item.dataset.trackingId.toLowerCase().includes(searchTerm) ? "" : "none"; }); };
            const updateInputStates = () => { if (currentIndex < 0) return; const allScanned = aggregatedData[currentIndex].every(item => item.scanned); itemScanInput.disabled = allScanned; confirmationInput.disabled = !allScanned; if (allScanned) { updateStatus("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á", "success"); confirmationInput.focus(); } else { updateStatus(`‡∏£‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${aggregatedData[currentIndex].filter(i => !i.scanned).length} ‡∏ä‡∏¥‡πâ‡∏ô...`, ""); itemScanInput.focus(); } };
            const updateCounter = () => { orderCounter.textContent = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${completedIndices.size} / ${aggregatedData.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå`; };
            const updateActiveNavItem = () => { container.querySelectorAll(".order-item").forEach(item => item.classList.toggle("active", parseInt(item.dataset.index) === currentIndex)); };
            const markNavItemAsComplete = (index, isComplete) => { const item = container.querySelector(`.order-item[data-index='${index}']`); if (item) { item.classList.toggle("completed", isComplete); item.querySelector('.tracking-id').innerHTML = `‚úÖ ${item.querySelector('.tracking-id').textContent.split(' ').pop()}`; } updateCounter(); };
            const updateStatus = (text, type) => { statusMessage.textContent = text; statusMessage.className = `status-${type}`; };

            exportBtn.addEventListener("click", exportToExcel);
            searchInput.addEventListener("input", filterNavList);
            itemScanInput.addEventListener("keyup", (e) => { if (e.key === "Enter") scanItem(); });
            confirmationInput.addEventListener("keyup", (e) => { if (e.key === "Enter") confirmShipment(); });
            backBtn.addEventListener("click", () => {
                showPackingView('selection');
                currentWorkOrderName = null;
            });

            return { loadWorkOrdersForPacking };
        })();
        
        // --- INITIAL LOAD ---
        checkAuth();
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการออร์เดอร์ TR Kids</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background-color: #f4f7f9; margin: 0; padding: 0; }
        .view { display: none; } .view.active { display: block; }
        #login-view.active { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-container { background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
        .login-container h1 { color: #0071e3; margin-bottom: 25px; }
        .login-container .form-group { margin-bottom: 20px; text-align: left; }
        .login-container label { display: block; margin-bottom: 5px; font-weight: 600; }
        .login-container input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .login-container .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; background-color: #0071e3; color: white; }
        #error-message { color: #dc3545; margin-top: 15px; height: 20px; }
        
        #app-view { padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #333; }
        h1 { text-align: center; color: #0071e3; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        .btn-primary { background-color: #0071e3; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: none; justify-content: center; align-items: center; z-index: 1000; font-size: 2em; }
        #user-info-bar { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; }
        hr { border: 0; height: 1px; background: #e0e0e0; margin: 25px 0; }

        .tabs { border-bottom: 2px solid #dee2e6; display: flex; flex-wrap: wrap; margin-bottom: 20px; }
        .tab-link { padding: 10px 15px; cursor: pointer; background: none; border: none; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-link.active { border-bottom-color: #0071e3; font-weight: 600; color: #0071e3; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-filter { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .batch-actions { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .order-list { list-style: none; padding: 0; max-height: 60vh; overflow-y: auto; }
        .order-list-item { display: flex; align-items: center; gap: 15px; padding: 15px; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 4px; flex-wrap: wrap; }
        .order-info { flex-grow: 1; cursor: pointer; }
        .order-info:hover { text-decoration: underline; }
        .order-info strong { font-size: 1.1em; color: #0071e3; display: block; margin-bottom: 4px; }
        .order-info .order-tracking { font-size: 0.9em; color: #28a745; font-weight: 700; }
        .order-list-item-details { display: flex; justify-content: flex-end; flex-grow: 1; align-items: center; gap: 15px; color: #6c757d; font-size: 0.9em; }
        
        .items-table-container { overflow-x: auto; }
        #items-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        #items-table th, #items-table td { border: 1px solid #ddd; padding: 2px; text-align: left; vertical-align: top; }
        #items-table th { background-color: #f8f9fa; font-size: 14px; padding: 8px; white-space: nowrap; }
        #items-table input, #items-table select { width: 100%; font-size: 14px; padding: 6px; border: none; background: transparent; box-sizing: border-box; }
        #items-table input:focus { outline: 2px solid #0071e3; background: #fff; }
        #items-table .select2-container { width: 100% !important; }
        #items-table .select2-selection--single { height: 32px !important; border: none !important; }
        #items-table .select2-selection__rendered { line-height: 30px !important; }
        #items-table .select2-selection__arrow { height: 30px !important; }
        #items-table .quantity-input { width: 70px; text-align: center; }
        #items-table .action-cell { width: 50px; text-align: center; }
        #items-table .remove-item-btn { font-size: 12px; padding: 4px 8px; }

        .work-order-group { border: 1px solid #0071e3; border-radius: 4px; margin-bottom: 15px; }
        .work-order-header { background-color: #e0effc; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .work-order-header:hover { background-color: #cce4fa; }
        .work-order-bills { padding: 15px; display: none; border-top: 1px solid #ddd; }
        .work-order-bills .order-list-item { padding: 10px; border-left: 3px solid #6c757d; }
    </style>
</head>
<body>
    <div id="loading-overlay">กำลังโหลด...</div>

    <div id="login-view" class="view active">
        <div class="login-container">
            <h1>ระบบจัดการออร์เดอร์</h1>
            <form id="login-form">
                <div class="form-group"><label for="email">อีเมล</label><input type="email" id="email" required></div>
                <div class="form-group"><label for="password">รหัสผ่าน</label><input type="password" id="password" required></div>
                <button type="submit" class="btn">เข้าสู่ระบบ</button>
                <p id="error-message"></p>
            </form>
        </div>
    </div>

    <div id="app-view" class="view">
        <div class="container">
            <div id="user-info-bar">
                <span id="welcome-message"></span>
                <button type="button" id="logout-btn" class="btn btn-secondary">ออกจากระบบ</button>
            </div>
            <h1>ระบบจัดการออร์เดอร์</h1>
            <div class="tabs">
                <button class="tab-link active" data-tab="tab-create">สร้าง / แก้ไข</button>
                <button class="tab-link" data-tab="tab-waiting">รอลงข้อมูล</button>
                <button class="tab-link" data-tab="tab-complete">ลงข้อมูลเสร็จสิ้น</button>
                <button class="tab-link" data-tab="tab-work-orders">ใบงาน (กำลังผลิต)</button>
                <button class="tab-link" data-tab="tab-cancelled">ยกเลิก</button>
            </div>
            <div id="tab-create" class="tab-content active">
                <h2 id="form-title">สร้างออร์เดอร์ใหม่</h2>
                <form id="order-form">
                    <h3>ข้อมูลหลัก</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="channel_code">ช่องทาง</label><select id="channel_code" required><option value="">-- เลือกช่องทาง --</option></select></div>
                        <div class="form-group"><label for="admin_user">แอดมิน</label><input type="text" id="admin_user" required readonly></div>
                        <div class="form-group"><label for="customer_name">ชื่อลูกค้า</label><input type="text" id="customer_name" required></div>
                        <div class="form-group full-width"><label for="customer_address">ที่อยู่ลูกค้า</label><textarea id="customer_address" rows="3" required></textarea></div>
                    </div><hr>
                    <h3>รายการสินค้า (สามารถ Copy & Paste จาก Excel ได้)</h3>
                    <div class="items-table-container">
                        <table id="items-table">
                            <thead>
                                <tr>
                                    <th>ชื่อสินค้า</th><th>สีหมึก</th><th>ชั้นที่</th><th>ลายการ์ตูน</th><th>ลายเส้น</th><th>ฟอนต์</th>
                                    <th>บรรทัด 1</th><th>บรรทัด 2</th><th>บรรทัด 3</th>
                                    <th>จำนวน</th><th>หมายเหตุ</th><th>ไฟล์แนบ</th><th></th>
                                </tr>
                            </thead>
                            <tbody id="items-tbody"></tbody>
                        </table>
                    </div>
                    <button type="button" id="add-item-btn" class="btn btn-secondary">+ เพิ่มแถว</button><hr>
                    <h3>ข้อมูลการชำระเงิน</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="price">ราคา</label><input type="number" id="price" value="0" step="0.01"></div>
                        <div class="form-group"><label for="shipping_cost">ค่าส่ง</label><input type="number" id="shipping_cost" value="0" step="0.01"></div>
                        <div class="form-group"><label for="discount">ส่วนลด</label><input type="number" id="discount" value="0" step="0.01"></div>
                        <div class="form-group"><label for="total_amount">ยอดสุทธิ</label><input type="number" id="total_amount" readonly></div>
                        <div class="form-group"><label for="payment_method">วิธีการชำระ</label><input type="text" id="payment_method"></div>
                        <div class="form-group"><label for="promotion">ชื่อโปรโมชั่น</label><input type="text" id="promotion"></div>
                    </div>
                    <div id="form-actions" style="margin-top: 25px; text-align: right;"></div>
                </form>
            </div>
            <div id="tab-waiting" class="tab-content">
                <div class="tab-filter"><label for="filter-waiting">กรองตามช่องทาง:</label><select id="filter-waiting"></select></div>
                <div class="batch-actions"><button class="btn btn-secondary" onclick="selectAll('waiting')">เลือกทั้งหมด</button><button class="btn btn-danger" onclick="cancelSelectedOrders('waiting')">ยกเลิกบิลที่เลือก</button></div>
                <ul class="order-list"></ul>
            </div>
            <div id="tab-complete" class="tab-content">
                <div class="tab-filter"><label for="filter-complete">กรองตามช่องทาง:</label><select id="filter-complete"></select></div>
                <div class="batch-actions"><button class="btn btn-secondary" onclick="selectAll('complete')">เลือกทั้งหมด</button><button class="btn btn-success" onclick="createWorkOrder()">สร้างใบงานจากที่เลือก</button><button class="btn btn-danger" onclick="cancelSelectedOrders('complete')">ยกเลิกบิลที่เลือก</button></div>
                <ul class="order-list"></ul>
            </div>
            <div id="tab-work-orders" class="tab-content"></div>
            <div id="tab-cancelled" class="tab-content"><div class="tab-filter"><label for="filter-cancelled">กรองตามช่องทาง:</label><select id="filter-cancelled"></select></div><ul class="order-list"></ul></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- CONFIG & GLOBAL STATE ---
        const SUPABASE_URL = 'https://scxcuwjhjbkxvqmpywqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeGN1d2poamJreHZxbXB5d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODM4NTMsImV4cCI6MjA3NDg1OTg1M30.UqcmQUxCkOxgDxjtUa8Sbb0cLHT26qOuHfdbtdilkI8';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let productList = [], channelList = [], allOrdersData = [], allWorkOrdersData = [], currentEditingOrderId = null, loggedInUsername = null;

        // --- DOM ELEMENTS ---
        const allViews = document.querySelectorAll('.view');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const orderForm = document.getElementById('order-form');
        const itemsTbody = document.getElementById('items-tbody');
        const addItemBtn = document.getElementById('add-item-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const adminUserInput = document.getElementById('admin_user');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutBtn = document.getElementById('logout-btn');
        const priceInput = document.getElementById('price');
        const shippingInput = document.getElementById('shipping_cost');
        const discountInput = document.getElementById('discount');
        const totalInput = document.getElementById('total_amount');
        const formActions = document.getElementById('form-actions');
        const tabLinks = document.querySelectorAll('.tab-link');
        
        // --- AUTH & INITIALIZATION ---
        function showView(viewId) { allViews.forEach(view => view.classList.remove('active')); document.getElementById(viewId).classList.add('active'); }
        
        async function checkAuth() { 
            const { data: { session } } = await supabaseClient.auth.getSession(); 
            if (session) { await initializeApp(session.user); } else { showView('login-view'); } 
        }

        async function logout() { 
            await supabaseClient.auth.signOut(); loggedInUsername = null;
            showView('login-view'); 
            document.getElementById('email').value = ''; document.getElementById('password').value = ''; errorMessage.textContent = ''; 
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); errorMessage.textContent = ''; loadingOverlay.style.display = 'flex';
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            loadingOverlay.style.display = 'none';
            if (error) { errorMessage.textContent = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง'; } 
            else if (data.user) { await initializeApp(data.user); }
        });

        logoutBtn.addEventListener('click', logout);
        
        async function initializeApp(user) {
            showView('app-view'); loadingOverlay.style.display = 'flex';
            try {
                const { data: userData, error } = await supabaseClient.from('users').select('username').eq('id', user.id).single();
                if (error || !userData) throw new Error('ไม่พบข้อมูลผู้ใช้ในระบบ');
                loggedInUsername = userData.username;
                welcomeMessage.textContent = `ยินดีต้อนรับ, ${loggedInUsername}`;
                adminUserInput.value = loggedInUsername;
                await loadInitialData();
                setFormMode('create');
            } catch(err) {
                alert(err.message); await logout();
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        async function loadInitialData() {
            try {
                const [productsRes, ordersRes, channelsRes, workOrdersRes] = await Promise.all([
                    supabaseClient.from('products').select('id, product_name'),
                    supabaseClient.from('orders').select('*, order_items(*)').order('created_at', { ascending: false }),
                    supabaseClient.from('channels').select('channel_code, channel_name'),
                    supabaseClient.from('work_orders').select('*').order('created_at', { ascending: false })
                ]);
                if (productsRes.error) throw new Error('ไม่สามารถโหลดรายการสินค้าได้');
                productList = productsRes.data.map(p => ({ id: p.id, text: p.product_name }));
                if (channelsRes.error) throw new Error('ไม่สามารถโหลดช่องทางขายได้');
                channelList = channelsRes.data;
                populateChannelDropdowns();
                if (ordersRes.error) throw new Error('ไม่สามารถโหลดออร์เดอร์ได้');
                allOrdersData = ordersRes.data;
                if (workOrdersRes.error) throw new Error('ไม่สามารถโหลดใบงานได้');
                allWorkOrdersData = workOrdersRes.data;
                renderAllTabs();
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message);
            }
        }

        function populateChannelDropdowns() {
            const dropdowns = [ document.getElementById('channel_code'), document.getElementById('filter-waiting'), document.getElementById('filter-complete'), document.getElementById('filter-cancelled') ];
            dropdowns.forEach(dropdown => {
                const isFilter = dropdown.id.startsWith('filter-');
                dropdown.innerHTML = isFilter ? '<option value="all">แสดงทั้งหมด</option>' : '<option value="">-- เลือกช่องทาง --</option>';
                channelList.forEach(ch => { const opt = document.createElement('option'); opt.value = ch.channel_code; opt.textContent = ch.channel_name; dropdown.appendChild(opt); });
            });
        }
        
        // --- UI & FORM MANAGEMENT ---
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            if (tabName === 'tab-create') { setFormMode('create'); }
        }
        
        function setFormMode(mode, order = null) {
            orderForm.reset(); itemsTbody.innerHTML = ''; currentEditingOrderId = null;
            $('select').val(null).trigger('change');
            adminUserInput.value = loggedInUsername;

            if (mode === 'create') {
                document.getElementById('form-title').textContent = 'สร้างออร์เดอร์ใหม่';
                addItemRow();
                formActions.innerHTML = `<button type="button" class="btn btn-secondary" onclick="saveOrUpdateOrder('รอลงข้อมูล')">บันทึก (รอลงข้อมูล)</button> <button type="button" class="btn btn-primary" onclick="saveOrUpdateOrder('ลงข้อมูลเสร็จสิ้น')">บันทึก (ข้อมูลครบถ้วน)</button>`;
            } else if (mode === 'edit' && order) {
                document.getElementById('form-title').textContent = `แก้ไขออร์เดอร์: ${order.bill_no}`;
                currentEditingOrderId = order.id;
                Object.keys(order).forEach(key => { const input = document.getElementById(key); if (input) { if (input.tagName === 'SELECT') { $(input).val(order[key]).trigger('change'); } else { input.value = order[key]; } } });
                
                // --- START: AGGREGATION LOGIC (FIXED) ---
                const itemGroups = {};
                order.order_items.forEach(item => {
                    const key = [item.product_id, item.ink_color, item.product_type, item.cartoon_pattern, item.line_pattern, item.font, item.line_1, item.line_2, item.line_3, item.notes, item.file_attachment].join('||');
                    if (!itemGroups[key]) {
                        itemGroups[key] = { ...item, quantity: 1 };
                    } else {
                        itemGroups[key].quantity++;
                    }
                });
                Object.values(itemGroups).forEach(groupedItem => {
                    addItemRow(groupedItem);
                });
                // --- END: AGGREGATION LOGIC (FIXED) ---

                if (order.status === 'รอลงข้อมูล') {
                    formActions.innerHTML = `<button type="button" class="btn btn-primary" onclick="saveOrUpdateOrder('รอลงข้อมูล')">อัปเดต (ยังรอลงข้อมูล)</button> <button type="button" class="btn btn-success" onclick="saveOrUpdateOrder('ลงข้อมูลเสร็จสิ้น')">ย้ายไป "ลงข้อมูลเสร็จสิ้น"</button> <button type="button" class="btn btn-danger" onclick="moveOrder(currentEditingOrderId, 'ยกเลิก')">ยกเลิกบิล</button>`;
                } else if (order.status === 'ลงข้อมูลเสร็จสิ้น') {
                     formActions.innerHTML = `<button type="button" class="btn btn-primary" onclick="saveOrUpdateOrder(null)">อัปเดตข้อมูล</button> <button type="button" class="btn btn-danger" onclick="moveOrder(currentEditingOrderId, 'ยกเลิก')">ยกเลิกบิล</button>`;
                } else {
                     formActions.innerHTML = ``; // No actions for other statuses in edit form
                }
            }
            calculateTotal();
        }

        function renderAllTabs() {
            const filters = { waiting: document.getElementById('filter-waiting').value, complete: document.getElementById('filter-complete').value, cancelled: document.getElementById('filter-cancelled').value };
            const lists = { 'รอลงข้อมูล': document.querySelector('#tab-waiting .order-list'), 'ลงข้อมูลเสร็จสิ้น': document.querySelector('#tab-complete .order-list'), 'ยกเลิก': document.querySelector('#tab-cancelled .order-list') };
            const workOrderContainer = document.querySelector('#tab-work-orders');
            Object.values(lists).forEach(list => { if (list) list.innerHTML = ''; });
            if (workOrderContainer) workOrderContainer.innerHTML = '';

            allOrdersData.forEach(order => {
                const list = lists[order.status];
                if (list) {
                    const tabId = list.parentElement.id;
                    const filterKey = tabId.split('-')[1];
                    const filterValue = filters[filterKey];
                    if (filterValue === 'all' || filterValue === order.channel_code) {
                        const trackingHTML = order.tracking_number ? `<span class="order-tracking">เลขพัสดุ: ${order.tracking_number}</span>` : '';
                        const itemHTML = `<li class="order-list-item" data-order-id="${order.id}"><input type="checkbox" class="order-checkbox"><div class="order-info" onclick="loadOrderForEditing('${order.id}')"><strong>${order.bill_no || 'N/A'}</strong><span>ลูกค้า: ${order.customer_name || 'N/A'}</span>${trackingHTML}</div><div class="order-list-item-details"><span>${order.work_order_name || ''}</span><span>${new Date(order.created_at).toLocaleDateString('th-TH')}</span></div></li>`;
                        list.innerHTML += itemHTML;
                    }
                }
            });

            allWorkOrdersData.forEach(wo => {
                const billsInWorkOrder = allOrdersData.filter(order => order.work_order_name === wo.work_order_name);
                const groupEl = document.createElement('div');
                groupEl.className = 'work-order-group';
                let billsHTML = '<ul class="order-list">';
                billsInWorkOrder.forEach(bill => { billsHTML += `<li class="order-list-item" data-order-id="${bill.id}"><input type="checkbox" class="order-checkbox"><div class="order-info" onclick="loadOrderForEditing('${bill.id}')"><strong>${bill.bill_no}</strong><span>ลูกค้า: ${bill.customer_name || 'N/A'}</span></div></li>`; });
                billsHTML += '</ul>';
                groupEl.innerHTML = `<div class="work-order-header" onclick="toggleWorkOrder(this)"><span>${wo.work_order_name} (จำนวน: ${billsInWorkOrder.length} บิล)</span><span>&#9660;</span></div><div class="work-order-bills"><div class="batch-actions"><button class="btn btn-secondary" onclick="selectAllInWorkOrder(this)">เลือกทั้งหมด</button><button class="btn btn-warning" onclick="revertSelectedBills('${wo.work_order_name}', 'รอลงข้อมูล')">คืนไป "รอลงข้อมูล"</button><button class="btn btn-info" onclick="revertSelectedBills('${wo.work_order_name}', 'ลงข้อมูลเสร็จสิ้น')">คืนไป "ลงข้อมูลเสร็จสิ้น"</button><button class="btn btn-danger" onclick="cancelSelectedBillsFromWorkOrder('${wo.work_order_name}')">ยกเลิกบิลที่เลือก</button><button class="btn btn-danger" onclick="cancelWorkOrder('${wo.work_order_name}')" style="margin-left: auto;">ยกเลิกทั้งใบงาน</button></div>${billsHTML}</div>`;
                workOrderContainer.appendChild(groupEl);
            });
        }
        
        async function loadOrderForEditing(orderId) {
            loadingOverlay.style.display = 'flex';
            try {
                // In the initial load, we already get related items with `order_items(*)`
                const orderData = allOrdersData.find(o => o.id == orderId);
                if (!orderData) throw new Error('ไม่พบข้อมูลออร์เดอร์');
                
                openTab({ currentTarget: document.querySelector('.tab-link[data-tab="tab-create"]') }, 'tab-create');
                setFormMode('edit', orderData);
            } catch (error) { alert('ไม่สามารถโหลดข้อมูลออร์เดอร์ได้: ' + error.message); } finally { loadingOverlay.style.display = 'none'; }
        }

        async function moveOrder(orderId, newStatus) {
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการย้ายบิลนี้ไปสถานะ "${newStatus}"?`)) return;
            loadingOverlay.style.display = 'flex';
            try {
                const { error } = await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId);
                if (error) throw error;
                alert(`ย้ายบิลสำเร็จ!`);
                await loadInitialData();
                setFormMode('create');
            } catch (error) {
                alert('เกิดข้อผิดพลาด: ' + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // --- PASTE & TABLE LOGIC ---
        itemsTbody.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasteData = (e.clipboardData || window.clipboardData).getData('text');
            const rowsData = pasteData.split(/[\r\n]+/).filter(row => row.trim() !== '');
            let targetCell = e.target.closest('td'); if (!targetCell) return;
            let startRowIndex = Array.from(itemsTbody.children).indexOf(targetCell.parentElement);
            let startCellIndex = targetCell.cellIndex;
            rowsData.forEach((rowData, rowIndex) => {
                const cellsData = rowData.split('\t'); let currentRow; const currentRowIndex = startRowIndex + rowIndex;
                if (currentRowIndex >= itemsTbody.rows.length) { addItemRow(); }
                currentRow = itemsTbody.rows[currentRowIndex]; if (!currentRow) return;
                cellsData.forEach((cellData, cellIndex) => {
                    const targetCellIndex = startCellIndex + cellIndex;
                    if (targetCellIndex < currentRow.cells.length - 1) { // -1 to avoid action cell
                        const input = currentRow.cells[targetCellIndex].querySelector('input, select');
                        if (input) {
                            if (input.tagName === 'SELECT') {
                                const matchedOption = productList.find(p => p.text.toLowerCase().includes(cellData.trim().toLowerCase()));
                                if (matchedOption) $(input).val(matchedOption.id).trigger('change');
                            } else { input.value = cellData.trim(); }
                        }
                    }
                });
            });
        });

        function addItemRow(item = null) {
            const row = itemsTbody.insertRow();
            row.innerHTML = `<td><select class="item-product"></select></td><td><input type="text" class="item-ink_color"></td><td><input type="text" class="item-shelf_location"></td><td><input type="text" class="item-cartoon_pattern"></td><td><input type="text" class="item-line_pattern"></td><td><input type="text" class="item-font"></td><td><input type="text" class="item-line_1"></td><td><input type="text" class="item-line_2"></td><td><input type="text" class="item-line_3"></td><td><input type="number" class="item-quantity quantity-input" value="1" min="1"></td><td><input type="text" class="item-notes"></td><td><input type="text" class="item-file_attachment"></td><td class="action-cell"><button type="button" class="btn btn-danger remove-item-btn">X</button></td>`;
            const selectEl = $(row.querySelector('.item-product'));
            selectEl.select2({ data: productList, placeholder: 'เลือกสินค้า', width: '100%' });
            if (item) {
                selectEl.val(item.product_id).trigger('change');
                row.querySelector('.item-shelf_location').value = item.product_type || '';
                row.querySelector('.item-ink_color').value = item.ink_color || '';
                row.querySelector('.item-cartoon_pattern').value = item.cartoon_pattern || '';
                row.querySelector('.item-line_pattern').value = item.line_pattern || '';
                row.querySelector('.item-font').value = item.font || '';
                row.querySelector('.item-line_1').value = item.line_1 || '';
                row.querySelector('.item-line_2').value = item.line_2 || '';
                row.querySelector('.item-line_3').value = item.line_3 || '';
                row.querySelector('.item-notes').value = item.notes || '';
                row.querySelector('.item-file_attachment').value = item.file_attachment || '';
                row.querySelector('.item-quantity').value = item.quantity || 1; // --- SET QUANTITY (FIXED) ---
            }
        }
        
        // --- BATCH ACTIONS ---
        function selectAll(tabKey) {
            const list = document.querySelector(`#tab-${tabKey} .order-list`); if (!list) return;
            const checkboxes = list.querySelectorAll('.order-checkbox'); if (checkboxes.length === 0) return;
            const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !isAllChecked);
        }

        function getSelectedOrderIds(tabKey) { const list = document.querySelector(`#tab-${tabKey} .order-list`); return Array.from(list.querySelectorAll('.order-checkbox:checked')).map(cb => cb.closest('.order-list-item').dataset.orderId); }
        
        async function createWorkOrder() {
            const selectedIds = getSelectedOrderIds('complete');
            if (selectedIds.length === 0) return alert('กรุณาเลือกออร์เดอร์อย่างน้อย 1 รายการ');
            const firstOrder = allOrdersData.find(o => o.id == selectedIds[0]);
            const channelCode = firstOrder.channel_code;
            const today = new Date().toISOString().slice(0, 10);
            if (!selectedIds.every(id => allOrdersData.find(o => o.id == id).channel_code === channelCode)) { return alert('กรุณาเลือกออร์เดอร์จากช่องทางเดียวกันเท่านั้น'); }
            loadingOverlay.style.display = 'flex';
            try {
                const { data: batchNumber, error: rpcError } = await supabaseClient.rpc('get_next_batch_number', { p_channel_code: channelCode, p_date: today });
                if (rpcError) throw rpcError;
                const datePart = new Date().toLocaleDateString('th-TH', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
                const workOrderName = `${channelCode}-${datePart}-R${batchNumber}`;
                const { error: woError } = await supabaseClient.from('work_orders').insert({ work_order_name: workOrderName, channel_code: channelCode, production_date: today, batch_number: batchNumber, order_count: selectedIds.length, created_by: loggedInUsername });
                if (woError) throw woError;
                const { error: updateError } = await supabaseClient.from('orders').update({ status: 'ใบงาน (กำลังผลิต)', work_order_name: workOrderName }).in('id', selectedIds);
                if (updateError) throw updateError;
                alert(`สร้างใบงาน "${workOrderName}" สำเร็จ!`); await loadInitialData();
            } catch (error) { console.error('Error creating work order:', error); alert(`เกิดข้อผิดพลาด: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; }
        }
        
        async function cancelSelectedOrders(tabKey) {
            const selectedIds = getSelectedOrderIds(tabKey);
            if (selectedIds.length === 0) return alert('กรุณาเลือกออร์เดอร์ที่ต้องการยกเลิก');
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการยกเลิก ${selectedIds.length} ออร์เดอร์?`)) return;
            loadingOverlay.style.display = 'flex';
            try {
                const { error } = await supabaseClient.from('orders').update({ status: 'ยกเลิก' }).in('id', selectedIds);
                if (error) throw error;
                alert('ยกเลิกออร์เดอร์สำเร็จ!'); await loadInitialData();
            } catch (error) { alert(`เกิดข้อผิดพลาด: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; }
        }
        
        function toggleWorkOrder(headerElement) { const content = headerElement.nextElementSibling; const arrow = headerElement.querySelector('span:last-child'); if (content.style.display === "block") { content.style.display = "none"; arrow.innerHTML = '&#9660;'; } else { content.style.display = "block"; arrow.innerHTML = '&#9650;'; } }
        
        function selectAllInWorkOrder(buttonElement) { const billsContainer = buttonElement.closest('.work-order-bills'); const checkboxes = billsContainer.querySelectorAll('.order-checkbox'); if (checkboxes.length === 0) return; const isAllChecked = Array.from(checkboxes).every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !isAllChecked); }
        
        async function revertSelectedBills(workOrderName, newStatus) {
            const groupEl = Array.from(document.querySelectorAll('.work-order-header')).find(h => h.textContent.includes(workOrderName)).parentElement;
            const selectedIds = Array.from(groupEl.querySelectorAll('.order-checkbox:checked')).map(cb => cb.closest('.order-list-item').dataset.orderId);
            if (selectedIds.length === 0) return alert('กรุณาเลือกบิลที่ต้องการคืนสถานะ');
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการคืนสถานะ ${selectedIds.length} บิล กลับไปที่ "${newStatus}"?`)) return;
            loadingOverlay.style.display = 'flex';
            try {
                const { error: updateError } = await supabaseClient.from('orders').update({ status: newStatus, work_order_name: null }).in('id', selectedIds);
                if (updateError) throw updateError;
                const { count, error: countError } = await supabaseClient.from('orders').select('id', { count: 'exact', head: true }).eq('work_order_name', workOrderName);
                if (countError) throw countError;
                if (count === 0) { await supabaseClient.from('work_orders').delete().eq('work_order_name', workOrderName); } 
                else { await supabaseClient.from('work_orders').update({ order_count: count }).eq('work_order_name', workOrderName); }
                alert('คืนสถานะบิลสำเร็จ!'); await loadInitialData();
            } catch (error) { console.error('Error reverting bills:', error); alert(`เกิดข้อผิดพลาด: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; }
        }
        
        async function cancelSelectedBillsFromWorkOrder(workOrderName) {
            const groupEl = Array.from(document.querySelectorAll('.work-order-header')).find(h => h.textContent.includes(workOrderName)).parentElement;
            const selectedIds = Array.from(groupEl.querySelectorAll('.order-checkbox:checked')).map(cb => cb.closest('.order-list-item').dataset.orderId);
            if (selectedIds.length === 0) return alert('กรุณาเลือกบิลที่ต้องการยกเลิก');
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการ **ยกเลิก** ${selectedIds.length} บิล ออกจากใบงานนี้?`)) return;
            loadingOverlay.style.display = 'flex';
            try {
                const { error: updateError } = await supabaseClient.from('orders').update({ status: 'ยกเลิก', work_order_name: null }).in('id', selectedIds);
                if (updateError) throw updateError;
                const { count, error: countError } = await supabaseClient.from('orders').select('id', { count: 'exact', head: true }).eq('work_order_name', workOrderName);
                if (countError) throw countError;
                if (count === 0) { await supabaseClient.from('work_orders').delete().eq('work_order_name', workOrderName); } 
                else { await supabaseClient.from('work_orders').update({ order_count: count }).eq('work_order_name', workOrderName); }
                alert('ยกเลิกบิลออกจากใบงานสำเร็จ!'); await loadInitialData();
            } catch (error) { console.error('Error cancelling bills from work order:', error); alert(`เกิดข้อผิดพลาด: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; }
        }
        
        async function cancelWorkOrder(workOrderName) {
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการ **ยกเลิกทั้งใบงาน** "${workOrderName}"? การกระทำนี้จะคืนสถานะบิลทั้งหมดกลับไปที่ "ลงข้อมูลเสร็จสิ้น"`)) return;
            loadingOverlay.style.display = 'flex';
            try {
                const { error: updateError } = await supabaseClient.from('orders').update({ status: 'ลงข้อมูลเสร็จสิ้น', work_order_name: null }).eq('work_order_name', workOrderName);
                if (updateError) throw updateError;
                const { error: deleteError } = await supabaseClient.from('work_orders').delete().eq('work_order_name', workOrderName);
                if (deleteError) throw deleteError;
                alert(`ยกเลิกใบงาน "${workOrderName}" และคืนสถานะบิลทั้งหมดเรียบร้อยแล้ว`); await loadInitialData();
            } catch (error) { console.error('Error cancelling work order:', error); alert(`เกิดข้อผิดพลาด: ${error.message}`); } finally { loadingOverlay.style.display = 'none'; }
        }
        
        // --- DATA HANDLING ---
        async function saveOrUpdateOrder(status) {
            loadingOverlay.style.display = 'flex'; 
            const isUpdate = !!currentEditingOrderId;
            try {
                const channelCode = document.getElementById('channel_code').value; if (!channelCode) throw new Error("กรุณาเลือกช่องทาง");
                
                let billNo;
                if (!isUpdate) {
                    billNo = await generateNextBillNo(channelCode);
                } else {
                    const order = allOrdersData.find(o => o.id === currentEditingOrderId);
                    billNo = order.bill_no;
                }

                const orderData = {
                    channel_code: channelCode,
                    bill_no: billNo,
                    status: isUpdate ? (status || allOrdersData.find(o => o.id === currentEditingOrderId).status) : status,
                    entry_date: new Date().toISOString().slice(0, 10),
                    customer_name: document.getElementById('customer_name').value,
                    price: parseFloat(priceInput.value) || 0,
                    shipping_cost: parseFloat(shippingInput.value) || 0,
                    discount: parseFloat(discountInput.value) || 0,
                    total_amount: parseFloat(totalInput.value) || 0,
                    payment_method: document.getElementById('payment_method').value,
                    admin_user: adminUserInput.value,
                    customer_address: document.getElementById('customer_address').value,
                    promotion: document.getElementById('promotion').value,
                };

                let upsertedOrderId = currentEditingOrderId;
                if (isUpdate) {
                    const { error } = await supabaseClient.from('orders').update(orderData).eq('id', currentEditingOrderId);
                    if (error) throw error;
                } else {
                    const { data: insertedOrder, error } = await supabaseClient.from('orders').insert(orderData).select().single();
                    if (error) throw error;
                    upsertedOrderId = insertedOrder.id;
                }

                await supabaseClient.from('order_items').delete().eq('order_id', upsertedOrderId);
                let allItemsToInsert = [];
                for (const row of itemsTbody.rows) {
                    const selectedData = $(row).find('.item-product').select2('data')[0]; if (!selectedData || !selectedData.id) continue;
                    const quantity = parseInt(row.querySelector('.item-quantity').value) || 1;
                    const baseItemData = { order_id: upsertedOrderId, bill_no: billNo, product_id: selectedData.id, product_name: selectedData.text, ink_color: row.querySelector('.item-ink_color').value, product_type: row.querySelector('.item-shelf_location').value, cartoon_pattern: row.querySelector('.item-cartoon_pattern').value, line_pattern: row.querySelector('.item-line_pattern').value, font: row.querySelector('.item-font').value, line_1: row.querySelector('.item-line_1').value, line_2: row.querySelector('.item-line_2').value, line_3: row.querySelector('.item-line_3').value, notes: row.querySelector('.item-notes').value, file_attachment: row.querySelector('.item-file_attachment').value };
                    for (let i = 0; i < quantity; i++) { allItemsToInsert.push({...baseItemData}); }
                }

                if (allItemsToInsert.length > 0) {
                    const { error: itemsError } = await supabaseClient.from('order_items').insert(allItemsToInsert);
                    if (itemsError) throw itemsError;
                }

                alert(isUpdate ? 'อัปเดตข้อมูลสำเร็จ!' : `บันทึกออร์เดอร์สำเร็จ! เลขบิล: ${billNo}`);
                await loadInitialData();
                setFormMode('create');
            } catch (error) {
                console.error('Error saving/updating order:', error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        async function generateNextBillNo(channelCode) {
            const { data, error } = await supabaseClient.rpc('increment_bill_no', { p_channel_code: channelCode });
            if (error) { throw new Error(`ไม่สามารถสร้างเลขบิลได้: ${error.message}`); }
            const today = new Date();
            const year = String(today.getFullYear() + 543).slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const prefix = `${channelCode}${year}${month}`;
            const nextSequence = String(data).padStart(5, '0');
            return `${prefix}${nextSequence}`;
        }
        
        function calculateTotal() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const shipping = parseFloat(document.getElementById('shipping_cost').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            document.getElementById('total_amount').value = (price + shipping - discount).toFixed(2);
        }
        
        // --- EVENT LISTENERS ---
        addItemBtn.addEventListener('click', () => addItemRow());
        itemsTbody.addEventListener('click', (e) => { if (e.target.classList.contains('remove-item-btn')) { $(e.target).closest('tr').find('.item-product').select2('destroy'); e.target.closest('tr').remove(); }});
        [priceInput, shippingInput, discountInput].forEach(input => input.addEventListener('input', calculateTotal));
        tabLinks.forEach(link => { link.addEventListener('click', (e) => openTab(e, e.target.dataset.tab)); });
        ['filter-waiting', 'filter-complete', 'filter-cancelled'].forEach(id => document.getElementById(id).addEventListener('change', renderAllTabs));
        
        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
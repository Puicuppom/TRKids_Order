<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR Kids - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</title>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- General Layout Styles --- */
        :root{--sidebar-width:240px;--sidebar-width-collapsed:65px;--top-bar-height:60px;--primary-color:#0056b3;--sidebar-bg:#1d2b3a;--sidebar-link-color:#c5d6de;--sidebar-link-hover-bg:#2a3f54;--sidebar-link-active-bg:#0071e3;--top-bar-bg:#4F634A}*{box-sizing:border-box}body{font-family:'Sarabun', sans-serif;margin:0;background-color:#f4f7f9}.app-container{display:flex;height:100vh}.sidebar{width:var(--sidebar-width);height:100%;position:fixed;z-index:1001;top:0;left:0;background-color:var(--sidebar-bg);transition:width .3s ease, transform .3s ease;color:#fff;padding-top:20px;flex-shrink:0}.page-wrapper{display:flex;flex-direction:column;width:100%;margin-left:var(--sidebar-width);transition:margin-left .3s ease}.top-bar{height:var(--top-bar-height);background-color:var(--top-bar-bg);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-shrink:0;box-shadow:0 2px 5px rgba(0,0,0,.1)}.main-content{flex-grow:1;overflow-y:auto;padding:20px;height:calc(100vh - var(--top-bar-height))}.sidebar .sidebar-header{padding:0 20px 20px;text-align:center;border-bottom:1px solid #3a4b5f;white-space:nowrap}.sidebar .sidebar-header h2{margin:0;font-size:1.6em;font-weight:600}.sidebar nav ul{list-style-type:none;padding:20px 0;margin:0}.sidebar nav li a{display:flex;align-items:center;padding:15px 20px;text-decoration:none;font-size:16px;color:var(--sidebar-link-color);white-space:nowrap;transition:background-color .2s ease-in-out}.sidebar nav li a .icon{margin-right:15px;font-size:1.5em;width:30px;text-align:center}.sidebar nav li a:hover{background-color:var(--sidebar-link-hover-bg)}.sidebar nav li a.active{background-color:var(--sidebar-link-active-bg);color:#fff;font-weight:700}body.sidebar-collapsed .sidebar{width:var(--sidebar-width-collapsed)}body.sidebar-collapsed .page-wrapper{margin-left:var(--sidebar-width-collapsed)}body.sidebar-collapsed .sidebar .sidebar-header h2,body.sidebar-collapsed .sidebar .nav-text{opacity:0;visibility:hidden}body.sidebar-collapsed .sidebar .nav-link .icon{margin-right:0}#user-info-bar{display:flex;align-items:center;gap:15px;font-size:14px}#logout-btn{background-color:#6c757d;color:#fff;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-size:14px}#loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);color:#fff;display:none;justify-content:center;align-items:center;z-index:9999;font-size:2em}
        
        /* --- Accounting Page Specific Styles --- */
        :root { --card-bg: #ffffff; --text-color: #333; --muted-color: #6c757d; --border-color: #dee2e6; --success-color: #28a745; --danger-color: #dc3545; --info-color: #17a2b8; --secondary-color: #007bff; }
        .container { max-width: 1600px; margin: 0 auto; padding: 0; display: flex; flex-direction: column; gap: 20px; }
        .card { background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 0; }
        h1, h2 { color: var(--primary-color); text-align: center; }
        .filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; justify-content: center;}
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; margin-bottom: 5px; font-size: 14px; }
        
        .filter-group input, .filter-group select { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 16px; height: 45px !important; box-sizing: border-box; line-height: normal; }
        .btn { padding: 12px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; color: #fff; height: 45px; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-info { background-color: var(--info-color); }
        .btn-sm { height: 36px; padding: 8px 12px; font-size: 14px; } /* Small button */
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #summary-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .summary-box { background-color: #f8f9fa; padding: 20px; border-radius: 8px; }
        .summary-box h3 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .summary-table { width: 100%; text-align: left; }
        .summary-table th, .summary-table td { padding: 8px 4px; border-bottom: 1px solid var(--border-color); }
        .summary-table tr:last-child td { border-bottom: none; }
        .summary-table .total-row { font-weight: bold; background-color: #e9ecef; }
        .summary-value { font-weight: 700; text-align: right; }
        .overall-summary { text-align: center; }
        .overall-summary .metric { margin-bottom: 15px; }
        .overall-summary .metric h4 { margin: 0 0 5px; color: var(--muted-color); font-size: 16px;}
        .overall-summary .metric .value { font-size: 2.2em; font-weight: 700; color: var(--primary-color); }

        .table-container { overflow-x: auto; max-height: 70vh;}
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; white-space: nowrap; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; }
        #statementTable th, #salesReportTable th { background-color: var(--primary-color); color: white;}
        td.currency { text-align: right; }
        #loading-message { text-align: center; font-size: 1.2em; color: var(--muted-color); padding: 40px; }
        .manual-match-cell { display: flex; gap: 8px; align-items: center; }
        .manual-match-cell input { min-width: 120px; height: 36px !important; }
        
        /* --- Reconciliation Tool Styles --- */
        .workflow { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1rem; }
        .step-card { background: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 1rem; }
        .step-card .step-number { background-color: var(--primary-color); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; flex-shrink: 0; }
        .step-card h3 { margin: 0; color: #343a40; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; cursor: pointer; padding: 10px 20px; font-size: 1rem; background-color: var(--secondary-color); color: white; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .file-input-wrapper:hover { background-color: var(--primary-color); }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .file-name { margin-top: 0.5rem; font-style: italic; color: #6c757d; font-size: 0.9rem; word-break: break-all; }
        .action-button { font-size: 1.1rem; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; width: 100%; transition: background-color: 0.3s; }
        #match-button { background-color: var(--success-color); color: white; }
        #export-matched-btn { background-color: var(--info-color); color: white; }
        .action-button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #status-area { width: 100%; text-align: center; padding: 1rem; background-color: #fff; border: 1px dashed var(--border-color); border-radius: 8px; box-sizing: border-box; }
        .export-section { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; justify-content: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin-top: 20px; }
        #summary-dashboard { width: 100%; margin-top: 1rem; text-align: left; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .summary-item:last-child { border-bottom: none; }
        .summary-label { font-weight: 500; display: flex; align-items: center; gap: 8px;}
        tr.matched-manual { background-color: #cce5ff !important; color: #004085; }
        .loader { display: none; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sheet-selector { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); justify-content: start; gap: 10px 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: #fff; box-sizing: border-box; }
        .checkbox-wrapper { display: flex; align-items: center; }
        .checkbox-wrapper input[type="checkbox"] { margin-right: 8px; width: 17px; height: 17px; }
        #mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        @media (max-width: 768px) {
            .main-content { padding: 10px; } #mobile-menu-toggle { display: block; } .sidebar { transform: translateX(-100%); z-index: 1100; } body:not(.sidebar-collapsed) .sidebar { transform: translateX(0); } .page-wrapper, body.sidebar-collapsed .page-wrapper { margin-left: 0; } .filters, .export-section { flex-direction: column; align-items: stretch;} .btn { align-self: auto; width: 100%; margin-top: 10px; } .filter-group .select2-container { width: 100% !important; } #summary-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="sidebar-collapsed">
    <div id="loading-overlay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div class="app-container">
        <!-- Sidebar and Top Bar (No changes) -->
        <div class="sidebar">
            <div class="sidebar-header"> <h2>TR Kids</h2> </div>
            <nav>
                <ul>
                    <li><a href="index.html" class="nav-link"><span class="icon">üìù</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-planner"><span class="icon">üóìÔ∏è</span><span class="nav-text">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (Export)</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-packing"><span class="icon">üì¶</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-product"><span class="icon">üè∑Ô∏è</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-sales-report"><span class="icon">üìà</span><span class="nav-text">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</span></a></li>
                    <li><a href="accounting.html" class="nav-link active"><span class="icon">üìä</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></a></li>
                </ul>
            </nav>
        </div>
        <div class="page-wrapper">
            <header class="top-bar">
                <button id="mobile-menu-toggle">‚ò∞</button>
                <div id="user-info-bar">
                    <span id="welcome-message"></span>
                    <button type="button" id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </header>
            <main class="main-content">
                <div class="container" id="main-container">
                    <!-- Section 1: Sales Report -->
                    <div class="card" id="sales-report-card">
                        <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î)</h2>
                        <div class="filters">
                            <div class="filter-group"> <label for="start-date">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label> <input type="date" id="start-date"> </div>
                            <div class="filter-group"> <label for="end-date">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label> <input type="date" id="end-date"> </div>
                            <div class="filter-group"> <label for="customer-search">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label> <input type="text" id="customer-search" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"> </div>
                            <div class="filter-group"> <label for="amount-search">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label> <input type="number" id="amount-search" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" step="0.01"> </div>
                            <button id="generate-report-btn" class="btn btn-primary">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                            <button id="export-xlsx-btn" class="btn btn-success" disabled>Export to XLSX</button>
                            <button id="export-png-btn" class="btn btn-info" disabled>Export to PNG</button>
                        </div>
                        <div id="summary-container" style="margin-top: 20px;">
                            <p id="initial-summary-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</p>
                        </div>
                    </div>

                    <!-- Section 2: Reconciliation Tool -->
                    <div class="card" id="reconciliation-card">
                        <h2><i class="fa-solid fa-wand-magic-sparkles"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î Statement</h2>
                        <div class="workflow">
                            <div class="step-card">
                                <div class="step-number">1</div>
                                <h3>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Statement</h3>
                                <label for="csvFileInput" class="file-input-wrapper">
                                    <i class="fa-solid fa-cloud-arrow-up"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .csv ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                    <input type="file" id="csvFileInput" accept=".csv">
                                </label>
                                <div id="csvFileName" class="file-name">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">2</div>
                                <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</h3>
                                <div class="form-group" style="width:100%;">
                                    <label for="match-channel-checkbox-container">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
                                    <div id="match-channel-checkbox-container" class="sheet-selector"></div>
                                </div>
                                <div class="file-name">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà<br>‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">3</div>
                                <h3>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3>
                                <button id="match-button" class="action-button"> <i class="fa-solid fa-link"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ </button>
                                <div id="status-area">
                                    <div id="status-text">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                                    <div class="loader" id="loader"></div>
                                </div>
                            </div>
                        </div>
                        <!-- NEW: Statement Export Section -->
                        <div class="export-section">
                            <div class="filter-group">
                                <label for="stmt-start-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</label>
                                <input type="date" id="stmt-start-date">
                            </div>
                            <div class="filter-group">
                                <label for="stmt-end-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)</label>
                                <input type="date" id="stmt-end-date">
                            </div>
                            <button id="export-statement-xlsx-btn" class="btn btn-info">Export Statement (XLSX)</button>
                        </div>
                    </div>
                    
                    <!-- Section 3: Data Tables -->
                    <div class="card" id="data-table-card">
                        <h2 id="data-table-title"><i class="fa-solid fa-table-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Statement ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î</h2>
                        <div id="results-container" class="table-container">
                            <p id="loading-message">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const SUPABASE_URL = 'https://scxcuwjhjbkxvqmpywqs.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeGN1d2poamJreHZxbXB5d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODM4NTMsImV4cCI6MjA3NDg1OTg1M30.UqcmQUxCkOxgDxjtUa8Sbb0cLHT26qOuHfdbtdilkI8';
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let currentReportData = [];
            let channelMap = {}; 

            // --- Layout & Elements ---
            const mainContainer = document.getElementById('main-container');
            const salesReportCard = document.getElementById('sales-report-card');
            const reconciliationCard = document.getElementById('reconciliation-card');
            const dataTableCard = document.getElementById('data-table-card');
            const dataTableTitle = document.getElementById('data-table-title');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const customerSearchInput = document.getElementById('customer-search');
            const amountSearchInput = document.getElementById('amount-search');
            const generateBtn = document.getElementById('generate-report-btn');
            const exportXlsxBtn = document.getElementById('export-xlsx-btn');
            const exportPngBtn = document.getElementById('export-png-btn');
            const summaryContainer = document.getElementById('summary-container');
            const csvFileInput = document.getElementById('csvFileInput');
            const csvFileNameLabel = document.getElementById('csvFileName');
            const matchBtn = document.getElementById('match-button');
            const statusText = document.getElementById('status-text');
            const loader = document.getElementById('loader');
            const resultsContainer = document.getElementById('results-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const logoutBtn = document.getElementById('logout-btn');
            const stmtStartDateInput = document.getElementById('stmt-start-date');
            const stmtEndDateInput = document.getElementById('stmt-end-date');
            const exportStatementXlsxBtn = document.getElementById('export-statement-xlsx-btn');


            // --- Layout Management ---
            function moveTablePosition(mode) {
                if (mode === 'report') {
                    mainContainer.insertBefore(dataTableCard, reconciliationCard);
                } else if (mode === 'reconciliation') {
                    mainContainer.appendChild(dataTableCard);
                }
            }

            // --- === INITIALIZATION & AUTH === ---
            document.getElementById('mobile-menu-toggle').addEventListener('click', () => document.body.classList.toggle('sidebar-collapsed'));
            logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'index.html';
            });
            
            async function checkAuth() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = 'index.html';
                } else {
                    const { data: userData } = await supabaseClient.from('users').select('username, role').eq('id', session.user.id).single();
                    if (!userData || userData.role !== 'superadmin') {
                        alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
                        window.location.href = 'index.html';
                    } else {
                         document.getElementById('welcome-message').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${userData.username}`;
                    }
                }
            }

            function navigateTo(target) {
                localStorage.setItem('navigateTo', target);
                window.location.href = 'index.html';
            }
            document.getElementById('nav-planner').addEventListener('click', (e) => { e.preventDefault(); navigateTo('planner-system-container'); });
            document.getElementById('nav-packing').addEventListener('click', (e) => { e.preventDefault(); navigateTo('packing-system-container'); });
            document.getElementById('nav-product').addEventListener('click', (e) => { e.preventDefault(); navigateTo('product-system-container'); });
            document.getElementById('nav-sales-report').addEventListener('click', (e) => { e.preventDefault(); navigateTo('sales-report-system-container'); });
            
            const today = new Date().toISOString().slice(0, 10);
            startDateInput.value = today;
            endDateInput.value = today;
            stmtStartDateInput.value = today;
            stmtEndDateInput.value = today;

            async function loadChannels() {
                const { data, error } = await supabaseClient.from('channels').select('channel_code, channel_name, bank_account');
                if (error) { console.error('Error loading channels:', error); return; }
                
                channelMap = {};
                const matchChannelContainer = document.getElementById('match-channel-checkbox-container');
                matchChannelContainer.innerHTML = '';
                data.forEach(ch => {
                    channelMap[ch.channel_code] = { name: ch.channel_name, account: ch.bank_account || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
                    const wrapper = document.createElement('div');
                    wrapper.className = 'checkbox-wrapper';
                    wrapper.innerHTML = `<input type="checkbox" id="match-ch-${ch.channel_code}" value="${ch.channel_code}"><label for="match-ch-${ch.channel_code}">${ch.channel_code}</label>`;
                    matchChannelContainer.appendChild(wrapper);
                });
            }

            // --- === SECTION 1: SALES REPORT LOGIC (MODIFIED) === ---
            async function generateReport() {
                moveTablePosition('report');
                dataTableTitle.innerHTML = '<i class="fa-solid fa-table-list"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î)';

                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const customerKeyword = customerSearchInput.value.trim();
                const amountKeyword = amountSearchInput.value.trim();

                if (!startDate || !endDate) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }
                
                generateBtn.disabled = true;
                exportXlsxBtn.disabled = true;
                exportPngBtn.disabled = true;
                currentReportData = [];
                resultsContainer.innerHTML = '<p id="loading-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</p>';
                summaryContainer.innerHTML = '';

                try {
                    // 1. Get all matched bill numbers
                    statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß...';
                    const { data: matchedStatements, error: stmtError } = await supabaseClient
                        .from('bank_statements')
                        .select('bill_no')
                        .eq('is_matched', true)
                        .not('bill_no', 'is', null);

                    if (stmtError) throw stmtError;
                    const matchedBillNos = matchedStatements.map(s => s.bill_no);
                    
                    // 2. Fetch orders that are NOT in the matched list
                    let allFetchedOrders = [];
                    let from = 0;
                    let to = 999;
                    let hasMore = true;

                    while (hasMore) {
                        let query = supabaseClient.from('orders').select('*')
                            .gte('payment_date', startDate)
                            .lte('payment_date', endDate)
                            .not('status', 'eq', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')
                            .not('payment_date', 'is', null);

                        // Exclude matched bills if any exist
                        if (matchedBillNos.length > 0) {
                            query = query.not('bill_no', 'in', `(${matchedBillNos.join(',')})`);
                        }
                        
                        if (customerKeyword) query = query.ilike('customer_name', `%${customerKeyword}%`);
                        if (amountKeyword) query = query.eq('total_amount', amountKeyword);

                        const { data: orders, error } = await query
                            .order('payment_date', { ascending: true })
                            .range(from, to);
                            
                        if (error) throw error;
                        
                        allFetchedOrders = allFetchedOrders.concat(orders);
                        hasMore = orders.length >= 1000;
                        from += 1000; to += 1000;
                    }
                    
                    currentReportData = allFetchedOrders;
                    renderReportResults(allFetchedOrders);
                    
                    if (allFetchedOrders.length > 0) {
                        exportXlsxBtn.disabled = false;
                        exportPngBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error generating report:', error);
                    resultsContainer.innerHTML = `<p style="color:var(--danger-color)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
                } finally {
                    generateBtn.disabled = false;
                    statusText.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                }
            }
            
            function renderReportResults(orders) {
                if (orders.length === 0) {
                    resultsContainer.innerHTML = '<p id="loading-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                    summaryContainer.innerHTML = '<p id="initial-summary-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</p>';
                    return;
                }
                
                const totalSales = orders.reduce((sum, order) => sum + (order.total_amount || 0), 0);
                const totalShipping = orders.reduce((sum, order) => sum + (order.shipping_cost || 0), 0);
                const salesByChannel = {}, salesByAccount = {}, shippingByChannel = {};

                orders.forEach(order => {
                    const channelCode = order.channel_code, amount = order.total_amount || 0, shipping = order.shipping_cost || 0;
                    const channelInfo = channelMap[channelCode] || { name: channelCode, account: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
                    
                    salesByChannel[channelCode] = (salesByChannel[channelCode] || 0) + amount;
                    salesByAccount[channelInfo.account] = (salesByAccount[channelInfo.account] || 0) + amount;
                    shippingByChannel[channelCode] = (shippingByChannel[channelCode] || 0) + shipping;
                });
                
                summaryContainer.innerHTML = `
                <div id="summary-section" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));"> 
                    <div class="summary-box overall-summary"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3> <div class="metric"> <h4>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h4> <div class="value">${formatCurrency(totalSales)}</div> </div> <div class="metric"> <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h4> <div class="value">${orders.length.toLocaleString('th-TH')}</div> </div> </div>
                    <div class="summary-box"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</h3> <table class="summary-table"> ${Object.entries(salesByChannel).map(([code, total]) => `<tr><td>${channelMap[code]?.name || code} (${code})</td><td class="summary-value">${formatCurrency(total)}</td></tr>`).join('')} <tr class="total-row"><td>‡∏£‡∏ß‡∏°</td><td class="summary-value">${formatCurrency(totalSales)}</td></tr> </table> </div>
                    <div class="summary-box"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</h3> <table class="summary-table"> ${Object.entries(shippingByChannel).map(([code, total]) => `<tr><td>${channelMap[code]?.name || code} (${code})</td><td class="summary-value">${formatCurrency(total)}</td></tr>`).join('')} <tr class="total-row"><td>‡∏£‡∏ß‡∏°</td><td class="summary-value">${formatCurrency(totalShipping)}</td></tr> </table> </div>
                    <div class="summary-box"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3> <table class="summary-table"> ${Object.entries(salesByAccount).map(([account, total]) => `<tr><td>${account}</td><td class="summary-value">${formatCurrency(total)}</td></tr>`).join('')} <tr class="total-row"><td>‡∏£‡∏ß‡∏°</td><td class="summary-value">${formatCurrency(totalSales)}</td></tr> </table> </div>
                </div>`;

                const rawDataTableHeaders = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
                let tableHTML = `<table id="salesReportTable"><thead><tr>${rawDataTableHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                orders.forEach(order => {
                    tableHTML += `<tr>
                        <td>${order.payment_date ? new Date(order.payment_date).toLocaleDateString('th-TH') : ''}</td>
                        <td>${order.payment_time ? order.payment_time.substring(0, 5) : ''}</td>
                        <td>${order.bill_no || ''}</td>
                        <td>${order.channel_code || ''}</td>
                        <td>${order.customer_name || ''}</td>
                        <td class="currency">${formatCurrency(order.total_amount || 0)}</td>
                        <td>${order.payment_method || ''}</td>
                        <td>${order.status || ''}</td>
                    </tr>`;
                });
                tableHTML += `</tbody></table>`;
                resultsContainer.innerHTML = tableHTML;
            }

            function exportReportToXLSX() {
                if (currentReportData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export"); return; }
                const ordersByAccount = {};
                currentReportData.forEach(order => {
                    const channelInfo = channelMap[order.channel_code];
                    const accountName = channelInfo ? channelInfo.account : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (!ordersByAccount[accountName]) ordersByAccount[accountName] = [];
                    ordersByAccount[accountName].push(order);
                });
                Object.keys(ordersByAccount).forEach(accountName => {
                    if (ordersByAccount[accountName].length === 0) return;
                    const workbook = XLSX.utils.book_new();
                    let accountData = ordersByAccount[accountName];
                    accountData.sort((a, b) => (a.channel_code || '').localeCompare(b.channel_code || ''));
                    const rawDataHeaders = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞", "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
                    const accountRows = accountData.map(order => [ order.payment_date || '', order.payment_time ? order.payment_time.substring(0, 5) : '', order.bill_no || '', order.channel_code || '', order.customer_name || '', order.price || 0, order.shipping_cost || 0, order.discount || 0, order.total_amount || 0, order.payment_method || '', order.promotion || '', order.status || '' ]);
                    const worksheet = XLSX.utils.aoa_to_sheet([rawDataHeaders, ...accountRows]);
                    const sheetName = accountName.replace(/[\*\:\/\\ \?\[\]]/g, "").substring(0, 31);
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    const sanitizedAccountName = accountName.replace(/[^a-zA-Z0-9-]/g, '_').replace(/_+/g, '_');
                    const fileName = `Unmatched_${sanitizedAccountName}_${startDateInput.value}_to_${endDateInput.value}.xlsx`;
                    XLSX.writeFile(workbook, fileName);
                });
                alert(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î) ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${Object.keys(ordersByAccount).length} ‡πÑ‡∏ü‡∏•‡πå...`);
            }

            function exportReportToPNG() {
                const summaryElement = document.getElementById('summary-container');
                if (!summaryElement || currentReportData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export"); return; }
                loadingOverlay.style.display = 'flex';
                html2canvas(summaryElement, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Unmatched_Summary_${startDateInput.value}_to_${endDateInput.value}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                }).catch(err => {
                    console.error('Error generating PNG:', err);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PNG');
                }).finally(() => {
                    loadingOverlay.style.display = 'none';
                });
            }

            // --- === SECTION 2: RECONCILIATION LOGIC (UPGRADED) === ---
            async function exportStatementToXLSX() {
                const startDate = stmtStartDateInput.value;
                const endDate = stmtEndDateInput.value;
                if (!startDate || !endDate) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export Statement');
                    return;
                }
                loadingOverlay.style.display = 'flex';
                try {
                    const { data, error } = await supabaseClient.from('bank_statements')
                        .select('*')
                        .gte('statement_date', startDate)
                        .lte('statement_date', endDate)
                        .order('statement_date', { ascending: true })
                        .order('statement_time', { ascending: true });
                    if (error) throw error;
                    if (data.length === 0) {
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                        return;
                    }
                    const headers = ["ID", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏ß‡∏•‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô", "‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å", "‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•", "Hash"];
                    const rows = data.map(stmt => [
                        stmt.id, stmt.statement_date, stmt.statement_time, stmt.description,
                        stmt.withdrawal_amount, stmt.deposit_amount, stmt.balance, stmt.channel,
                        stmt.details, stmt.is_matched, stmt.bill_no, stmt.unique_hash
                    ]);
                    const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Statements');
                    const fileName = `Bank_Statements_${startDate}_to_${endDate}.xlsx`;
                    XLSX.writeFile(workbook, fileName);

                } catch (error) {
                    console.error('Error exporting statements:', error);
                    alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Export: ${error.message}`);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function parseCSVLine(line) {
                const result = []; let current = ''; let inQuotes = false;
                for (const char of line.trim()) {
                    if (char === '"') { inQuotes = !inQuotes; continue; }
                    if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; } 
                    else { current += char; }
                }
                result.push(current.trim());
                return result;
            }

            function parseDateToYYYYMMDD(dateString) {
                if (!dateString) return null;
                const s = String(dateString).trim().replace(/[\/\.]/g, '-');
                const parts = s.split('-');
                if (parts.length !== 3) return null;
                let day, month, year;
                if (parts[0].length <= 2 && parts[1].length <= 2) {
                    day = parts[0]; month = parts[1];
                    year = parts[2].length === 2 ? `20${parts[2]}` : parts[2];
                } else if (parts[0].length === 4) {
                    day = parts[2]; month = parts[1]; year = parts[0];
                } else { return null; }
                const dateObj = new Date(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                if (isNaN(dateObj.getTime())) return null;
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }

            function normalizeTimeToHHMMSS(timeInput) {
                if (!timeInput) return '00:00:00';
                let timeStr = String(timeInput).trim().replace(/\./g, ':');
                const parts = timeStr.split(':');
                const hour = (parts[0] || '00').padStart(2, '0');
                const minute = (parts[1] || '00').padStart(2, '0');
                const second = (parts[2] || '00').padStart(2, '0');
                return `${hour}:${minute}:${second}`;
            }
            
            async function handleFileUpload(file) {
                loadingOverlay.style.display = 'flex';
                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå...';
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const lines = event.target.result.split('\n').filter(line => line.trim());
                        const headerRowIndex = lines.findIndex(line => line.replace(/^\uFEFF/, '').includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤/ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'));
                        
                        if (headerRowIndex === -1) {
                            throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤/ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')");
                        }

                        const transactionsToSave = [];
                        for (let i = headerRowIndex + 1; i < lines.length; i++) {
                            try {
                                const cols = parseCSVLine(lines[i]);
                                if (cols.length < 8 || !cols[1] || cols[3].includes('‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤')) continue;

                                const depositAmount = parseFloat(String(cols[6] || '0').replace(/,/g, ''));
                                if (depositAmount <= 0) continue;

                                const statementDate = parseDateToYYYYMMDD(cols[1]);
                                if (!statementDate) continue;

                                const statementTime = normalizeTimeToHHMMSS(cols[2]);
                                const details = cols[12] || '';
                                
                                const uniqueString = `${statementDate}|${statementTime}|${depositAmount.toFixed(2)}|${details}`;
                                const unique_hash = Array.from(uniqueString).reduce((hash, char) => 0 | (31 * hash + char.charCodeAt(0)), 0).toString();

                                transactionsToSave.push({
                                    statement_date: statementDate,
                                    statement_time: statementTime,
                                    description: cols[3] || '',
                                    withdrawal_amount: parseFloat(String(cols[4] || '0').replace(/,/g, '')),
                                    deposit_amount: depositAmount,
                                    balance: parseFloat(String(cols[8] || '0').replace(/,/g, '')),
                                    channel: cols[10] || '',
                                    details: details,
                                    is_matched: false,
                                    unique_hash: unique_hash
                                });
                            } catch (lineError) {
                                console.warn(`Skipping a problematic line due to an error: ${lineError.message}`, lines[i]);
                                continue;
                            }
                        }
                        
                        if (transactionsToSave.length > 0) {
                            statusText.textContent = `‡∏û‡∏ö ${transactionsToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;
                            const { error: upsertError } = await supabaseClient.from('bank_statements').upsert(transactionsToSave, { onConflict: 'unique_hash', ignoreDuplicates: true });

                            if (upsertError) throw upsertError;
                            
                            alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${transactionsToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå`);
                        } else {
                            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
                        }
                    } catch (error) {
                        console.error('Error processing CSV:', error);
                        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
                    } finally {
                        csvFileInput.value = '';
                        csvFileNameLabel.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
                        loadingOverlay.style.display = 'none';
                        statusText.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                        await displayUnmatchedStatements();
                    }
                };
                reader.onerror = () => {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV");
                    loadingOverlay.style.display = 'none';
                };
                reader.readAsText(file, 'UTF-8');
            }
            
            async function displayUnmatchedStatements() {
                moveTablePosition('reconciliation');
                dataTableTitle.innerHTML = '<i class="fa-solid fa-table-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Statement ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î';
                resultsContainer.innerHTML = '<p id="loading-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î...</p>';
                
                const { data, error } = await supabaseClient.from('bank_statements').select('*').eq('is_matched', false).order('statement_date', { ascending: true }).order('statement_time', { ascending: true });

                if (error) {
                    resultsContainer.innerHTML = `<p style="color:var(--danger-color)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`; return [];
                }
                if (data.length === 0) {
                    resultsContainer.innerHTML = '<p id="loading-message">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î</p>'; return [];
                }

                const tableHeaders = ["‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏ß‡∏•‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"];
                let tableHTML = `<table id="statementTable"><thead><tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                data.forEach(stmt => {
                    tableHTML += `<tr data-statement-id="${stmt.id}">
                        <td class="manual-match-cell">
                           <input type="text" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•">
                           <button class="btn btn-success btn-sm manual-save-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </td>
                        <td>${stmt.statement_date ? new Date(stmt.statement_date).toLocaleDateString('th-TH', { year: '2-digit', month: '2-digit', day: '2-digit' }) : ''}</td>
                        <td>${stmt.statement_time ? stmt.statement_time.substring(0, 5) : ''}</td>
                        <td>${stmt.description || ''}</td>
                        <td class="currency">${formatCurrency(stmt.deposit_amount)}</td>
                        <td>${stmt.channel || ''}</td>
                        <td>${stmt.details || ''}</td>
                    </tr>`;
                });
                tableHTML += `</tbody></table>`;
                resultsContainer.innerHTML = tableHTML;

                document.querySelectorAll('.manual-save-btn').forEach(button => button.addEventListener('click', handleManualSave));
                return data;
            }
            
            async function handleManualSave(event) {
                const button = event.target;
                const row = button.closest('tr');
                const statementId = row.dataset.statementId;
                const input = row.querySelector('input[type="text"]');
                const billNo = input.value.trim();

                if (!billNo) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•'); return; }

                button.disabled = true; button.textContent = '...';

                const { error } = await supabaseClient.from('bank_statements').update({ bill_no: billNo, is_matched: true }).eq('id', statementId);

                if (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message);
                    button.disabled = false; button.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                } else {
                    row.classList.add('matched-manual');
                    setTimeout(() => row.remove(), 1000);
                }
            }

            function createMatchKey(date, time, amount) {
                if (!date || !time || !amount) return null;
                const formattedDate = parseDateToYYYYMMDD(date);
                const formattedTime = normalizeTimeToHHMMSS(time).substring(0, 5);
                const formattedAmount = parseFloat(String(amount).replace(/,/g, '')).toFixed(2);
                return `${formattedDate}T${formattedTime}_${formattedAmount}`;
            }

            async function matchData() {
                loader.style.display = 'block'; matchBtn.disabled = true;
                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Statement...';

                const unmatchedStatements = await displayUnmatchedStatements();
                if (unmatchedStatements.length === 0) {
                    loader.style.display = 'none'; matchBtn.disabled = false;
                    statusText.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà'; return;
                }

                const dates = unmatchedStatements.map(s => s.statement_date);
                const startDate = dates.reduce((a, b) => a < b ? a : b);
                const endDate = dates.reduce((a, b) => a > b ? a : b);

                const selectedChannels = Array.from(document.querySelectorAll('#match-channel-checkbox-container input:checked')).map(cb => cb.value);
                if (selectedChannels.length === 0) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    loader.style.display = 'none'; matchBtn.disabled = false; return;
                }
                
                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô...';
                try {
                    const { data: orders, error } = await supabaseClient.from('orders').select('bill_no, payment_date, payment_time, total_amount, channel_code').gte('payment_date', startDate).lte('payment_date', endDate).in('channel_code', selectedChannels).not('status', 'eq', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å').gt('total_amount', 0);
                    if (error) throw error;
                    
                    const productionDataMap = new Map();
                    orders.forEach(order => {
                        const key = createMatchKey(order.payment_date, order.payment_time, order.total_amount);
                        if (key) {
                            if (!productionDataMap.has(key)) productionDataMap.set(key, []);
                            productionDataMap.get(key).push({ 'bill_no': order.bill_no, 'source': order.channel_code });
                        }
                    });

                    statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                    let updatesToPerform = []; let matchedCount = 0;

                    unmatchedStatements.forEach(stmt => {
                        const key = createMatchKey(stmt.statement_date, stmt.statement_time, stmt.deposit_amount);
                        if (key && productionDataMap.has(key)) {
                            const prodDataArray = productionDataMap.get(key);
                            if (prodDataArray.length > 0) {
                                const prodData = prodDataArray.shift();
                                updatesToPerform.push({ id: stmt.id, bill_no: prodData.bill_no, is_matched: true });
                                matchedCount++;
                                if (prodDataArray.length === 0) productionDataMap.delete(key);
                            }
                        }
                    });

                    if (updatesToPerform.length > 0) {
                        statusText.textContent = `‡∏û‡∏ö ${updatesToPerform.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;
                        
                        const updatePromises = updatesToPerform.map(item => 
                            supabaseClient
                                .from('bank_statements')
                                .update({ bill_no: item.bill_no, is_matched: true })
                                .eq('id', item.id)
                        );
                        const results = await Promise.all(updatePromises);
                        const firstErrorResult = results.find(res => res.error);
                        if (firstErrorResult) {
                            throw firstErrorResult.error;
                        }
                    }
                    
                    statusText.textContent = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö ${matchedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    alert(`‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö ${matchedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                    statusText.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!';
                } finally {
                    loader.style.display = 'none'; matchBtn.disabled = false;
                    await displayUnmatchedStatements();
                }
            }

            function formatCurrency(num) {
                return (num || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            // --- === EVENT LISTENERS === ---
            generateBtn.addEventListener('click', generateReport);
            exportXlsxBtn.addEventListener('click', exportReportToXLSX);
            exportPngBtn.addEventListener('click', exportReportToPNG);
            exportStatementXlsxBtn.addEventListener('click', exportStatementToXLSX);
            
            csvFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    csvFileNameLabel.textContent = file.name;
                    handleFileUpload(file);
                }
            });
            matchBtn.addEventListener('click', matchData);
            
            // --- === INITIAL LOAD === ---
            await checkAuth();
            await loadChannels();
            await displayUnmatchedStatements();
        });
    </script>
</body>
</html>

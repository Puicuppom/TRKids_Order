<!-- START OF FILE accounting.html -->

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR Kids - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</title>

    <!-- Select2 CSS/JS removed as it's no longer needed for the filter, 
         but kept in case you want to use it elsewhere or for future features. 
         If completely unused, you can remove the Select2 CDN links below. -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- General Layout Styles --- */
        :root{--sidebar-width:240px;--sidebar-width-collapsed:65px;--top-bar-height:60px;--primary-color:#0056b3;--sidebar-bg:#1d2b3a;--sidebar-link-color:#c5d6de;--sidebar-link-hover-bg:#2a3f54;--sidebar-link-active-bg:#0071e3;--top-bar-bg:#4F634A}*{box-sizing:border-box}body{font-family:'Sarabun', sans-serif;margin:0;background-color:#f4f7f9}.app-container{display:flex;height:100vh}.sidebar{width:var(--sidebar-width);height:100%;position:fixed;z-index:1001;top:0;left:0;background-color:var(--sidebar-bg);transition:width .3s ease, transform .3s ease;color:#fff;padding-top:20px;flex-shrink:0}.page-wrapper{display:flex;flex-direction:column;width:100%;margin-left:var(--sidebar-width);transition:margin-left .3s ease}.top-bar{height:var(--top-bar-height);background-color:var(--top-bar-bg);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-shrink:0;box-shadow:0 2px 5px rgba(0,0,0,.1)}.main-content{flex-grow:1;overflow-y:auto;padding:20px;height:calc(100vh - var(--top-bar-height))}.sidebar .sidebar-header{padding:0 20px 20px;text-align:center;border-bottom:1px solid #3a4b5f;white-space:nowrap}.sidebar .sidebar-header h2{margin:0;font-size:1.6em;font-weight:600}.sidebar nav ul{list-style-type:none;padding:20px 0;margin:0}.sidebar nav li a{display:flex;align-items:center;padding:15px 20px;text-decoration:none;font-size:16px;color:var(--sidebar-link-color);white-space:nowrap;transition:background-color .2s ease-in-out}.sidebar nav li a .icon{margin-right:15px;font-size:1.5em;width:30px;text-align:center}.sidebar nav li a:hover{background-color:var(--sidebar-link-hover-bg)}.sidebar nav li a.active{background-color:var(--sidebar-link-active-bg);color:#fff;font-weight:700}body.sidebar-collapsed .sidebar{width:var(--sidebar-width-collapsed)}body.sidebar-collapsed .page-wrapper{margin-left:var(--sidebar-width-collapsed)}body.sidebar-collapsed .sidebar .sidebar-header h2,body.sidebar-collapsed .sidebar .nav-text{opacity:0;visibility:hidden}body.sidebar-collapsed .sidebar .nav-link .icon{margin-right:0}#user-info-bar{display:flex;align-items:center;gap:15px;font-size:14px}#logout-btn{background-color:#6c757d;color:#fff;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-size:14px}#loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);color:#fff;display:none;justify-content:center;align-items:center;z-index:9999;font-size:2em}
        
        /* --- Accounting Page Specific Styles --- */
        :root { --card-bg: #ffffff; --text-color: #333; --muted-color: #6c757d; --border-color: #dee2e6; --success-color: #28a745; --danger-color: #dc3545; --info-color: #17a2b8; --secondary-color: #007bff; }
        .container { max-width: 1600px; margin: 0 auto; padding: 0; display: flex; flex-direction: column; gap: 20px; }
        .card { background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 0; }
        h1, h2 { color: var(--primary-color); text-align: center; }
        .filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; justify-content: center;}
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; margin-bottom: 5px; font-size: 14px; }
        
        /* === FIX: Standardize Input Heights === */
        /* Force standard inputs to be 45px */
        .filter-group input, .filter-group select { 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            font-size: 16px; 
            height: 45px !important; 
            box-sizing: border-box;
            line-height: normal;
        }

        .btn { padding: 12px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; color: #fff; height: 45px; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-info { background-color: var(--info-color); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #summary-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .summary-box { background-color: #f8f9fa; padding: 20px; border-radius: 8px; }
        .summary-box h3 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .summary-table { width: 100%; text-align: left; }
        .summary-table th, .summary-table td { padding: 8px 4px; border-bottom: 1px solid var(--border-color); }
        .summary-table tr:last-child td { border-bottom: none; }
        .summary-table .total-row { font-weight: bold; background-color: #e9ecef; }
        .summary-value { font-weight: 700; text-align: right; }
        .overall-summary { text-align: center; }
        .overall-summary .metric { margin-bottom: 15px; }
        .overall-summary .metric h4 { margin: 0 0 5px; color: var(--muted-color); font-size: 16px;}
        .overall-summary .metric .value { font-size: 2.2em; font-weight: 700; color: var(--primary-color); }

        .table-container { overflow-x: auto; max-height: 70vh;}
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; white-space: nowrap; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; }
        #statementTable th { background-color: var(--primary-color); color: white;}
        td.currency { text-align: right; }
        #loading-message { text-align: center; font-size: 1.2em; color: var(--muted-color); padding: 40px; }
        
        /* --- Reconciliation Tool Styles --- */
        .workflow { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .step-card { background: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 1rem; }
        .step-card .step-number { background-color: var(--primary-color); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; flex-shrink: 0; }
        .step-card h3 { margin: 0; color: #343a40; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; cursor: pointer; padding: 10px 20px; font-size: 1rem; background-color: var(--secondary-color); color: white; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .file-input-wrapper:hover { background-color: var(--primary-color); }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .file-name { margin-top: 0.5rem; font-style: italic; color: #6c757d; font-size: 0.9rem; word-break: break-all; }
        .action-button { font-size: 1.1rem; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; width: 100%; transition: background-color: 0.3s; }
        #match-button { background-color: var(--success-color); color: white; }
        #export-matched-btn { background-color: var(--info-color); color: white; }
        .action-button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #status-area { width: 100%; text-align: center; padding: 1rem; background-color: #fff; border: 1px dashed var(--border-color); border-radius: 8px; box-sizing: border-box; }
        #summary-dashboard { width: 100%; margin-top: 1rem; text-align: left; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .summary-item:last-child { border-bottom: none; }
        .summary-label { font-weight: 500; display: flex; align-items: center; gap: 8px;}
        .summary-breakdown h4 { margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .breakdown-value { display: flex; gap: 2rem; align-items: center; }
        .breakdown-value .count-column { min-width: 130px; }
        .breakdown-value .amount-column { min-width: 220px; }
        tr.matched { background-color: #d4edda !important; color: #155724; font-weight: 500; }
        .loader { display: none; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .sheet-selector { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); justify-content: start; gap: 10px 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: #fff; box-sizing: border-box; }
        .checkbox-wrapper { display: flex; align-items: center; }
        .checkbox-wrapper input[type="checkbox"] { margin-right: 8px; width: 17px; height: 17px; }
        .step-card .form-group { width: 100%; }
        .step-card .form-group label { text-align: left; }

        #mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        @media (max-width: 768px) {
            .main-content { padding: 10px; } #mobile-menu-toggle { display: block; } .sidebar { transform: translateX(-100%); z-index: 1100; } body:not(.sidebar-collapsed) .sidebar { transform: translateX(0); } .page-wrapper, body.sidebar-collapsed .page-wrapper { margin-left: 0; } .filters { flex-direction: column; align-items: stretch;} .btn { align-self: auto; width: 100%; margin-top: 10px; } .filter-group .select2-container { width: 100% !important; } #summary-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="sidebar-collapsed">
    <div id="loading-overlay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header"> <h2>TR Kids</h2> </div>
            <nav>
                <ul>
                    <li><a href="index.html" class="nav-link"><span class="icon">üìù</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-planner"><span class="icon">üóìÔ∏è</span><span class="nav-text">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (Export)</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-packing"><span class="icon">üì¶</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-product"><span class="icon">üè∑Ô∏è</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-sales-report"><span class="icon">üìà</span><span class="nav-text">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</span></a></li>
                    <li><a href="accounting.html" class="nav-link active"><span class="icon">üìä</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></a></li>
                </ul>
            </nav>
        </div>

        <div class="page-wrapper">
            <header class="top-bar">
                <button id="mobile-menu-toggle">‚ò∞</button>
                <div id="user-info-bar">
                    <span id="welcome-message"></span>
                    <button type="button" id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </header>
            <main class="main-content">
                <div class="container" id="main-container">
                    <!-- Section 1: Sales Report -->
                    <div class="card" id="sales-report-card">
                        <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)</h2>
                        <div class="filters">
                            <div class="filter-group"> <label for="start-date">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label> <input type="date" id="start-date"> </div>
                            <div class="filter-group"> <label for="end-date">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label> <input type="date" id="end-date"> </div>
                            
                            <!-- Channel Search removed here -->

                            <!-- Search Filters -->
                            <div class="filter-group"> <label for="customer-search">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label> <input type="text" id="customer-search" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"> </div>
                            <div class="filter-group"> <label for="amount-search">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label> <input type="number" id="amount-search" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" step="0.01"> </div>
                            
                            <button id="generate-report-btn" class="btn btn-primary">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                            <button id="export-xlsx-btn" class="btn btn-success" disabled>Export to XLSX</button>
                            <button id="export-png-btn" class="btn btn-info" disabled>Export to PNG</button>
                        </div>
                        <div id="summary-container" style="margin-top: 20px;">
                            <p id="initial-summary-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</p>
                        </div>
                    </div>

                    <!-- Section 2: Reconciliation Tool (ID added for ordering) -->
                    <div class="card" id="reconciliation-card">
                        <h2><i class="fa-solid fa-wand-magic-sparkles"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î Statement</h2>
                        <div class="workflow">
                            <div class="step-card">
                                <div class="step-number">1</div>
                                <h3>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Statement</h3>
                                <label for="csvFileInput" class="file-input-wrapper">
                                    <i class="fa-solid fa-file-csv"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .csv
                                    <input type="file" id="csvFileInput" accept=".csv">
                                </label>
                                <div id="csvFileName" class="file-name">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">2</div>
                                <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</h3>
                                <div class="form-group">
                                    <label for="match-channel-checkbox-container">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
                                    <div id="match-channel-checkbox-container" class="sheet-selector">
                                        <!-- Checkboxes will be inserted here dynamically -->
                                    </div>
                                </div>
                                <div class="file-name">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î<br>‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Statement ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">3</div>
                                <h3>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                                <button id="match-button" class="action-button" disabled> <i class="fa-solid fa-link"></i> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà </button>
                                <button id="export-matched-btn" class="action-button" disabled> <i class="fa-solid fa-file-export"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå </button>
                                <div id="status-area">
                                    <div id="status-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Statement</div>
                                    <div class="loader" id="loader"></div>
                                </div>
                                <div id="summary-dashboard"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Data Tables (ID added for ordering) -->
                    <div class="card" id="data-table-card">
                        <h2><i class="fa-solid fa-table-list"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                        <div id="results-container" class="table-container">
                            <p id="loading-message">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î" ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://scxcuwjhjbkxvqmpywqs.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeGN1d2poamJreHZxbXB5d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODM4NTMsImV4cCI6MjA3NDg1OTg1M30.UqcmQUxCkOxgDxjtUa8Sbb0cLHT26qOuHfdbtdilkI8';
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let currentReportData = [];
            let channelMap = {}; 

            // --- Layout Management ---
            const mainContainer = document.getElementById('main-container');
            const reportCard = document.getElementById('sales-report-card');
            const reconciliationCard = document.getElementById('reconciliation-card');
            const dataTableCard = document.getElementById('data-table-card');

            function moveTablePosition(mode) {
                if (mode === 'report') {
                    // Move Table to sit after Report Card
                    if (mainContainer.contains(dataTableCard) && mainContainer.contains(reconciliationCard)) {
                        mainContainer.insertBefore(dataTableCard, reconciliationCard);
                    }
                } else if (mode === 'reconciliation') {
                    // Move Table to the end (default position)
                    mainContainer.appendChild(dataTableCard);
                }
            }

            // --- Sales Report Elements ---
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            // Removed: channelFilterSelect reference
            const customerSearchInput = document.getElementById('customer-search');
            const amountSearchInput = document.getElementById('amount-search');

            const generateBtn = document.getElementById('generate-report-btn');
            const exportXlsxBtn = document.getElementById('export-xlsx-btn');
            const exportPngBtn = document.getElementById('export-png-btn');
            const summaryContainer = document.getElementById('summary-container');
            
            // --- Reconciliation Tool Elements ---
            const csvFileInput = document.getElementById('csvFileInput');
            const csvFileNameLabel = document.getElementById('csvFileName');
            const matchBtn = document.getElementById('match-button');
            const exportMatchedBtn = document.getElementById('export-matched-btn');
            const statusText = document.getElementById('status-text');
            const loader = document.getElementById('loader');
            const summaryDashboard = document.getElementById('summary-dashboard');

            // --- Shared Elements ---
            const resultsContainer = document.getElementById('results-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const logoutBtn = document.getElementById('logout-btn');

            // --- Reconciliation State ---
            let productionDataMap = new Map();
            let filesReady = { csv: false };
            let csvDateRange = { start: null, end: null };
            let totalStatementItems = 0;
            let totalStatementSum = 0;
            let totalProductionSum = 0;
            let productionItemsBySource = {};
            let productionSumBySource = {};
            let countedBillsBySource = {};


            // --- === INITIALIZATION & AUTH === ---
            document.getElementById('mobile-menu-toggle').addEventListener('click', () => document.body.classList.toggle('sidebar-collapsed'));
            logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'index.html';
            });
            
            async function checkAuth() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = 'index.html';
                } else {
                    const { data: userData } = await supabaseClient.from('users').select('username, role').eq('id', session.user.id).single();
                    if (!userData || userData.role !== 'superadmin') {
                        alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
                        window.location.href = 'index.html';
                    } else {
                         document.getElementById('welcome-message').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${userData.username}`;
                    }
                }
            }

            function navigateTo(target) {
                localStorage.setItem('navigateTo', target);
                window.location.href = 'index.html';
            }
            document.getElementById('nav-planner').addEventListener('click', (e) => { e.preventDefault(); navigateTo('planner-system-container'); });
            document.getElementById('nav-packing').addEventListener('click', (e) => { e.preventDefault(); navigateTo('packing-system-container'); });
            document.getElementById('nav-product').addEventListener('click', (e) => { e.preventDefault(); navigateTo('product-system-container'); });
            document.getElementById('nav-sales-report').addEventListener('click', (e) => { e.preventDefault(); navigateTo('sales-report-system-container'); });

            // Removed: Select2 initialization for channel filter
            
            const today = new Date().toISOString().slice(0, 10);
            startDateInput.value = today;
            endDateInput.value = today;

            async function loadChannels() {
                const { data, error } = await supabaseClient.from('channels').select('channel_code, channel_name, bank_account');
                if (error) { console.error('Error loading channels:', error); return; }
                
                channelMap = {};
                // Removed: channelFilterSelect clearing
                const matchChannelContainer = document.getElementById('match-channel-checkbox-container');
                matchChannelContainer.innerHTML = '';

                data.forEach(ch => {
                    channelMap[ch.channel_code] = { name: ch.channel_name, account: ch.bank_account || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
                    
                    // Removed: Logic to append option to the channel select filter
                    
                    // For Reconciliation Checkboxes (Kept intact)
                    const wrapper = document.createElement('div');
                    wrapper.className = 'checkbox-wrapper';
                    wrapper.innerHTML = `<input type="checkbox" id="match-ch-${ch.channel_code}" value="${ch.channel_code}"><label for="match-ch-${ch.channel_code}">${ch.channel_code}</label>`;
                    matchChannelContainer.appendChild(wrapper);
                });
                // Removed: channelFilterSelect trigger change
            }

            // --- === SECTION 1: SALES REPORT LOGIC === ---
            async function generateReport() {
                // *** MOVE TABLE UP ***
                moveTablePosition('report');

                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const customerKeyword = customerSearchInput.value.trim();
                const amountKeyword = amountSearchInput.value.trim();

                if (!startDate || !endDate) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }
                
                generateBtn.disabled = true;
                exportXlsxBtn.disabled = true;
                exportPngBtn.disabled = true;
                currentReportData = [];
                resultsContainer.innerHTML = '<p id="loading-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</p>';
                summaryContainer.innerHTML = '';

                try {
                    let allFetchedOrders = [];
                    let from = 0;
                    let to = 999;
                    let hasMore = true;

                    // --- ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö) ---
                    while (hasMore) {
                        let query = supabaseClient.from('orders').select('*')
                            .gte('payment_date', startDate)
                            .lte('payment_date', endDate)
                            .not('status', 'eq', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')
                            .not('payment_date', 'is', null)
                            .range(from, to); // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏•‡∏∞ 1,000 ‡πÅ‡∏ñ‡∏ß

                        if (customerKeyword) {
                            query = query.ilike('customer_name', `%${customerKeyword}%`);
                        }
                        if (amountKeyword) {
                            query = query.eq('total_amount', amountKeyword);
                        }

                        const { data: orders, error } = await query.order('payment_date', { ascending: true });
                        if (error) throw error;
                        
                        allFetchedOrders = allFetchedOrders.concat(orders);

                        if (orders.length < 1000) {
                            hasMore = false; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 1,000 ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß
                        } else {
                            from += 1000;
                            to += 1000;
                        }
                    }
                    
                    currentReportData = allFetchedOrders;
                    renderReportResults(allFetchedOrders);
                    
                    if (allFetchedOrders.length > 0) {
                        exportXlsxBtn.disabled = false;
                        exportPngBtn.disabled = false;
                    }

                } catch (error) {
                    console.error('Error generating report:', error);
                    resultsContainer.innerHTML = `<p style="color:var(--danger-color)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
                } finally {
                    generateBtn.disabled = false;
                }
            }
            
            function renderReportResults(orders) {
                if (orders.length === 0) {
                    resultsContainer.innerHTML = '<p id="loading-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                    summaryContainer.innerHTML = '<p id="initial-summary-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</p>';
                    return;
                }
                
                const totalSales = orders.reduce((sum, order) => sum + (order.total_amount || 0), 0);
                const salesByChannel = {}, salesByAccount = {};

                orders.forEach(order => {
                    const channelCode = order.channel_code, amount = order.total_amount || 0;
                    const channelInfo = channelMap[channelCode] || { name: channelCode, account: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
                    salesByChannel[channelCode] = (salesByChannel[channelCode] || 0) + amount;
                    salesByAccount[channelInfo.account] = (salesByAccount[channelInfo.account] || 0) + amount;
                });
                
                summaryContainer.innerHTML = `
                <div id="summary-section">
                    <div class="summary-box overall-summary"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3> <div class="metric"> <h4>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h4> <div class="value">${formatCurrency(totalSales)}</div> </div> <div class="metric"> <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h4> <div class="value">${orders.length.toLocaleString('th-TH')}</div> </div> </div>
                    <div class="summary-box"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</h3> <table class="summary-table"> ${Object.entries(salesByChannel).map(([code, total]) => `<tr><td>${channelMap[code]?.name || code} (${code})</td><td class="summary-value">${formatCurrency(total)}</td></tr>`).join('')} <tr class="total-row"><td>‡∏£‡∏ß‡∏°</td><td class="summary-value">${formatCurrency(totalSales)}</td></tr> </table> </div>
                    <div class="summary-box"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3> <table class="summary-table"> ${Object.entries(salesByAccount).map(([account, total]) => `<tr><td>${account}</td><td class="summary-value">${formatCurrency(total)}</td></tr>`).join('')} <tr class="total-row"><td>‡∏£‡∏ß‡∏°</td><td class="summary-value">${formatCurrency(totalSales)}</td></tr> </table> </div>
                </div>`;

                const rawDataTableHeaders = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
                let tableHTML = `<table><thead><tr>${rawDataTableHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                orders.forEach(order => {
                    tableHTML += `<tr>
                        <td>${order.payment_date ? new Date(order.payment_date).toLocaleDateString('th-TH') : ''}</td>
                        <td>${order.payment_time ? order.payment_time.substring(0, 5) : ''}</td>
                        <td>${order.bill_no || ''}</td>
                        <td>${order.channel_code || ''}</td>
                        <td>${order.customer_name || ''}</td>
                        <td class="currency">${formatCurrency(order.total_amount || 0)}</td>
                        <td>${order.payment_method || ''}</td>
                        <td>${order.status || ''}</td>
                    </tr>`;
                });
                tableHTML += `</tbody></table>`;
                resultsContainer.innerHTML = tableHTML;
            }

            function exportReportToXLSX() {
                if (currentReportData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export"); return; }
                const ordersByAccount = {};
                currentReportData.forEach(order => {
                    const channelInfo = channelMap[order.channel_code];
                    const accountName = channelInfo ? channelInfo.account : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (!ordersByAccount[accountName]) ordersByAccount[accountName] = [];
                    ordersByAccount[accountName].push(order);
                });
                Object.keys(ordersByAccount).forEach(accountName => {
                    if (ordersByAccount[accountName].length === 0) return;
                    const workbook = XLSX.utils.book_new();
                    let accountData = ordersByAccount[accountName];
                    accountData.sort((a, b) => (a.channel_code || '').localeCompare(b.channel_code || ''));
                    const rawDataHeaders = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞", "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
                    const accountRows = accountData.map(order => [ order.payment_date || '', order.payment_time ? order.payment_time.substring(0, 5) : '', order.bill_no || '', order.channel_code || '', order.customer_name || '', order.price || 0, order.shipping_cost || 0, order.discount || 0, order.total_amount || 0, order.payment_method || '', order.promotion || '', order.status || '' ]);
                    const worksheet = XLSX.utils.aoa_to_sheet([rawDataHeaders, ...accountRows]);
                    const sheetName = accountName.replace(/[\*\:\/\\ \?\[\]]/g, "").substring(0, 31);
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    const sanitizedAccountName = accountName.replace(/[^a-zA-Z0-9-]/g, '_').replace(/_+/g, '_');
                    const fileName = `${sanitizedAccountName}_${startDateInput.value}_to_${endDateInput.value}.xlsx`;
                    XLSX.writeFile(workbook, fileName);
                });
                alert(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${Object.keys(ordersByAccount).length} ‡πÑ‡∏ü‡∏•‡πå...`);
            }

            function exportReportToPNG() {
                const summaryElement = document.getElementById('summary-container');
                if (!summaryElement || currentReportData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export"); return; }
                loadingOverlay.style.display = 'flex';
                html2canvas(summaryElement, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `SummaryReport_${startDateInput.value}_to_${endDateInput.value}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                }).catch(err => {
                    console.error('Error generating PNG:', err);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PNG');
                }).finally(() => {
                    loadingOverlay.style.display = 'none';
                });
            }


            // --- === SECTION 2: RECONCILIATION LOGIC === ---
            
            function updateMatchButtonState() {
                if (filesReady.csv) {
                    matchBtn.disabled = false;
                    statusText.textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà`;
                    statusText.style.color = 'var(--success-color)';
                } else {
                    matchBtn.disabled = true;
                    statusText.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Statement';
                    statusText.style.color = 'var(--dark-color)';
                }
                exportMatchedBtn.disabled = true;
                summaryDashboard.innerHTML = '';
            }

            function parseCSVLine(line) {
                const result = []; let current = ''; let inQuotes = false;
                for (const char of line.trim()) {
                    if (char === '"') { inQuotes = !inQuotes; continue; }
                    if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; } 
                    else { current += char; }
                }
                result.push(current.trim());
                return result;
            }

            function parseDateToYYYYMMDD(dateString) {
                if (!dateString) return null;
                const s = String(dateString).trim().replace(/[\/\.]/g, '-');
                const parts = s.split('-');
                if (parts.length !== 3) return null;
                let day, month, year;
                if (parts[0].length <= 2 && parts[1].length <= 2) {
                    day = parts[0]; month = parts[1];
                    year = parts[2].length === 2 ? `20${parts[2]}` : parts[2];
                } else if (parts[0].length === 4) {
                    day = parts[2]; month = parts[1]; year = parts[0];
                } else { return null; }
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }

            function normalizeTimeToHHMM(timeInput) {
                if (!timeInput) return '00:00';
                let timeStr = String(timeInput).trim().replace(/\./g, ':');
                const match = timeStr.match(/(\d{1,2}):(\d{2})/);
                if (match) {
                    const hour = match[1].padStart(2, '0');
                    const minute = match[2];
                    return `${hour}:${minute}`;
                }
                return '00:00';
            }

            function loadCSV(file) {
                // *** MOVE TABLE DOWN ***
                moveTablePosition('reconciliation');

                const reader = new FileReader();
                reader.onload = (event) => {
                    totalStatementItems = 0; totalStatementSum = 0;
                    const lines = event.target.result.split('\n').filter(line => line.trim());
                    resultsContainer.innerHTML = '';
                    
                    const headerRowIndex = lines.findIndex(line => line.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤/ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'));
                    if (headerRowIndex === -1) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV"); filesReady.csv = false; return; }
                    
                    const datesInCsv = new Set();
                    for (let i = headerRowIndex + 1; i < lines.length; i++) {
                        const cols = parseCSVLine(lines[i]);
                        if (cols.length > 1 && cols[1]) {
                            const formattedDate = parseDateToYYYYMMDD(cols[1]);
                            if (formattedDate) datesInCsv.add(formattedDate);
                        }
                    }
                    const sortedDates = Array.from(datesInCsv).sort();
                    if(sortedDates.length > 0) {
                        csvDateRange.start = sortedDates[0];
                        csvDateRange.end = sortedDates[sortedDates.length - 1];
                    }

                    const tableHeaders = ["‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡∏ú‡∏•‡∏¥‡∏ï", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏ß‡∏•‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", "‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô", "‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"];
                    let tableHTML = `<table id="statementTable"><thead><tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                    
                    for (let i = headerRowIndex + 1; i < lines.length; i++) {
                        const cols = parseCSVLine(lines[i]);
                        if (cols.length < 8 || !cols[1]) continue;
                        const depositAmountRaw = cols[6] || '';
                        const depositAmount = parseFloat(String(depositAmountRaw).replace(/,/g, '')) || 0;
                        if (depositAmount > 0) { totalStatementItems++; totalStatementSum += depositAmount; }
                        
                        tableHTML += `<tr>
                            <td>N/A</td> <td>${cols[1] || ''}</td> <td>${cols[2] || ''}</td> <td>${cols[3] || ''}</td>
                            <td class="currency">${cols[4] || ''}</td> <td class="currency">${depositAmountRaw}</td> <td class="currency">${cols[8] || ''}</td>
                            <td>${cols[10] || ''}</td> <td>${cols[12] || ''}</td>
                        </tr>`;
                    }
                    tableHTML += `</tbody></table>`;
                    resultsContainer.innerHTML = tableHTML;
                    filesReady.csv = true;
                    updateMatchButtonState();
                };
                reader.onerror = () => { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV"); filesReady.csv = false; };
                reader.readAsText(file, 'TIS-620');
            }

            async function loadProductionDataFromSupabase(startDateString, endDateString) {
                if (!startDateString || !endDateString) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Statement ‡πÑ‡∏î‡πâ');
                
                const selectedChannels = Array.from(document.querySelectorAll('#match-channel-checkbox-container input:checked')).map(cb => cb.value);
                if (!selectedChannels || selectedChannels.length === 0) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

                let query = supabaseClient.from('orders').select('bill_no, payment_date, payment_time, total_amount, channel_code')
                    .gte('payment_date', startDateString)
                    .lte('payment_date', endDateString)
                    .in('channel_code', selectedChannels)
                    .not('status', 'eq', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')
                    .gt('total_amount', 0);

                const { data: orders, error } = await query;
                if (error) throw error;
                
                productionDataMap.clear();
                totalProductionSum = 0; productionItemsBySource = {}; productionSumBySource = {}; countedBillsBySource = {};

                orders.forEach(order => {
                    const key = createMatchKeyFromOrder(order.payment_date, order.payment_time, order.total_amount);
                    if (key) {
                        if (!productionDataMap.has(key)) {
                            productionDataMap.set(key, []);
                        }
                        productionDataMap.get(key).push({ '‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•': order.bill_no, 'source': order.channel_code });
                    }
                    
                    const sourceName = order.channel_code;
                    totalProductionSum += order.total_amount;
                    productionSumBySource[sourceName] = (productionSumBySource[sourceName] || 0) + order.total_amount;

                    if (!countedBillsBySource[sourceName]) countedBillsBySource[sourceName] = new Set();
                    if (!countedBillsBySource[sourceName].has(order.bill_no)) {
                        productionItemsBySource[sourceName] = (productionItemsBySource[sourceName] || 0) + 1;
                        countedBillsBySource[sourceName].add(order.bill_no);
                    }
                });
            }
            
            function createMatchKeyFromOrder(orderDate, orderTime, orderAmount) {
                if (!orderDate || !orderTime) return null;
                const formattedDate = parseDateToYYYYMMDD(orderDate);
                if(!formattedDate) return null;
                const formattedTime = normalizeTimeToHHMM(orderTime);
                return `${formattedDate}T${formattedTime}_${parseFloat(String(orderAmount).replace(/,/g, '')).toFixed(2)}`;
            }
            
            function createMatchKeyFromCSV(stmtDate, stmtTime, stmtAmount) {
                const formattedDate = parseDateToYYYYMMDD(stmtDate);
                if(!formattedDate) return null;
                const formattedTime = normalizeTimeToHHMM(stmtTime);
                return `${formattedDate}T${formattedTime}_${parseFloat(String(stmtAmount).replace(/,/g, '')).toFixed(2)}`;
            }

            async function matchData() {
                // Ensure table is in the reconciliation position
                moveTablePosition('reconciliation');

                const tableRows = document.querySelectorAll("#statementTable tbody tr");
                if (tableRows.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà"); return; }
                
                matchBtn.disabled = true; loader.style.display = 'block';
                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

                try {
                    await loadProductionDataFromSupabase(csvDateRange.start, csvDateRange.end);
                } catch (error) {
                    alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô: ${error.message}`);
                    loader.style.display = 'none'; statusText.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!';
                    statusText.style.color = 'red'; matchBtn.disabled = false; return;
                }

                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                let matchedCount = 0; let matchedSum = 0;
                const matchedSources = {};
                
                tableRows.forEach(row => {
                    if(row.classList.contains('matched')) return;
                    const stmtDate = row.cells[1].innerText, stmtTime = row.cells[2].innerText;
                    const stmtAmount = parseFloat(String(row.cells[5].innerText).replace(/,/g, '')) || 0;
                    if (stmtAmount <= 0) return;
                    
                    const key = createMatchKeyFromCSV(stmtDate, stmtTime, stmtAmount);
                    if (!key) return;
                    
                    if (productionDataMap.has(key)) {
                        const prodDataArray = productionDataMap.get(key);
                        if (prodDataArray.length > 0) {
                            const prodData = prodDataArray.shift();
                            row.cells[0].innerText = prodData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•'] || 'N/A';
                            row.classList.add('matched');
                            
                            matchedCount++; matchedSum += stmtAmount;
                            const source = prodData.source;
                            if (!matchedSources[source]) matchedSources[source] = { count: new Set(), sum: 0 };
                            matchedSources[source].count.add(prodData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•']);
                            matchedSources[source].sum += stmtAmount;
                            
                            if (prodDataArray.length === 0) productionDataMap.delete(key);
                        }
                    }
                });
                
                loader.style.display = 'none'; matchBtn.disabled = false;
                statusText.innerHTML = `<strong>‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!</strong>`;
                
                let summaryHTML = `<div class="summary-item"><span class="summary-label"><i class="fa-solid fa-coins"></i> ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏° (‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span><span class="summary-value">${formatCurrency(matchedSum)} / ${formatCurrency(totalStatementSum)} ‡∏ö‡∏≤‡∏ó</span></div><div class="summary-item"><span class="summary-label"><i class="fa-solid fa-list-check"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span><span class="summary-value">${matchedCount} / ${totalStatementItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div>`;
                let matchedBreakdownHTML = `<div class="summary-breakdown"><h4><span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</span><span class="summary-value">${formatCurrency(matchedSum)} / ${formatCurrency(totalProductionSum)} ‡∏ö‡∏≤‡∏ó</span></h4>`;
                
                const selectedChannels = Array.from(document.querySelectorAll('#match-channel-checkbox-container input:checked')).map(cb => cb.value);
                selectedChannels.sort();
                
                if (selectedChannels.length > 0) {
                    for (const channelName of selectedChannels) {
                        const matchedData = matchedSources[channelName];
                        const icon = matchedData ? `<i class="fa-solid fa-check" style="color: var(--success-color);"></i>` : `<i class="fa-solid fa-times" style="color: var(--danger-color);"></i>`;
                        matchedBreakdownHTML += `<div class="summary-item">
                            <span class="summary-label">${icon} ${channelName}</span>
                            <div class="breakdown-value">
                                <span class="summary-value count-column">${matchedData ? matchedData.count.size : 0} / ${productionItemsBySource[channelName] || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                <span class="summary-value amount-column">${formatCurrency(matchedData ? matchedData.sum : 0)} / ${formatCurrency(productionSumBySource[channelName] || 0)} ‡∏ö‡∏≤‡∏ó</span>
                            </div></div>`;
                    }
                } else {
                    matchedBreakdownHTML += `<div class="summary-item"><span class="summary-label">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span></div>`;
                }
                
                matchedBreakdownHTML += '</div>';
                summaryDashboard.innerHTML = summaryHTML + matchedBreakdownHTML;
                exportMatchedBtn.disabled = matchedCount === 0;
            }

            function exportMatchedDataToXLSX() {
                const table = document.getElementById('statementTable');
                if(!table) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); return; }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.table_to_sheet(table);
                ws['!cols'] = Array.from({ length: 9 }, () => ({ wch: 20 }));
                XLSX.utils.book_append_sheet(wb, ws, "Matched_Statement");
                XLSX.writeFile(wb, "Matched_Statement_Export.xlsx");
            }
            
            // --- === EVENT LISTENERS === ---
            generateBtn.addEventListener('click', generateReport);
            exportXlsxBtn.addEventListener('click', exportReportToXLSX);
            exportPngBtn.addEventListener('click', exportReportToPNG);
            
            csvFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    csvFileNameLabel.textContent = file.name;
                    loadCSV(file);
                } else {
                    csvFileNameLabel.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå";
                    filesReady.csv = false;
                }
                updateMatchButtonState();
            });
            matchBtn.addEventListener('click', matchData);
            exportMatchedBtn.addEventListener('click', exportMatchedDataToXLSX);
            
            function formatCurrency(num) {
                return (num || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            // --- === INITIAL LOAD === ---
            checkAuth();
            loadChannels();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR Kids - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</title>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Library for creating PNG from HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- General Layout Styles --- */
        :root{--sidebar-width:240px;--sidebar-width-collapsed:65px;--top-bar-height:60px;--primary-color:#0071e3;--sidebar-bg:#1d2b3a;--sidebar-link-color:#c5d6de;--sidebar-link-hover-bg:#2a3f54;--sidebar-link-active-bg:#0071e3;--top-bar-bg:#4F634A}*{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background-color:#f4f7f9}.app-container{display:flex;height:100vh}.sidebar{width:var(--sidebar-width);height:100%;position:fixed;z-index:1001;top:0;left:0;background-color:var(--sidebar-bg);transition:width .3s ease, transform .3s ease;color:#fff;padding-top:20px;flex-shrink:0}.page-wrapper{display:flex;flex-direction:column;width:100%;margin-left:var(--sidebar-width);transition:margin-left .3s ease}.top-bar{height:var(--top-bar-height);background-color:var(--top-bar-bg);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-shrink:0;box-shadow:0 2px 5px rgba(0,0,0,.1)}.main-content{flex-grow:1;overflow-y:auto;padding:20px;height:calc(100vh - var(--top-bar-height))}.sidebar .sidebar-header{padding:0 20px 20px;text-align:center;border-bottom:1px solid #3a4b5f;white-space:nowrap}.sidebar .sidebar-header h2{margin:0;font-size:1.6em;font-weight:600}.sidebar nav ul{list-style-type:none;padding:20px 0;margin:0}.sidebar nav li a{display:flex;align-items:center;padding:15px 20px;text-decoration:none;font-size:16px;color:var(--sidebar-link-color);white-space:nowrap;transition:background-color .2s ease-in-out}.sidebar nav li a .icon{margin-right:15px;font-size:1.5em;width:30px;text-align:center}.sidebar nav li a:hover{background-color:var(--sidebar-link-hover-bg)}.sidebar nav li a.active{background-color:var(--sidebar-link-active-bg);color:#fff;font-weight:700}body.sidebar-collapsed .sidebar{width:var(--sidebar-width-collapsed)}body.sidebar-collapsed .page-wrapper{margin-left:var(--sidebar-width-collapsed)}body.sidebar-collapsed .sidebar .sidebar-header h2,body.sidebar-collapsed .sidebar .nav-text{opacity:0;visibility:hidden}body.sidebar-collapsed .sidebar .nav-link .icon{margin-right:0}#user-info-bar{display:flex;align-items:center;gap:15px;font-size:14px}#logout-btn{background-color:#6c757d;color:#fff;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-size:14px}#loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);color:#fff;display:none;justify-content:center;align-items:center;z-index:9999;font-size:2em}
        
        /* --- Accounting Page Specific Styles --- */
        :root { --card-bg: #ffffff; --text-color: #333; --muted-color: #6c757d; --border-color: #dee2e6; --success-color: #28a745; --danger-color: #dc3545; --info-color: #17a2b8; }
        .container { max-width: 1600px; margin: 0 auto; padding: 0; }
        .card { background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        h1, h2 { color: var(--primary-color); text-align: center; }
        .filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; justify-content: center;}
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; margin-bottom: 5px; font-size: 14px; }
        .filter-group input, .filter-group select { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 16px; }
        .filter-group .select2-container { width: 300px !important; }
        .btn { padding: 12px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; color: #fff; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-info { background-color: var(--info-color); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #summary-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .summary-box { background-color: #f8f9fa; padding: 20px; border-radius: 8px; }
        .summary-box h3 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .summary-table { width: 100%; text-align: left; }
        .summary-table th, .summary-table td { padding: 8px 4px; border-bottom: 1px solid var(--border-color); }
        .summary-table tr:last-child td { border-bottom: none; }
        .summary-table .total-row { font-weight: bold; background-color: #e9ecef; }
        .summary-value { font-weight: 700; text-align: right; }
        .overall-summary { text-align: center; }
        .overall-summary .metric { margin-bottom: 15px; }
        .overall-summary .metric h4 { margin: 0 0 5px; color: var(--muted-color); font-size: 16px;}
        .overall-summary .metric .value { font-size: 2.2em; font-weight: 700; color: var(--primary-color); }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; white-space: nowrap; }
        th { background-color: #f8f9fa; }
        td.currency { text-align: right; }
        #loading-message { text-align: center; font-size: 1.2em; color: var(--muted-color); padding: 40px; }

        #mobile-menu-toggle { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        @media (max-width: 768px) {
            .main-content { padding: 10px; } #mobile-menu-toggle { display: block; } .sidebar { transform: translateX(-100%); z-index: 1100; } body:not(.sidebar-collapsed) .sidebar { transform: translateX(0); } .page-wrapper, body.sidebar-collapsed .page-wrapper { margin-left: 0; } .filters { flex-direction: column; align-items: stretch;} .btn { align-self: auto; width: 100%; margin-top: 10px; } .filter-group .select2-container { width: 100% !important; } #summary-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="sidebar-collapsed">
    <div id="loading-overlay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header"> <h2>TR Kids</h2> </div>
            <nav>
                <ul>
                    <li><a href="index.html" class="nav-link"><span class="icon">üìù</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-planner"><span class="icon">üóìÔ∏è</span><span class="nav-text">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (Export)</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-packing"><span class="icon">üì¶</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</span></a></li>
                    <li><a href="#" class="nav-link" id="nav-product"><span class="icon">üè∑Ô∏è</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></a></li>
                    <li><a href="#" class="nav-link active"><span class="icon">üìä</span><span class="nav-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></a></li>
                </ul>
            </nav>
        </div>

        <div class="page-wrapper">
            <header class="top-bar">
                <button id="mobile-menu-toggle">‚ò∞</button>
                <div id="user-info-bar">
                    <span id="welcome-message"></span>
                    <button type="button" id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </header>
            <main class="main-content">
                <div class="container">
                    <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)</h1>

                    <div class="card filters">
                        <div class="filter-group">
                            <label for="start-date">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label>
                            <input type="date" id="start-date">
                        </div>
                        <div class="filter-group">
                            <label for="end-date">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label>
                            <input type="date" id="end-date">
                        </div>
                        <div class="filter-group">
                            <label for="channel-filter">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label>
                            <select id="channel-filter" multiple="multiple"></select>
                        </div>
                        <button id="generate-report-btn" class="btn btn-primary">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                        <button id="export-xlsx-btn" class="btn btn-success" disabled>Export to XLSX</button>
                        <button id="export-png-btn" class="btn btn-info" disabled>Export to PNG</button>
                    </div>

                    <div class="card" id="summary-container">
                         <p id="initial-summary-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</p>
                    </div>

                    <div class="card">
                        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö)</h2>
                        <div id="results-container" class="table-container">
                            <p id="loading-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://scxcuwjhjbkxvqmpywqs.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjeGN1d2poamJreHZxbXB5d3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODM4NTMsImV4cCI6MjA3NDg1OTg1M30.UqcmQUxCkOxgDxjtUa8Sbb0cLHT26qOuHfdbtdilkI8';
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let currentReportData = [];
            let channelMap = {}; 

            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const channelFilterSelect = $('#channel-filter');
            const generateBtn = document.getElementById('generate-report-btn');
            const exportXlsxBtn = document.getElementById('export-xlsx-btn');
            const exportPngBtn = document.getElementById('export-png-btn');
            const resultsContainer = document.getElementById('results-container');
            const summaryContainer = document.getElementById('summary-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const logoutBtn = document.getElementById('logout-btn');

            document.getElementById('mobile-menu-toggle').addEventListener('click', () => document.body.classList.toggle('sidebar-collapsed'));
            logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'index.html';
            });
            
            async function checkAuth() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = 'index.html';
                } else {
                    const { data: userData } = await supabaseClient.from('users').select('username, role').eq('id', session.user.id).single();
                    if (!userData || userData.role !== 'superadmin') {
                        alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
                        window.location.href = 'index.html';
                    } else {
                         document.getElementById('welcome-message').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${userData.username}`;
                    }
                }
            }

            function navigateTo(target) {
                localStorage.setItem('navigateTo', target);
                window.location.href = 'index.html';
            }
            document.getElementById('nav-planner').addEventListener('click', (e) => { e.preventDefault(); navigateTo('planner-system-container'); });
            document.getElementById('nav-packing').addEventListener('click', (e) => { e.preventDefault(); navigateTo('packing-system-container'); });
            document.getElementById('nav-product').addEventListener('click', (e) => { e.preventDefault(); navigateTo('product-system-container'); });

            channelFilterSelect.select2({ placeholder: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", allowClear: true });
            const today = new Date().toISOString().slice(0, 10);
            startDateInput.value = today;
            endDateInput.value = today;

            async function loadChannels() {
                const { data, error } = await supabaseClient.from('channels').select('channel_code, channel_name, bank_account');
                if (error) { console.error('Error loading channels:', error); return; }
                
                channelMap = {};
                data.forEach(ch => {
                    channelMap[ch.channel_code] = { name: ch.channel_name, account: ch.bank_account || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
                    const option = new Option(`${ch.channel_name} (${ch.channel_code})`, ch.channel_code, false, false);
                    channelFilterSelect.append(option);
                });
                channelFilterSelect.trigger('change');
            }

            async function generateReport() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                if (!startDate || !endDate) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }
                
                generateBtn.disabled = true;
                exportXlsxBtn.disabled = true;
                exportPngBtn.disabled = true;
                currentReportData = [];
                resultsContainer.innerHTML = '<p id="loading-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
                summaryContainer.innerHTML = '';

                try {
                    const selectedChannels = channelFilterSelect.val();
                    let query = supabaseClient.from('orders').select('*')
                        .gte('payment_date', startDate)
                        .lte('payment_date', endDate)
                        .not('status', 'eq', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')
                        .not('payment_date', 'is', null);

                    if (selectedChannels && selectedChannels.length > 0) {
                        query = query.in('channel_code', selectedChannels);
                    }
                    
                    const { data: orders, error } = await query.order('payment_date', { ascending: false });
                    if (error) throw error;
                    
                    currentReportData = orders;
                    renderResults(orders);
                    if (orders.length > 0) {
                        exportXlsxBtn.disabled = false;
                        exportPngBtn.disabled = false;
                    }

                } catch (error) {
                    console.error('Error generating report:', error);
                    resultsContainer.innerHTML = `<p style="color:var(--danger-color)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
                } finally {
                    generateBtn.disabled = false;
                }
            }
            
            function renderResults(orders) {
                if (orders.length === 0) {
                    resultsContainer.innerHTML = '<p id="loading-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                    summaryContainer.innerHTML = '<p id="initial-summary-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</p>';
                    return;
                }
                
                // --- Calculations ---
                const totalSales = orders.reduce((sum, order) => sum + (order.total_amount || 0), 0);
                const salesByChannel = {};
                const salesByAccount = {};

                orders.forEach(order => {
                    const channelCode = order.channel_code;
                    const channelInfo = channelMap[channelCode] || { name: channelCode, account: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
                    const amount = order.total_amount || 0;
                    
                    salesByChannel[channelCode] = (salesByChannel[channelCode] || 0) + amount;
                    salesByAccount[channelInfo.account] = (salesByAccount[channelInfo.account] || 0) + amount;
                });
                
                // --- Render On-Screen Summaries ---
                summaryContainer.innerHTML = `
                <div id="summary-section">
                    <div class="summary-box overall-summary"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3> <div class="metric"> <h4>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h4> <div class="value">${totalSales.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div> </div> <div class="metric"> <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h4> <div class="value">${orders.length.toLocaleString('th-TH')}</div> </div> </div>
                    <div class="summary-box"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</h3> <table class="summary-table"> ${Object.entries(salesByChannel).map(([code, total]) => `<tr><td>${channelMap[code]?.name || code} (${code})</td><td class="summary-value">${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td></tr>`).join('')} <tr class="total-row"><td>‡∏£‡∏ß‡∏°</td><td class="summary-value">${totalSales.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td></tr> </table> </div>
                    <div class="summary-box"> <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3> <table class="summary-table"> ${Object.entries(salesByAccount).map(([account, total]) => `<tr><td>${account}</td><td class="summary-value">${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td></tr>`).join('')} <tr class="total-row"><td>‡∏£‡∏ß‡∏°</td><td class="summary-value">${totalSales.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td></tr> </table> </div>
                </div>`;

                // --- Render Raw Data Table ---
                const rawDataTableHeaders = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
                let tableHTML = `<table><thead><tr>${rawDataTableHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                orders.forEach(order => {
                    tableHTML += `<tr>
                        <td>${order.payment_date ? new Date(order.payment_date).toLocaleDateString('th-TH') : ''}</td>
                        <td>${order.payment_time ? order.payment_time.substring(0, 5) : ''}</td>
                        <td>${order.bill_no || ''}</td>
                        <td>${order.channel_code || ''}</td>
                        <td>${order.customer_name || ''}</td>
                        <td class="currency">${(order.total_amount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${order.payment_method || ''}</td>
                        <td>${order.status || ''}</td>
                    </tr>`;
                });
                tableHTML += `</tbody></table>`;
                resultsContainer.innerHTML = tableHTML;
            }

            function exportReportToXLSX() {
                if (currentReportData.length === 0) {
                    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export");
                    return;
                }

                // Headers for all files
                const rawDataHeaders = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", "‡πÄ‡∏ß‡∏•‡∏≤", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞", "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];

                // 1. Group orders by bank account
                const ordersByAccount = {};
                currentReportData.forEach(order => {
                    const channelInfo = channelMap[order.channel_code];
                    const accountName = channelInfo ? channelInfo.account : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (!ordersByAccount[accountName]) {
                        ordersByAccount[accountName] = [];
                    }
                    ordersByAccount[accountName].push(order);
                });

                // 2. Loop through each account and create a separate file
                Object.keys(ordersByAccount).forEach(accountName => {
                    if (ordersByAccount[accountName].length === 0) {
                        return; // Skip if no orders for this account
                    }

                    // Create a new workbook for this account
                    const workbook = XLSX.utils.book_new();

                    // Get data for this account and sort it by channel
                    let accountData = ordersByAccount[accountName];
                    accountData.sort((a, b) => (a.channel_code || '').localeCompare(b.channel_code || ''));

                    // Map data to array format for the worksheet
                    const accountRows = accountData.map(order => [
                        order.payment_date || '',
                        order.payment_time ? order.payment_time.substring(0, 5) : '',
                        order.bill_no || '',
                        order.channel_code || '',
                        order.customer_name || '',
                        order.price || 0,
                        order.shipping_cost || 0,
                        order.discount || 0,
                        order.total_amount || 0,
                        order.payment_method || '',
                        order.promotion || '',
                        order.status || ''
                    ]);

                    // Create the worksheet
                    const worksheet = XLSX.utils.aoa_to_sheet([rawDataHeaders, ...accountRows]);
                    
                    // Sanitize sheet name (it will be the only sheet in the file)
                    const sheetName = accountName.replace(/[\*\:\/\\ \?\[\]]/g, "").substring(0, 31);
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);

                    // 3. Create a unique filename for this account's file
                    // Sanitize account name for the filename by replacing invalid characters with an underscore
                    const sanitizedAccountName = accountName.replace(/[^a-zA-Z0-9-]/g, '_').replace(/_+/g, '_');
                    const fileName = `${sanitizedAccountName}_${startDateInput.value}_to_${endDateInput.value}.xlsx`;

                    // 4. Trigger the download for this specific file
                    XLSX.writeFile(workbook, fileName);
                });

                // Provide feedback to the user that downloads have started
                alert(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${Object.keys(ordersByAccount).length} ‡πÑ‡∏ü‡∏•‡πå... (‡∏´‡∏≤‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ñ‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)`);
            }


            function exportReportToPNG() {
                const summaryElement = document.getElementById('summary-container');
                if (!summaryElement || currentReportData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export"); return; }
                
                loadingOverlay.style.display = 'flex';
                html2canvas(summaryElement, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `SummaryReport_${startDateInput.value}_to_${endDateInput.value}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    loadingOverlay.style.display = 'none';
                }).catch(err => {
                    console.error('Error generating PNG:', err);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PNG');
                    loadingOverlay.style.display = 'none';
                });
            }

            generateBtn.addEventListener('click', generateReport);
            exportXlsxBtn.addEventListener('click', exportReportToXLSX);
            exportPngBtn.addEventListener('click', exportReportToPNG);
            
            // Initial load
            checkAuth();
            loadChannels();
        });
    </script>
</body>
</html>
